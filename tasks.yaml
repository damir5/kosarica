# Generated from: ~/.claude/plans/cryptic-moseying-river.md
# Type-Safe Go Service Client: OpenAPI Migration

tasks:
  # ===========================================================================
  # PHASE 1: Add OpenAPI to Go Service
  # ===========================================================================

  - title: Install swaggo dependencies
    description: |
      Install swaggo/swag for OpenAPI generation in Go service.

      Commands:
      ```bash
      go install github.com/swaggo/swag/cmd/swag@latest
      go get github.com/swaggo/gin-swagger
      go get github.com/swaggo/files
      ```

      This enables annotation-based OpenAPI spec generation from Go handler comments.
    completed: true

  - title: Add swag annotations to handlers (~13 functions)
    description: |
      Annotate all handler functions with swag comments for OpenAPI generation.

      Example for `GetStorePrices`:
      ```go
      // GetStorePrices returns prices for a specific store
      // @Summary Get store prices
      // @Tags prices
      // @Accept json
      // @Produce json
      // @Param chainSlug path string true "Chain slug"
      // @Param storeId path string true "Store ID"
      // @Param limit query int false "Limit" default(100)
      // @Param offset query int false "Offset" default(0)
      // @Success 200 {object} GetStorePricesResponse
      // @Router /internal/prices/{chainSlug}/{storeId} [get]
      func GetStorePrices(c *gin.Context) { ... }
      ```

      Handlers to annotate (~13 total):
      - GetStorePrices, SearchItems
      - ListRuns, GetRun, ListFiles, ListErrors, GetStats
      - TriggerChain, RerunRun, DeleteRun, RerunFile, RerunChunk
      - OptimizeSingle, OptimizeMulti, CacheWarmup, CacheRefresh, CacheHealth

      Each needs: @Summary, @Tags, @Accept, @Produce, @Param (per param), @Success, @Router
    completed: true

  - title: Add main.go annotation for API metadata
    description: |
      Add swag metadata annotation to main.go for API title and base path.

      ```go
      // @title Price Service API
      // @version 1.0
      // @BasePath /internal
      ```

      This defines the OpenAPI spec metadata.
    completed: true

  - title: Generate spec and serve Swagger UI
    description: |
      Wire up swag spec generation and Swagger UI endpoint.

      In main.go or server setup:
      ```go
      import "github.com/swaggo/gin-swagger"
      import swaggerFiles "github.com/swaggo/files"

      router.GET("/docs/*any", ginSwagger.WrapHandler(swaggerFiles.Handler))
      ```

      Add to mise.toml or Makefile:
      ```bash
      swag init -g cmd/server/main.go -o docs
      ```

      The spec will be served at `/docs/doc.json` and UI at `/docs/index.html`.
    completed: false

  - title: Convert swag from global install to go run via mise
    description: |
      Replace global `go install` with `go run` pattern for container compatibility.

      Dev environment runs inside a container where global tool installation
      is not available/persistent. Use `go run` with explicit version instead.

      Add to `mise.toml`:
      ```toml
      [tasks.swag]
      description = "Generate OpenAPI spec from Go annotations"
      dir = "services/price-service"
      run = "go run github.com/swaggo/swag/cmd/swag@latest init -g cmd/server/main.go -o docs"
      ```

      Update first task's instructions to use:
      ```bash
      mise run swag
      ```

      Instead of:
      ```bash
      go install github.com/swaggo/swag/cmd/swag@latest
      swag init -g cmd/server/main.go -o docs
      ```

      Benefits:
      - No global state required
      - Version pinned in mise.toml
      - Works in ephemeral containers
      - Consistent across all dev environments
    completed: false

  # ===========================================================================
  # PHASE 2: Node.js Client Generation
  # ===========================================================================

  - title: Install @hey-api/openapi-ts dependencies
    description: |
      Install the OpenAPI TypeScript client generator and fetch client.

      ```bash
      pnpm add -D @hey-api/openapi-ts
      pnpm add @hey-api/client-fetch
      ```

      This enables automatic SDK + Zod schema generation from OpenAPI spec.
    completed: false

  - title: Configure openapi-ts.config.ts
    description: |
      Create configuration file for @hey-api/openapi-ts.

      File: `openapi-ts.config.ts`
      ```typescript
      import { defineConfig } from '@hey-api/openapi-ts';

      export default defineConfig({
        client: '@hey-api/client-fetch',
        input: 'http://localhost:3003/docs/doc.json',
        output: { path: 'src/lib/go-api', format: 'prettier' },
        plugins: ['@hey-api/schemas', '@hey-api/sdk'],
      });
      ```

      Plugins:
      - @hey-api/schemas: Generates Zod schemas for runtime validation
      - @hey-api/sdk: Generates typed SDK functions for each endpoint
    completed: false

  - title: Add generate script to package.json
    description: |
      Add npm script to generate the Go API client.

      In package.json scripts:
      ```json
      "generate:go-api": "openapi-ts"
      ```

      Also add to mise.toml if using mise for task running.
    completed: false

  # ===========================================================================
  # PHASE 3: Migrate Handlers
  # ===========================================================================

  - title: Migrate oRPC handlers to use generated SDK
    description: |
      Replace manual `goFetchWithRetry` calls in price-service.ts and basket.ts
      with the generated SDK functions.

      Before (manual):
      ```typescript
      const response = await goFetchWithRetry(`/internal/prices/${chainSlug}/${storeId}`);
      return unwrapResponse(response);
      ```

      After (generated SDK):
      ```typescript
      import { getStorePrices } from '@/lib/go-api';
      const { data, error } = await getStorePrices({ path: { chainSlug, storeId } });
      if (error) throw error;
      return data;
      ```

      Files to update:
      - src/orpc/router/price-service.ts (~13 handlers)
      - src/orpc/router/basket.ts (~5 handlers)

      Total: ~18 procedure updates
    completed: false

  # ===========================================================================
  # PHASE 4: Cleanup
  # ===========================================================================

  - title: Delete redundant schema generation files
    description: |
      Remove files that are now replaced by OpenAPI + @hey-api approach.

      Delete:
      - `services/price-service/cmd/schema-gen/` (entire directory)
      - `scripts/generate-schemas.ts`
      - `src/lib/go-schemas/` (entire directory)
      - `src/lib/go-rpc.ts`
      - `shared/schemas/` (entire directory with *.json files)

      These are all replaced by:
      - Go swag annotations → OpenAPI spec
      - @hey-api/openapi-ts → SDK + Zod schemas in src/lib/go-api/
    completed: false

  # ===========================================================================
  # VERIFICATION
  # ===========================================================================

  - title: Verify end-to-end integration
    description: |
      Run verification steps to ensure the migration is complete and working.

      1. `swag init` in Go service - generates OpenAPI spec without errors
      2. Go service serves `/docs/` with Swagger UI accessible
      3. `pnpm generate:go-api` - generates SDK + Zod schemas without errors
      4. `pnpm typecheck` - no TypeScript errors
      5. `mise run test-all` - all 63 tests pass

      Also verify:
      - OpenAPI spec at http://localhost:3003/docs/doc.json is valid
      - Generated files exist in src/lib/go-api/
      - All oRPC handlers work with new SDK
    completed: false

  # ===========================================================================
  # COLLABORATIVE REVIEW
  # ===========================================================================

  - title: "Collaborative Review: OpenAPI Migration"
    description: |
      Multi-model collaborative review with weighted consensus.

      ## Review Process
      Use `/dev:collab reviewer consensus` to review implementation:

      Models (from ~/claude-collab/collaboration.yaml):
      1. github-copilot/gpt-5.2 (weight: 3) - Implementation review
      2. github-copilot/gemini-3-pro-preview (weight: 3) - Architecture review
      3. opencode/grok-code (weight: 1) - Investigation/fact-checking
      4. claude-cli/opus (weight: 4) - Final comprehensive review

      ## Consensus Rules
      - Load weights from ~/claude-collab/collaboration.yaml
      - Model weights: grok=1, gemini-pro=3, gpt-5.2=3, opus=4
      - If models disagree, favor higher-weighted model opinions
      - All critical issues flagged by ANY model must be addressed
      - Document consensus and any dissenting opinions

      ## Review Focus Areas
      - Go swag annotations are complete and accurate
      - OpenAPI spec matches actual handler behavior
      - Generated SDK types are correct
      - Handler migration preserves all functionality
      - No security regressions (auth, validation)
      - Cleanup didn't remove anything still in use
    completed: false
