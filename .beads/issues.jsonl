{"id":"main-073","title":"Verify Kaufland data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.376110018Z","created_by":"kasm-user","updated_at":"2026-01-09T07:29:30.649948846Z","closed_at":"2026-01-09T07:29:30.649948846Z","close_reason":"Closed"}
{"id":"main-0fg","title":"Ingestion: Pending store approval workflow","description":"## Goal\nNew unknown stores created as pending (not active). Existing stores get identifiers added.\n\n## Changes to autoRegisterStore()\n**File**: `src/ingestion/core/persist.ts` (~line 742)\n\nCurrent signature:\n```typescript\nexport async function autoRegisterStore(\n  db: AnyDatabase,\n  chainSlug: string,\n  identifier: string,\n  identifierType: string,\n  options: StoreAutoRegisterOptions,\n): Promise\u003cstring | null\u003e\n```\n\nNew signature:\n```typescript\nexport async function autoRegisterStore(\n  db: AnyDatabase,\n  chainSlug: string,\n  identifier: string,\n  identifierType: string,\n  options: StoreAutoRegisterOptions,\n): Promise\u003c{ storeId: string; status: 'existing' | 'pending' | 'created' } | null\u003e\n```\n\n## New Logic\n1. Try resolve existing store by identifier → return { storeId, status: 'existing' }\n2. If not found, check if physical store exists with same name in chain\n3. If physical match → add identifier to it, return { storeId, status: 'existing' }\n4. If no match → create store with:\n   - `isVirtual=true` (it's import-linked)\n   - `status='pending'` (awaits approval)\n   - Return { storeId, status: 'pending' }\n\n## Special Case: National Stores\nWhen `identifierType === 'national'`:\n- Always set `isVirtual=true`\n- Set `status='active'` (national stores auto-approved)\n\n## Update Callers\nUpdate `persistRowsForStore()` and any other callers to handle new return type.\n\n## Logging\nLog when pending store created:\n```\n[persist] Created pending store: \"Store Name\" (identifier) for chain xyz - awaiting approval\n```\n\n## Verification\n1. Run ingestion for chain with new store file → verify store created with status='pending'\n2. Run ingestion for existing store → verify identifier added, no new store\n3. Run DM ingestion → verify dm_national has is_virtual=1, status='active'","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-09T13:51:11.401510284Z","created_by":"kasm-user","updated_at":"2026-01-09T14:20:04.506611276Z","closed_at":"2026-01-09T14:20:04.506611276Z","close_reason":"Implemented in parallel agents","dependencies":[{"issue_id":"main-0fg","depends_on_id":"main-qsn","type":"blocks","created_at":"2026-01-09T13:52:05.063401539Z","created_by":"kasm-user"}]}
{"id":"main-0fr","title":"CLI: Physical store creation and linking","description":"## Goal\nCommands to add physical stores and link them to virtual stores for pricing.\n\n## File\n**File**: `src/ingestion/cli/stores.ts` (extend existing)\n\n## Commands\n\n### Add physical store\n```bash\npnpm ingest stores --add \\\n  --chain=dm \\\n  --name=\"DM Zagreb Ilica\" \\\n  --address=\"Ilica 123\" \\\n  --city=\"Zagreb\" \\\n  --postal-code=\"10000\" \\\n  --lat=45.815 \\\n  --lng=15.982 \\\n  --price-source=dm_national\n```\n\nCreates store with:\n- `isVirtual=false`\n- `priceSourceStoreId` → resolved from --price-source identifier\n- `status='active'`\n- Location fields populated\n\n### Link existing store to price source\n```bash\npnpm ingest stores --link \u003cstore_id\u003e --price-source=\u003cidentifier\u003e\n```\n- Resolves identifier to store ID\n- Sets priceSourceStoreId on target store\n- Outputs: \"Linked {store} to price source {source}\"\n\n### Import physical stores from CSV\n```bash\npnpm ingest stores --import-csv ./dm_stores.csv --chain=dm --price-source=dm_national\n```\n\nCSV format:\n```csv\nname,address,city,postal_code,lat,lng\nDM Zagreb Ilica,Ilica 123,Zagreb,10000,45.815,15.982\nDM Split Riva,Riva 45,Split,21000,43.508,16.440\n```\n\n- Creates all stores with isVirtual=false\n- All link to specified --price-source\n- Reports: \"Imported X stores, Y errors\"\n\n## Validation\n- --chain required for --add and --import-csv\n- --price-source must resolve to existing virtual store\n- Physical stores require at least name and city\n- Lat/lng optional but recommended\n\n## Verification\n1. Add single physical DM store → verify isVirtual=false, priceSourceStoreId set\n2. Import CSV of 3 stores → verify all created and linked\n3. Query prices for physical store → should use virtual store's prices","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T13:51:40.374415702Z","created_by":"kasm-user","updated_at":"2026-01-09T14:27:07.90945938Z","closed_at":"2026-01-09T14:27:07.90945938Z","close_reason":"Implemented CLI commands for physical store creation and linking","dependencies":[{"issue_id":"main-0fr","depends_on_id":"main-dy8","type":"blocks","created_at":"2026-01-09T13:52:05.166821099Z","created_by":"kasm-user"}]}
{"id":"main-0ri","title":"UI: Add Physical Store modal","description":"Modal for adding physical stores with price source linking\n\n## UI Sketch\n```\n[MODAL: ADD PHYSICAL STORE]\n\n+---------------------------------------------------------------+\n|  Add New Physical Store (Chain: DM)                           |\n+---------------------------------------------------------------+\n|                                                               |\n|  1. Location Details                                          |\n|     Name:    [ DM Zadar Relja       ]                         |\n|     Address: [ Ul. Zrinsko Frankopanska 12 ]                  |\n|     City:    [ Zadar                ]                         |\n|     Geo:     [ 44.1123 ] , [ 15.2231 ]  [Pin on Map]          |\n|                                                               |\n|  2. Pricing Configuration                                     |\n|     How does this store get its prices?                       |\n|                                                               |\n|     ( ) Independent (Has its own import files)                |\n|     (*) Inherited (Uses a Virtual Price Source)               |\n|                                                               |\n|     Select Source:                                            |\n|     [ DM National Pricing (Recommended)   v ]                 |\n|                                                               |\n|  [ CANCEL ]                                   [ SAVE STORE ]  |\n+---------------------------------------------------------------+\n```\n\n## Components\n- StoreAddModal.tsx - Radix Dialog\n- StoreForm.tsx - form fields with validation\n- PriceSourceSelect.tsx - dropdown of virtual stores in chain\n- MapPinButton.tsx - open map picker (optional)\n\n## Files\n- src/components/admin/stores/StoreAddModal.tsx\n- src/components/admin/stores/StoreForm.tsx\n- src/components/admin/stores/PriceSourceSelect.tsx","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T14:33:01.103309137Z","created_by":"kasm-user","updated_at":"2026-01-09T19:01:21.814456232Z","closed_at":"2026-01-09T19:01:21.814456232Z","close_reason":"Implemented all UI components and routes","dependencies":[{"issue_id":"main-0ri","depends_on_id":"main-gmv","type":"parent-child","created_at":"2026-01-09T14:33:39.923351221Z","created_by":"kasm-user"},{"issue_id":"main-0ri","depends_on_id":"main-g7b","type":"blocks","created_at":"2026-01-09T14:33:54.923096759Z","created_by":"kasm-user"}]}
{"id":"main-0u1","title":"Verify Eurospin data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.322811463Z","created_by":"kasm-user","updated_at":"2026-01-09T07:29:30.647408197Z","closed_at":"2026-01-09T07:29:30.647408197Z","close_reason":"Closed"}
{"id":"main-0x8","title":"Phase 8 Testing: Documentation Verification","description":"Testing for Phase 8: Documentation\n\n## Documentation Tests\n\n```\nTEST: Fresh clone to running system\n  GIVEN: Fresh git clone\n  WHEN: Follow README instructions\n  THEN: System runs\n  AND: All tests pass\n\nTEST: Deployment doc works\n  GIVEN: Fresh server\n  WHEN: Follow deployment guide\n  THEN: Production system running\n\nTEST: API docs match implementation\n  GIVEN: Documented endpoint\n  WHEN: Call endpoint per docs\n  THEN: Response matches documented format\n```\n\n## Verification\n\n```bash\n# Clone fresh, follow docs\ngit clone ... \u0026\u0026 cd ... \u0026\u0026 pnpm install \u0026\u0026 pnpm dev\n\n# API docs accurate\n# Compare each endpoint in docs vs actual response\n```\n\n## Files to Verify\n\n- `doc/planning/codebase/ARCHITECTURE.md`\n- `doc/planning/codebase/STRUCTURE.md`\n- `doc/planning/codebase/STACK.md`\n- `doc/planning/API.md`\n- `doc/planning/DEPLOYMENT.md`\n- `services/price-service/README.md`","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-18T12:44:49.338074878Z","created_by":"kasm-user","updated_at":"2026-01-18T12:44:49.338074878Z","labels":["ace:test"],"dependencies":[{"issue_id":"main-0x8","depends_on_id":"main-ugi","type":"blocks","created_at":"2026-01-18T12:45:25.58172603Z","created_by":"kasm-user"}]}
{"id":"main-10m","title":"Phase 1: Port to Postgres","description":"# Phase 1: Port to Postgres\n\nPort the application from SQLite to PostgreSQL, keeping auth tables only for now.\n\n## Tasks\n\n1. Remove SQLite deps (keep TS ingestion as Go reference)\n2. Add postgres-js + Drizzle pg dialect\n3. Schema: only tables needed NOW (auth, user data)\n4. Delete old SQLite migrations\n5. Test: TanStack auth works with Postgres\n\n## Commands\n\n```bash\npnpm remove better-sqlite3 @types/better-sqlite3\npnpm add postgres\n```\n\n## Files to Modify\n\n- `src/db/index.ts` - postgres-js connection\n- `src/db/schema.ts` - convert to pg (auth tables only for now)\n- `src/db/custom-types.ts` - update for pg-core\n- `drizzle.config.ts` - pg dialect\n- `package.json` - deps\n- `.env.example` - DATABASE_URL\n\n## Keep as Reference (delete in Phase 3)\n\n- `src/ingestion/` - reference for Go scrapers\n\n## Verification\n\n- `psql $DATABASE_URL -c \"\\\\dt\"` - tables exist\n- `pnpm dev` - TanStack starts\n- Login/signup works\n\n## Schema (Auth Tables)\n\n```typescript\nexport const users = pgTable('users', {\n  id: varchar('id', { length: 32 }).primaryKey(),\n  email: varchar('email', { length: 256 }).unique().notNull(),\n  name: varchar('name', { length: 128 }),\n  role: varchar('role', { length: 16 }).default('user'),\n  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow(),\n});\n\n// ... sessions, accounts, verification tables for Better Auth\n```","status":"blocked","priority":1,"issue_type":"task","created_at":"2026-01-18T11:23:37.914488411Z","created_by":"kasm-user","updated_at":"2026-01-18T15:30:37.524938629Z","labels":["ace:code","ade:refactor"],"dependencies":[{"issue_id":"main-10m","depends_on_id":"main-qm6","type":"parent-child","created_at":"2026-01-18T11:23:56.871127411Z","created_by":"kasm-user"}]}
{"id":"main-10n","title":"Migration Final Checklist","description":"Final validation checklist before declaring migration complete.\n\n## Critical Tests (Must Pass)\n\n- [ ] Hash determinism validated (1000 runs, same output)\n- [ ] Overlapping history ranges rejected (exclusion constraint)\n- [ ] Largest chain ingestion completes \u003c 2 minutes\n- [ ] SQLite dependencies removed from package.json\n- [ ] All 15 scrapers have sample data tests\n- [ ] E2E tests pass in CI\n- [ ] Documentation matches implementation\n\n## Test Priority Reference\n\n| Priority | Test | Phase | Risk if Skipped |\n|----------|------|-------|-----------------|\n| P0 | Hash determinism \u0026 stability | 4 | Catastrophic group duplication |\n| P0 | Group reuse vs duplication | 4 | Storage explosion |\n| P0 | Historical price correctness | 4 | Wrong prices to users |\n| P1 | Ingestion idempotency | 2 | Data corruption |\n| P1 | Auth flow E2E | 1 | Users can't login |\n| P1 | Node → Go integration | 3 | Frontend broken |\n| P2 | Basket optimization correctness | 5 | Wrong recommendations |\n| P2 | Per-scraper parsing | 2 | Missing/wrong data |\n\n## What NOT to Test (Save Time)\n\n- Internal function call counts\n- Exact SQL queries\n- Goroutine counts\n- Cron implementation details\n- sqlc-generated code structure\n\n## Sign-off\n\nBefore closing migration epic:\n1. All phase testing tasks closed\n2. Global invariants passing in CI\n3. Performance benchmarks met\n4. No P0/P1 issues open","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-18T12:45:14.629958374Z","created_by":"kasm-user","updated_at":"2026-01-18T12:45:14.629958374Z","dependencies":[{"issue_id":"main-10n","depends_on_id":"main-v2f","type":"blocks","created_at":"2026-01-18T12:45:26.589988557Z","created_by":"kasm-user"},{"issue_id":"main-10n","depends_on_id":"main-oji","type":"blocks","created_at":"2026-01-18T12:45:26.639613226Z","created_by":"kasm-user"},{"issue_id":"main-10n","depends_on_id":"main-up6","type":"blocks","created_at":"2026-01-18T12:45:26.690394761Z","created_by":"kasm-user"},{"issue_id":"main-10n","depends_on_id":"main-2q3","type":"blocks","created_at":"2026-01-18T12:45:26.742637483Z","created_by":"kasm-user"},{"issue_id":"main-10n","depends_on_id":"main-6xo","type":"blocks","created_at":"2026-01-18T12:45:26.795522968Z","created_by":"kasm-user"},{"issue_id":"main-10n","depends_on_id":"main-617","type":"blocks","created_at":"2026-01-18T12:45:26.846121303Z","created_by":"kasm-user"},{"issue_id":"main-10n","depends_on_id":"main-1ch","type":"blocks","created_at":"2026-01-18T12:45:26.895599562Z","created_by":"kasm-user"},{"issue_id":"main-10n","depends_on_id":"main-0x8","type":"blocks","created_at":"2026-01-18T12:45:26.950253137Z","created_by":"kasm-user"},{"issue_id":"main-10n","depends_on_id":"main-wo3","type":"blocks","created_at":"2026-01-18T12:45:27.000379742Z","created_by":"kasm-user"}]}
{"id":"main-11x","title":"Update KTC adapter for price transparency fields","description":"Map: Cijena za jedinicu mjere, Najniža cijena u posljednjih 30 dana. Note: no anchor column in sample. Source: https://www.ktc.hr/cjenici","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:15.802272+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.693219+01:00","closed_at":"2026-01-07T19:48:10.205766889Z","dependencies":[{"issue_id":"main-11x","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:37.617339+01:00","created_by":"damir"},{"issue_id":"main-11x","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.398525+01:00","created_by":"damir"}]}
{"id":"main-19a","title":"Update XML parser for price transparency fields","description":"Extend src/ingestion/parsers/xml.ts XmlFieldMapping + item mapping to support CijenaZaJedinicuMjere, NajnizaCijena, SidrenaCijena for Studenac/Trgocentar.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:37.609326+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.697638+01:00","closed_at":"2026-01-07T18:36:30.481364781Z","dependencies":[{"issue_id":"main-19a","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.451074+01:00","created_by":"damir"},{"issue_id":"main-19a","depends_on_id":"main-28t","type":"blocks","created_at":"2026-01-06T14:04:50.217483+01:00","created_by":"damir"}]}
{"id":"main-1ch","title":"Phase 7 Testing: Product Matching","description":"Testing for Phase 7: Product Matching\n\n## Auto Matching Tests\n\n```\nTEST: Same barcode auto-links\n  GIVEN: Retailer items with same barcode across chains\n  WHEN: Matching pipeline runs\n  THEN: product_links created\n  AND: match_type='barcode'\n  AND: confidence=1.0\n\nTEST: No barcode = no auto-match\n  GIVEN: Items without barcodes\n  THEN: Not auto-matched\n  AND: Available for AI/manual matching\n```\n\n## AI Matching Tests\n\n```\nTEST: Similar names suggested\n  GIVEN: \"Mlijeko 1L\" in Chain A\n  AND: \"Svježe mlijeko 1 litra\" in Chain B\n  WHEN: AI matching runs\n  THEN: Match suggested\n  AND: confidence \u003c 1.0\n  AND: Queued for review\n\nTEST: Low confidence = review required\n  GIVEN: AI match with confidence \u003c 0.7\n  THEN: NOT auto-linked\n  AND: Appears in admin review queue\n```\n\n## Manual Review Tests\n\n```\nTEST: Admin can link products\n  GIVEN: Unlinked retailer items\n  WHEN: Admin creates link\n  THEN: product_links row created\n  AND: match_type='manual'\n\nTEST: Admin can unlink products\n  GIVEN: Linked products\n  WHEN: Admin removes link\n  THEN: product_links row deleted\n\nTEST: Search returns unified prices\n  GIVEN: Product P linked to items in 3 chains\n  WHEN: User searches for P\n  THEN: Prices from all 3 chains displayed\n```\n\n## Verification Commands\n\n```bash\n# Products linked\npsql $DATABASE_URL -c \"SELECT product_id, COUNT(*) FROM product_links GROUP BY 1\"\n\n# Search returns multiple chains\ncurl \"/api/products/search?q=mlijeko\"\n```\n\n## Location\n\n- `services/price-service/internal/matching/*_test.go`\n- Admin UI E2E tests","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-18T12:44:48.041196105Z","created_by":"kasm-user","updated_at":"2026-01-18T12:44:48.041196105Z","labels":["ace:test"],"dependencies":[{"issue_id":"main-1ch","depends_on_id":"main-j8s","type":"blocks","created_at":"2026-01-18T12:45:25.512532714Z","created_by":"kasm-user"}]}
{"id":"main-1q1","title":"see c27df4b8f3fbbdba2c4aca246f78aca15d741945 in https://github.com/damir5/nftraffle (with gh) and port table column copying to clipboard here","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T09:16:14.786404813Z","updated_at":"2025-12-31T09:20:56.66265317Z","closed_at":"2025-12-31T09:20:56.66265317Z","close_reason":"Ported table column copying to clipboard from nftraffle. Created CopyableCell component, integrated into UserViewModal and UserTable. Added sonner for toast notifications."}
{"id":"main-1qa","title":"Feature: Store enrichment workflow (geocoding + verification)","description":"AI + human enrichment for stores\n\n## Flow\n1. Store created/imported with address but no lat/lng\n2. Admin clicks \"Geocode Address\" or automatic trigger\n3. Worker calls geocoding API (Google/OpenStreetMap)\n4. Result saved to store_enrichment_tasks with confidence score\n5. If confidence \u003c 0.8, appears in verification queue\n6. Admin reviews: Accept / Reject / Edit coordinates\n7. Verified result applied to store\n\n## Components\n- StoreEnrichmentSection.tsx - in store detail page\n- EnrichmentTaskCard.tsx - show AI suggestion\n- VerifyLocationModal.tsx - accept/reject/edit\n- GeocodingService.ts - API integration\n\n## Files\n- src/ingestion/services/geocoding.ts\n- src/components/admin/stores/StoreEnrichmentSection.tsx\n- src/components/admin/stores/VerifyLocationModal.tsx","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-09T14:33:17.973187011Z","created_by":"kasm-user","updated_at":"2026-01-09T15:15:53.300870175Z","closed_at":"2026-01-09T15:15:53.300870175Z","close_reason":"Implemented store enrichment workflow with geocoding service, frontend UI components, and worker integration","dependencies":[{"issue_id":"main-1qa","depends_on_id":"main-gmv","type":"parent-child","created_at":"2026-01-09T14:33:40.540313317Z","created_by":"kasm-user"},{"issue_id":"main-1qa","depends_on_id":"main-g7b","type":"blocks","created_at":"2026-01-09T14:33:55.558279692Z","created_by":"kasm-user"}]}
{"id":"main-27n","title":"Phase 3: Node.js → Go Integration","description":"# Phase 3: Node.js → Go Integration\n\nConnect Node.js frontend to Go backend via internal REST API.\n\n## Tasks\n\n1. Go: internal REST API (not public)\n2. Node.js: oRPC routes proxy to Go\n3. Auth stays in Node.js\n4. Delete TS ingestion code\n5. Test: frontend fetches prices via Node proxy\n\n## Go Internal API (localhost:8081)\n\n```\nGET  /internal/prices/:chainSlug/:storeId\nGET  /internal/items/search?q=...\nPOST /internal/admin/ingest/:chainSlug\nGET  /internal/health\n```\n\n## Node.js oRPC Proxy\n\n```typescript\n// src/server/api/prices.ts\nexport const pricesRouter = router({\n  getByStore: publicProcedure\n    .input(z.object({ chainSlug: z.string(), storeId: z.number() }))\n    .query(async ({ input }) =\u003e {\n      const res = await fetch(\n        `http://localhost:8081/internal/prices/${input.chainSlug}/${input.storeId}`\n      );\n      return res.json();\n    }),\n});\n```\n\n## Delete\n\n```bash\nrm -rf src/ingestion/\n```\n\n## Verification\n\n- Frontend → Node.js → Go → DB\n- Prices display correctly\n- `src/ingestion/` deleted\n- No direct Go access from browser (internal only)","status":"blocked","priority":1,"issue_type":"task","created_at":"2026-01-18T11:23:36.615309213Z","created_by":"kasm-user","updated_at":"2026-01-18T15:30:40.185980155Z","labels":["ace:code","ade:code"],"dependencies":[{"issue_id":"main-27n","depends_on_id":"main-qm6","type":"parent-child","created_at":"2026-01-18T11:23:54.660157332Z","created_by":"kasm-user"},{"issue_id":"main-27n","depends_on_id":"main-x33","type":"blocks","created_at":"2026-01-18T11:24:26.081934229Z","created_by":"kasm-user"}]}
{"id":"main-28t","title":"Extend NormalizedRow types with price transparency fields","description":"Update src/ingestion/core/types.ts NormalizedRow with optional fields: unitPriceCents, unitPriceBaseQuantity, unitPriceBaseUnit, lowestPrice30dCents, anchorPriceCents, anchorPriceAsOf.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:33.343828+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.698415+01:00","closed_at":"2026-01-07T17:14:04.499258764Z","dependencies":[{"issue_id":"main-28t","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.214309+01:00","created_by":"damir"},{"issue_id":"main-28t","depends_on_id":"main-zrq","type":"blocks","created_at":"2026-01-06T14:04:48.568573+01:00","created_by":"damir"}]}
{"id":"main-2al","title":"Add unique constraints to storeIdentifiers and productLinks tables","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T16:02:49.397566406Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.468320355Z","closed_at":"2026-01-01T16:32:16.468320355Z","close_reason":"Implementation completed by subagents","labels":["database","schema"]}
{"id":"main-2fr","title":"Add database indexes for price queries and common lookups","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T16:03:07.801405648Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.472944223Z","closed_at":"2026-01-01T16:32:16.472944223Z","close_reason":"Implementation completed by subagents","labels":["database","performance"]}
{"id":"main-2q3","title":"Phase 4 Testing: Price Groups (CRITICAL)","description":"Testing for Phase 4: Price Groups - HIGHEST RISK PHASE\n\n## Group Formation Tests\n\n```\nTEST: Stores with identical prices share group\n  GIVEN: Store A and Store B with identical price vectors\n  WHEN: Group detection runs\n  THEN: Both stores point to same price_group_id\n  AND: group_prices contains ONE copy of prices\n\nTEST: One item difference creates new group\n  GIVEN: Store A with prices [item1:100, item2:200]\n  AND: Store B with prices [item1:100, item2:201]  # 1 cent difference\n  WHEN: Group detection runs\n  THEN: Different price_group_ids assigned\n  AND: Different price_hashes in price_groups\n```\n\n## Group Reuse Tests (Critical for Storage)\n\n```\nTEST: Same prices on different days reuse group\n  GIVEN: Day 1 ingestion creates group G1\n  WHEN: Day 2 ingestion has identical prices\n  THEN: Same price_group_id reused\n  AND: price_groups.last_seen_at updated\n  AND: NO new group created\n\nTEST: Conservation of prices\n  GIVEN: Store with 100 items ingested\n  THEN: group_prices has exactly 100 rows for that group\n  AND: No duplicates, no missing items\n```\n\n## Group Change \u0026 History Tests\n\n```\nTEST: Price change moves store to new group\n  GIVEN: Store in group G1 on Day 1\n  WHEN: Price changes on Day 2\n  THEN: New group G2 created (or existing matched)\n  AND: store_group_history shows:\n       - (store, G1, Day1, Day2)\n       - (store, G2, Day2, NULL)\n\nTEST: Historical query returns correct price\n  GIVEN: Store was in G1 on Jan 15, G2 on Jan 20\n  WHEN: Query \"price on Jan 17\"\n  THEN: Returns price from G1\n  WHEN: Query \"price on Jan 25\"\n  THEN: Returns price from G2\n```\n\n## Hash Invariants (Unit Tests in Go) - CRITICAL\n\n```go\nfunc TestHashDeterminism(t *testing.T) {\n    prices := []ItemPrice{{1, 1299, ptr(999)}, {2, 500, nil}}\n\n    // Same input 1000x = same hash\n    hash1 := ComputePriceHash(prices)\n    for i := 0; i \u003c 1000; i++ {\n        assert.Equal(t, hash1, ComputePriceHash(prices))\n    }\n}\n\nfunc TestHashOrderIndependent(t *testing.T) {\n    a := []ItemPrice{{1, 100, nil}, {2, 200, nil}}\n    b := []ItemPrice{{2, 200, nil}, {1, 100, nil}}\n    assert.Equal(t, ComputePriceHash(a), ComputePriceHash(b))\n}\n\nfunc TestHashNullEqualsZero(t *testing.T) {\n    a := []ItemPrice{{1, 100, nil}}\n    b := []ItemPrice{{1, 100, ptr(0)}}\n    assert.Equal(t, ComputePriceHash(a), ComputePriceHash(b))\n}\n\nfunc TestButterflyEffect(t *testing.T) {\n    base := []ItemPrice{{1, 100, nil}, {2, 200, nil}}\n    modified := []ItemPrice{{1, 100, nil}, {2, 201, nil}}  // +1 cent\n    assert.NotEqual(t, ComputePriceHash(base), ComputePriceHash(modified))\n}\n```\n\n## Price Exception Tests\n\n```\nTEST: Exception overrides group price\n  GIVEN: Store in group G1 with item1=100\n  AND: Exception for (store, item1, price=90)\n  WHEN: Query price for item1 at store\n  THEN: Returns 90 (not 100)\n  AND: is_exception=true in response\n\nTEST: Expired exception ignored\n  GIVEN: Exception with expires_at in past\n  WHEN: Query price\n  THEN: Returns group price (not exception)\n\nTEST: Cron job cleans expired exceptions\n  GIVEN: 100 expired exceptions\n  WHEN: Cleanup cron runs\n  THEN: Expired exceptions deleted\n```\n\n## Storage Efficiency Test\n\n```\nTEST: Storage reduced vs naive approach\n  VERIFY: SELECT COUNT(*) FROM group_prices \u003c SELECT COUNT(*) FROM retailer_items\n  TARGET: At least 50% reduction for chains with shared pricing\n```\n\n## Verification Commands\n\n```bash\n# Groups detected\npsql $DATABASE_URL -c \"SELECT COUNT(*) FROM price_groups\"\n\n# Storage reduction\npsql $DATABASE_URL -c \"\nSELECT\n  (SELECT COUNT(*) FROM group_prices) as group_prices,\n  (SELECT COUNT(*) FROM retailer_items) as naive_count\n\"\n\n# Price lookups correct\npsql $DATABASE_URL -c \"\nSELECT gp.price\nFROM store_group_history sgh\nJOIN group_prices gp ON gp.price_group_id = sgh.price_group_id\nWHERE sgh.store_id = 1 AND gp.item_id = 1 AND sgh.valid_to IS NULL\n\"\n```\n\n## Location\n\n- `services/price-service/internal/pricegroups/hash_test.go`\n- `src/__tests__/e2e/prices.test.ts`","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-18T12:44:21.164404148Z","created_by":"kasm-user","updated_at":"2026-01-18T12:44:21.164404148Z","labels":["ace:test"],"dependencies":[{"issue_id":"main-2q3","depends_on_id":"main-f2u","type":"blocks","created_at":"2026-01-18T12:45:25.299195519Z","created_by":"kasm-user"}]}
{"id":"main-2u8","title":"Update XLSX parser for price transparency fields","description":"Extend src/ingestion/parsers/xlsx.ts XlsxColumnMapping + mapping logic to support unitPrice, lowestPrice30d, anchorPrice fields for DM adapter.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:36.452387+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.699074+01:00","closed_at":"2026-01-07T18:36:30.480186775Z","dependencies":[{"issue_id":"main-2u8","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.372832+01:00","created_by":"damir"},{"issue_id":"main-2u8","depends_on_id":"main-28t","type":"blocks","created_at":"2026-01-06T14:04:50.123182+01:00","created_by":"damir"}]}
{"id":"main-375","title":"Add script to sample price variation distributions","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-17T07:14:11.037286+01:00","created_by":"damir","updated_at":"2026-01-17T07:36:01.316766+01:00","closed_at":"2026-01-17T07:36:01.316766+01:00","close_reason":"Completed"}
{"id":"main-3iu","title":"Phase 1: Port to Postgres","description":"Complete PostgreSQL migration from SQLite. All code migrated, auth configured, SQLite scripts removed.","status":"closed","priority":1,"issue_type":"feature","owner":"damir.bijuklic@gmail.com","created_at":"2026-01-19T10:28:39.163645713Z","created_by":"damir","updated_at":"2026-01-19T10:28:45.404079206Z","closed_at":"2026-01-19T10:28:45.404079206Z","close_reason":"Complete PostgreSQL migration from SQLite.\n\nChanges:\n- Migrated from better-sqlite3 to postgres-js driver\n- Updated Drizzle ORM dialect from 'sqlite' to 'postgresql'\n- All schemas converted from sqliteTable to pgTable\n- New migration: drizzle/0000_puzzling_sphinx.sql\n- SQLite migrations archived to drizzle-sqlite-backup/\n\nDeleted SQLite scripts:\n- scripts/setup-dev.ts (used better-sqlite3)\n- scripts/analyze-price-variation.mjs (used sqlite3 CLI)\n\nFixed:\n- src/ingestion/core/persist.ts: Removed SQLITE_BUSY retry logic\n- vitest.config.ts: Removed legacy DATABASE_PATH env var\n\nVerification:\n- Build passes\n- No SQLite-specific code in src/\n- Auth configured with provider: 'pg'"}
{"id":"main-3vl","title":"Update Eurospin adapter for price transparency fields","description":"Map: CIJENA_ZA_JEDINICU_MJERE, NAJNIŽA_MPC_U_30DANA, SIDRENA_CIJENA, plus POSEB.OBLIK_PROD__ZA_JEDINICU_MJERE for special sale unit price. Source: https://www.eurospin.hr/cjenik/","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:59.323181+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.699695+01:00","closed_at":"2026-01-07T19:48:10.204459009Z","dependencies":[{"issue_id":"main-3vl","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:35.597929+01:00","created_by":"damir"},{"issue_id":"main-3vl","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.24898+01:00","created_by":"damir"}]}
{"id":"main-4cn","title":"Add price transparency columns to store_item_state schema","description":"Update src/db/schema.ts store_item_state table with: unit_price, unit_price_base_quantity, unit_price_base_unit, lowest_price_30d, anchor_price, anchor_price_as_of. Optional: add to store_item_price_periods but exclude from price signature to avoid churn.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T14:03:30.548267+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.700332+01:00","closed_at":"2026-01-07T16:49:44.983259423Z","dependencies":[{"issue_id":"main-4cn","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.05294+01:00","created_by":"damir"}]}
{"id":"main-4fu","title":"Verify Studenac data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.481252333Z","created_by":"kasm-user","updated_at":"2026-01-09T08:09:57.349643026Z","closed_at":"2026-01-09T08:09:57.349643026Z","close_reason":"Verified: Metro (13,092 rows, 0 errors), Studenac (2 rows, 0 errors)"}
{"id":"main-4mn","title":"Price Tracking DB Schema \u0026 Ingestion Pipeline","description":"Add grocery price tracking with chains, stores, retailer items, and prices. Pipeline runnable from CLI and Cloudflare Workers with Queue fanout. Covers 11 retail chains with CSV/XML/XLSX parsing.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-29T19:43:40.877298+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.954281+01:00","closed_at":"2025-12-30T15:36:50.104998569Z"}
{"id":"main-4mn.1","title":"Add price tracking tables to schema.ts","description":"Add 14 new tables to src/db/schema.ts:\n- Retail World: chains, stores, store_identifiers, retailer_items, retailer_item_barcodes\n- Canonical Catalog: products, product_aliases, product_links, product_relations\n- Prices: store_item_state, store_item_price_periods\n- Ingestion: ingestion_runs, ingestion_files, ingestion_file_entries, ingestion_errors\n\nKey features:\n- chains: text PK slug (konzum, lidl, etc.)\n- store_identifiers: handle filename codes, portal IDs\n- retailer_item_barcodes: many-to-one for Lidl case\n- store_item_state: price_signature for dedup\n- store_item_price_periods: history only on change","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T19:44:02.541685+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.956337+01:00","closed_at":"2025-12-30T11:31:42.309531329Z","labels":["phase1","schema"],"dependencies":[{"issue_id":"main-4mn.1","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:02.54488+01:00","created_by":"daemon"},{"issue_id":"main-4mn.1","depends_on_id":"main-4mn.34","type":"blocks","created_at":"2025-12-29T19:48:20.860347+01:00","created_by":"daemon"}]}
{"id":"main-4mn.10","title":"Create XLSX parser","description":"Create src/ingestion/parsers/xlsx.ts:\n- Use xlsx library\n- Handle DM national file format\n- Map columns to NormalizedRow","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:03.129997+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.957179+01:00","closed_at":"2025-12-30T14:26:04.343217332Z","labels":["parsers","phase3"],"dependencies":[{"issue_id":"main-4mn.10","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:03.132137+01:00","created_by":"daemon"},{"issue_id":"main-4mn.10","depends_on_id":"main-4mn.7","type":"blocks","created_at":"2025-12-29T19:48:01.295495+01:00","created_by":"daemon"}]}
{"id":"main-4mn.11","title":"Create chain adapter registry","description":"Create src/ingestion/chains/index.ts:\n- Registry mapping chain_id → adapter\n- Chain config (URLs, formats, delimiters)\n- getAdapter(chain_id) function","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:28.501618+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.957979+01:00","closed_at":"2025-12-30T14:21:12.591187838Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.11","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:28.503709+01:00","created_by":"daemon"},{"issue_id":"main-4mn.11","depends_on_id":"main-4mn.3","type":"blocks","created_at":"2025-12-29T19:48:03.147307+01:00","created_by":"daemon"},{"issue_id":"main-4mn.11","depends_on_id":"main-4mn.7","type":"blocks","created_at":"2025-12-29T19:48:03.182901+01:00","created_by":"daemon"}]}
{"id":"main-4mn.12","title":"Implement Konzum chain adapter","description":"Create src/ingestion/chains/konzum.ts:\n- Format: CSV, delimiter: comma\n- Store resolution: filename (address + store ID)\n- Column mapping specific to Konzum format","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:29.343418+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.958693+01:00","closed_at":"2025-12-30T14:30:52.222403391Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.12","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:29.345437+01:00","created_by":"daemon"},{"issue_id":"main-4mn.12","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.388851+01:00","created_by":"daemon"}]}
{"id":"main-4mn.13","title":"Implement Lidl chain adapter","description":"Create src/ingestion/chains/lidl.ts:\n- Format: CSV, delimiter: comma\n- Store resolution: filename (daily ZIP → fanout)\n- Handle multiple GTINs per SKU\n- Column mapping specific to Lidl format","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:31.90735+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.959607+01:00","closed_at":"2025-12-30T14:36:33.779692922Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.13","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:31.909688+01:00","created_by":"daemon"},{"issue_id":"main-4mn.13","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.430367+01:00","created_by":"daemon"}]}
{"id":"main-4mn.14","title":"Implement Plodine chain adapter","description":"Create src/ingestion/chains/plodine.ts:\n- Format: CSV, delimiter: semicolon\n- Store resolution: filename\n- Handle ,69 decimal format (missing leading zero)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:32.78086+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.96026+01:00","closed_at":"2025-12-30T14:40:53.885056662Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.14","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:32.783305+01:00","created_by":"daemon"},{"issue_id":"main-4mn.14","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.467815+01:00","created_by":"daemon"}]}
{"id":"main-4mn.15","title":"Implement Interspar chain adapter","description":"Create src/ingestion/chains/interspar.ts:\n- Format: CSV, delimiter: semicolon\n- Store resolution: filename","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:34.198416+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.960982+01:00","closed_at":"2025-12-30T14:46:20.091500256Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.15","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:34.201028+01:00","created_by":"daemon"},{"issue_id":"main-4mn.15","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.502637+01:00","created_by":"daemon"}]}
{"id":"main-4mn.16","title":"Implement Studenac chain adapter","description":"Create src/ingestion/chains/studenac.ts:\n- Format: XML\n- Store resolution: XML content (store block inside)\n- Parse store info from within XML structure","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:35.136978+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.961648+01:00","closed_at":"2025-12-30T14:50:36.192536706Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.16","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:35.139865+01:00","created_by":"daemon"},{"issue_id":"main-4mn.16","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.536656+01:00","created_by":"daemon"}]}
{"id":"main-4mn.17","title":"Implement Kaufland chain adapter","description":"Create src/ingestion/chains/kaufland.ts:\n- Format: CSV, delimiter: tab\n- Store resolution: filename","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:47.687201+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.962293+01:00","closed_at":"2025-12-30T14:54:44.521161494Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.17","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:47.689059+01:00","created_by":"daemon"},{"issue_id":"main-4mn.17","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.571112+01:00","created_by":"daemon"}]}
{"id":"main-4mn.18","title":"Implement Eurospin chain adapter","description":"Create src/ingestion/chains/eurospin.ts:\n- Format: CSV, delimiter: semicolon\n- Store resolution: filename","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:49.052502+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.962922+01:00","closed_at":"2025-12-30T15:00:37.146431965Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.18","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:49.054628+01:00","created_by":"daemon"},{"issue_id":"main-4mn.18","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.60454+01:00","created_by":"daemon"}]}
{"id":"main-4mn.19","title":"Implement DM chain adapter","description":"Create src/ingestion/chains/dm.ts:\n- Format: XLSX\n- Store resolution: single national file (all stores)\n- Parse Excel structure","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:50.30759+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.963565+01:00","closed_at":"2025-12-30T15:00:37.154120155Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.19","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:50.30982+01:00","created_by":"daemon"},{"issue_id":"main-4mn.19","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.639809+01:00","created_by":"daemon"}]}
{"id":"main-4mn.2","title":"Generate Drizzle migration for price tracking","description":"Run drizzle-kit generate to create migration for the new price tracking tables.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T19:44:03.982069+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.964196+01:00","closed_at":"2025-12-30T12:02:34.076178986Z","labels":["phase1","schema"],"dependencies":[{"issue_id":"main-4mn.2","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:03.985166+01:00","created_by":"daemon"},{"issue_id":"main-4mn.2","depends_on_id":"main-4mn.1","type":"blocks","created_at":"2025-12-29T19:47:47.748724+01:00","created_by":"daemon"}]}
{"id":"main-4mn.20","title":"Implement KTC chain adapter","description":"Create src/ingestion/chains/ktc.ts:\n- Format: CSV, delimiter: semicolon\n- Store resolution: filename","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:51.350841+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.964859+01:00","closed_at":"2025-12-30T15:00:37.155974107Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.20","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:51.353314+01:00","created_by":"daemon"},{"issue_id":"main-4mn.20","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.674216+01:00","created_by":"daemon"}]}
{"id":"main-4mn.21","title":"Implement Metro chain adapter","description":"Create src/ingestion/chains/metro.ts:\n- Format: CSV, delimiter: comma\n- Store resolution: filename","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:52.52463+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.965518+01:00","closed_at":"2025-12-30T15:00:37.157571388Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.21","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:52.526794+01:00","created_by":"daemon"},{"issue_id":"main-4mn.21","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.70854+01:00","created_by":"daemon"}]}
{"id":"main-4mn.22","title":"Implement Trgocentar chain adapter","description":"Create src/ingestion/chains/trgocentar.ts:\n- Format: XML\n- Store resolution: filename + XML\n- Parse XML structure","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:54.365347+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.96616+01:00","closed_at":"2025-12-30T15:00:37.159138376Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.22","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:54.367923+01:00","created_by":"daemon"},{"issue_id":"main-4mn.22","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.743861+01:00","created_by":"daemon"}]}
{"id":"main-4mn.23","title":"Create discover CLI command","description":"Create src/ingestion/cli/discover.ts:\n- List artifacts for chain+date\n- Usage: npx tsx src/ingestion/cli/discover.ts -c konzum -d 2025-12-29\n- Return URLs or paths of available files","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:19.177629+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.966797+01:00","closed_at":"2025-12-30T15:08:13.970096594Z","labels":["cli","phase5"],"dependencies":[{"issue_id":"main-4mn.23","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:19.17971+01:00","created_by":"daemon"},{"issue_id":"main-4mn.23","depends_on_id":"main-4mn.6","type":"blocks","created_at":"2025-12-29T19:48:15.256344+01:00","created_by":"daemon"},{"issue_id":"main-4mn.23","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:15.291579+01:00","created_by":"daemon"}]}
{"id":"main-4mn.24","title":"Create fetch CLI command","description":"Create src/ingestion/cli/fetch.ts:\n- Download + record ingestion_files\n- Usage: npx tsx src/ingestion/cli/fetch.ts -c konzum -u \u003curl_or_path\u003e\n- Store to R2/FS, compute SHA256","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:20.295853+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.967446+01:00","closed_at":"2025-12-30T15:08:13.991374439Z","labels":["cli","phase5"],"dependencies":[{"issue_id":"main-4mn.24","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:20.298066+01:00","created_by":"daemon"},{"issue_id":"main-4mn.24","depends_on_id":"main-4mn.6","type":"blocks","created_at":"2025-12-29T19:48:15.325642+01:00","created_by":"daemon"},{"issue_id":"main-4mn.24","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:15.359249+01:00","created_by":"daemon"}]}
{"id":"main-4mn.25","title":"Create expand CLI command","description":"Create src/ingestion/cli/expand.ts:\n- ZIP → entries\n- Usage: npx tsx src/ingestion/cli/expand.ts -f ingestion_file_id\n- Record ingestion_file_entries","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:21.302574+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.968119+01:00","closed_at":"2025-12-30T15:08:13.994040743Z","labels":["cli","phase5"],"dependencies":[{"issue_id":"main-4mn.25","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:21.305192+01:00","created_by":"daemon"},{"issue_id":"main-4mn.25","depends_on_id":"main-4mn.6","type":"blocks","created_at":"2025-12-29T19:48:15.393621+01:00","created_by":"daemon"},{"issue_id":"main-4mn.25","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:15.428546+01:00","created_by":"daemon"}]}
{"id":"main-4mn.26","title":"Create parse CLI command","description":"Create src/ingestion/cli/parse.ts:\n- Parse one file/entry\n- Usage: npx tsx src/ingestion/cli/parse.ts -c konzum -f \u003cpath\u003e\n- Use appropriate parser (CSV/XML/XLSX)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:22.700953+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.968777+01:00","closed_at":"2025-12-30T15:08:13.996537837Z","labels":["cli","phase5"],"dependencies":[{"issue_id":"main-4mn.26","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:22.703375+01:00","created_by":"daemon"},{"issue_id":"main-4mn.26","depends_on_id":"main-4mn.6","type":"blocks","created_at":"2025-12-29T19:48:15.462037+01:00","created_by":"daemon"},{"issue_id":"main-4mn.26","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:15.495373+01:00","created_by":"daemon"}]}
{"id":"main-4mn.27","title":"Create run CLI command (end-to-end)","description":"Create src/ingestion/cli/run.ts:\n- End-to-end for chain/date\n- Usage: npx tsx src/ingestion/cli/run.ts -c konzum -d 2025-12-29 [--store \u003cstore_id\u003e]\n- Support --dry-run flag\n- Orchestrate discover → fetch → expand → parse → persist","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:24.87748+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.969426+01:00","closed_at":"2025-12-30T15:08:13.998622972Z","labels":["cli","phase5"],"dependencies":[{"issue_id":"main-4mn.27","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:24.880002+01:00","created_by":"daemon"},{"issue_id":"main-4mn.27","depends_on_id":"main-4mn.6","type":"blocks","created_at":"2025-12-29T19:48:15.52855+01:00","created_by":"daemon"},{"issue_id":"main-4mn.27","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:15.561245+01:00","created_by":"daemon"}]}
{"id":"main-4mn.28","title":"Test each chain with sample data","description":"Test each chain adapter with sample data from ../data/sample/:\n- Verify parsing of all 11 chains\n- Check column mapping correctness\n- Validate NormalizedRow output","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:45.95908+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.970043+01:00","closed_at":"2025-12-30T15:22:10.670378951Z","labels":["phase6","testing"],"dependencies":[{"issue_id":"main-4mn.28","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:45.962074+01:00","created_by":"daemon"},{"issue_id":"main-4mn.28","depends_on_id":"main-4mn.27","type":"blocks","created_at":"2025-12-29T19:48:16.934603+01:00","created_by":"daemon"}]}
{"id":"main-4mn.29","title":"Verify price signature deduplication","description":"Test price_signature dedup logic:\n- Run same data twice\n- Verify no duplicate price_periods created\n- Verify last_seen_ts updated on second run\n- Verify new period created only on actual change","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:47.576289+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.970958+01:00","closed_at":"2025-12-30T15:22:10.680333156Z","labels":["phase6","testing"],"dependencies":[{"issue_id":"main-4mn.29","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:47.578468+01:00","created_by":"daemon"},{"issue_id":"main-4mn.29","depends_on_id":"main-4mn.27","type":"blocks","created_at":"2025-12-29T19:48:16.96941+01:00","created_by":"daemon"}]}
{"id":"main-4mn.3","title":"Create ingestion core types","description":"Create src/ingestion/core/types.ts with shared interfaces:\n- NormalizedRow: parsed row with prices, barcodes, quantities\n- StoreDescriptor: resolved store info\n- ChainAdapter interface\n- QueueMessage types for Cloudflare","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:28.391652+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.971749+01:00","closed_at":"2025-12-30T12:05:40.753171105Z","labels":["core","phase2"],"dependencies":[{"issue_id":"main-4mn.3","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:28.393798+01:00","created_by":"daemon"},{"issue_id":"main-4mn.3","depends_on_id":"main-4mn.1","type":"blocks","created_at":"2025-12-29T19:47:50.078824+01:00","created_by":"daemon"}]}
{"id":"main-4mn.30","title":"Verify store resolution","description":"Test store resolution strategy:\n- Filename-first resolution\n- Registry lookup fallback\n- Unresolved fallback with store_identifiers(kind='unresolved')\n- Test across different chain formats","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:48.93219+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.972409+01:00","closed_at":"2025-12-30T15:22:10.682119508Z","labels":["phase6","testing"],"dependencies":[{"issue_id":"main-4mn.30","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:48.934658+01:00","created_by":"daemon"},{"issue_id":"main-4mn.30","depends_on_id":"main-4mn.27","type":"blocks","created_at":"2025-12-29T19:48:17.003823+01:00","created_by":"daemon"}]}
{"id":"main-4mn.31","title":"Create Cloudflare Worker for ingestion","description":"Create src/ingestion/worker.ts:\n- Queue consumer for parse_entry messages\n- Cron scheduled handler for discover+fetch\n- Handle QueueMessage types:\n  - expand_zip: run_id, file_id\n  - parse_entry: run_id, entry_id, chain_id\n- Batch parse + persist","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:47:14.32944+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.973043+01:00","closed_at":"2025-12-30T15:22:10.683669571Z","labels":["cloudflare","phase7"],"dependencies":[{"issue_id":"main-4mn.31","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:47:14.332271+01:00","created_by":"daemon"},{"issue_id":"main-4mn.31","depends_on_id":"main-4mn.6","type":"blocks","created_at":"2025-12-29T19:48:17.979169+01:00","created_by":"daemon"},{"issue_id":"main-4mn.31","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:18.013409+01:00","created_by":"daemon"}]}
{"id":"main-4mn.32","title":"Update wrangler.jsonc for Queue and R2","description":"Update wrangler.jsonc:\n- Add queue producer: INGESTION_QUEUE → price-ingestion\n- Add queue consumer: max_batch_size: 10, max_retries: 3\n- Add R2 bucket: DATA_BUCKET → kosarica-data\n- Configure cron triggers","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:47:16.607282+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.973679+01:00","closed_at":"2025-12-30T15:36:31.7439163Z","labels":["cloudflare","phase7"],"dependencies":[{"issue_id":"main-4mn.32","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:47:16.609488+01:00","created_by":"daemon"},{"issue_id":"main-4mn.32","depends_on_id":"main-4mn.31","type":"blocks","created_at":"2025-12-29T19:48:18.048271+01:00","created_by":"daemon"}]}
{"id":"main-4mn.33","title":"Test ZIP fanout with Queue","description":"Test Cloudflare Queue fanout:\n- ZIP with multiple entries\n- Verify entries enqueued as parse_entry messages\n- Verify parallel processing\n- Check backpressure and retry behavior","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:47:17.826935+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.974288+01:00","closed_at":"2025-12-30T15:36:31.748570839Z","labels":["cloudflare","phase7"],"dependencies":[{"issue_id":"main-4mn.33","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:47:17.829296+01:00","created_by":"daemon"},{"issue_id":"main-4mn.33","depends_on_id":"main-4mn.31","type":"blocks","created_at":"2025-12-29T19:48:18.082775+01:00","created_by":"daemon"}]}
{"id":"main-4mn.34","title":"Add npm dependencies for ingestion","description":"Update package.json with new dependencies:\n- fast-xml-parser (XML parsing)\n- xlsx (XLSX parsing)\n- adm-zip (ZIP extraction)\n- iconv-lite (encoding conversion)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T19:47:26.014527+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.974877+01:00","closed_at":"2025-12-30T11:15:38.020455527Z","labels":["phase1","setup"],"dependencies":[{"issue_id":"main-4mn.34","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:47:26.017634+01:00","created_by":"daemon"}]}
{"id":"main-4mn.4","title":"Create storage abstraction","description":"Create src/ingestion/core/storage.ts:\n- Abstraction over local FS and Cloudflare R2\n- Store/retrieve files by key\n- Compute SHA256 for dedup","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:29.826339+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.975466+01:00","closed_at":"2025-12-30T13:32:06.465553487Z","labels":["core","phase2"],"dependencies":[{"issue_id":"main-4mn.4","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:29.829083+01:00","created_by":"daemon"},{"issue_id":"main-4mn.4","depends_on_id":"main-4mn.1","type":"blocks","created_at":"2025-12-29T19:47:50.126383+01:00","created_by":"daemon"}]}
{"id":"main-4mn.5","title":"Create normalization utilities","description":"Create src/ingestion/core/normalize.ts:\n- Decimal styles: 3,69 → 3.69, ,69 → 0.69\n- Quantity formats: '315 G' → {value: 315, unit: 'G'}\n- Pack notation: '6x500ml' → {pack_count: 6, pack_unit_value: 500, pack_unit_unit: 'ML'}\n- Barcode cleanup: remove spaces, quotes, Excel quoting","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:31.003811+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.976058+01:00","closed_at":"2025-12-30T13:36:42.944104901Z","labels":["core","phase2"],"dependencies":[{"issue_id":"main-4mn.5","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:31.006331+01:00","created_by":"daemon"},{"issue_id":"main-4mn.5","depends_on_id":"main-4mn.1","type":"blocks","created_at":"2025-12-29T19:47:50.165985+01:00","created_by":"daemon"}]}
{"id":"main-4mn.6","title":"Create persist module with signature dedup","description":"Create src/ingestion/core/persist.ts:\n- Upsert stores, retailer_items, retailer_item_barcodes\n- Compute price_signature hash\n- If signature unchanged: update last_seen_ts only\n- If signature changed: close old period, open new period\n- Insert to store_item_price_periods only on change","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:32.544076+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.976638+01:00","closed_at":"2025-12-30T13:44:07.709663089Z","labels":["core","phase2"],"dependencies":[{"issue_id":"main-4mn.6","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:32.547218+01:00","created_by":"daemon"},{"issue_id":"main-4mn.6","depends_on_id":"main-4mn.1","type":"blocks","created_at":"2025-12-29T19:47:50.201372+01:00","created_by":"daemon"},{"issue_id":"main-4mn.6","depends_on_id":"main-4mn.3","type":"blocks","created_at":"2025-12-29T19:47:51.708077+01:00","created_by":"daemon"}]}
{"id":"main-4mn.7","title":"Create base parser interface","description":"Create src/ingestion/parsers/base.ts:\n- Abstract Parser class/interface\n- parse(content: Buffer, options: ParseOptions) → NormalizedRow[]\n- Common error handling","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:56.55452+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.977168+01:00","closed_at":"2025-12-30T13:48:18.9336486Z","labels":["parsers","phase3"],"dependencies":[{"issue_id":"main-4mn.7","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:56.557012+01:00","created_by":"daemon"},{"issue_id":"main-4mn.7","depends_on_id":"main-4mn.3","type":"blocks","created_at":"2025-12-29T19:48:01.184795+01:00","created_by":"daemon"}]}
{"id":"main-4mn.8","title":"Create CSV parser","description":"Create src/ingestion/parsers/csv.ts:\n- Configurable delimiter (comma, semicolon, tab)\n- Handle different encodings (utf-8, windows-1250)\n- Return NormalizedRow[]","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:58.042047+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.977659+01:00","closed_at":"2025-12-30T14:03:35.954062838Z","labels":["parsers","phase3"],"dependencies":[{"issue_id":"main-4mn.8","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:58.044236+01:00","created_by":"daemon"},{"issue_id":"main-4mn.8","depends_on_id":"main-4mn.7","type":"blocks","created_at":"2025-12-29T19:48:01.225085+01:00","created_by":"daemon"}]}
{"id":"main-4mn.9","title":"Create XML parser","description":"Create src/ingestion/parsers/xml.ts:\n- Use fast-xml-parser\n- Handle Studenac/Trgocentar XML formats\n- Extract store blocks from XML content","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:58.983067+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.978133+01:00","closed_at":"2025-12-30T14:10:10.211549429Z","labels":["parsers","phase3"],"dependencies":[{"issue_id":"main-4mn.9","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:58.985332+01:00","created_by":"daemon"},{"issue_id":"main-4mn.9","depends_on_id":"main-4mn.7","type":"blocks","created_at":"2025-12-29T19:48:01.262345+01:00","created_by":"daemon"}]}
{"id":"main-4vu","title":"Test Infrastructure Setup","description":"Set up testing infrastructure for migration project.\n\n## Required Test Libraries\n\n### Node.js (existing + additions)\n\n```json\n{\n  \"vitest\": \"^3.2.4\",\n  \"@testing-library/react\": \"^16.3.1\",\n  \"playwright\": \"^1.57.0\"\n}\n```\n\n### Go (new)\n\n```go\n// go.mod additions\nrequire (\n    github.com/stretchr/testify v1.9.0\n    github.com/pashagolub/pgxmock/v4 v4.0.0\n)\n```\n\n## Test Organization\n\n```\nkosarica/\n├── src/\n│   └── __tests__/\n│       └── e2e/\n│           ├── auth.test.ts       # Phase 1\n│           ├── prices.test.ts     # Phase 3, 4\n│           └── basket.test.ts     # Phase 5\n├── services/price-service/\n│   └── internal/\n│       ├── pricegroups/\n│       │   └── hash_test.go       # Phase 4 (critical)\n│       ├── scrapers/\n│       │   └── *_test.go          # Phase 2 (per-scraper)\n│       └── optimizer/\n│           └── engine_test.go     # Phase 5\n└── tests/\n    └── integration/\n        └── invariants.test.ts     # Global invariants\n```\n\n## CI Pipeline (GitHub Actions)\n\n```yaml\n# .github/workflows/test.yml\nname: Tests\non: [push, pull_request]\n\njobs:\n  test-node:\n    runs-on: ubuntu-latest\n    services:\n      postgres:\n        image: postgres:16\n        env:\n          POSTGRES_PASSWORD: test\n        options: \u003e-\n          --health-cmd pg_isready\n          --health-interval 10s\n    steps:\n      - uses: actions/checkout@v4\n      - uses: pnpm/action-setup@v3\n      - run: pnpm install\n      - run: pnpm test\n      - run: pnpm run test:e2e\n\n  test-go:\n    runs-on: ubuntu-latest\n    services:\n      postgres:\n        image: postgres:16\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-go@v5\n        with:\n          go-version: '1.23'\n      - run: cd services/price-service \u0026\u0026 go test ./...\n```\n\n## Playwright Configuration\n\nConfigure Playwright for E2E tests (currently installed but not configured).\n\n## Tasks\n\n- [ ] Create `tests/integration/invariants.test.ts`\n- [ ] Create `.github/workflows/test.yml`\n- [ ] Configure Playwright with `playwright.config.ts`\n- [ ] Add Go test dependencies to go.mod\n- [ ] Create test directories structure\n- [ ] Add sample data for Go scraper tests","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-18T12:45:13.463868855Z","created_by":"kasm-user","updated_at":"2026-01-18T12:45:13.463868855Z","labels":["ace:test"],"dependencies":[{"issue_id":"main-4vu","depends_on_id":"main-qm6","type":"blocks","created_at":"2026-01-18T12:45:26.534733217Z","created_by":"kasm-user"}]}
{"id":"main-4we","title":"Wrap persistRows in database transaction for atomicity","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T16:02:58.591061325Z","created_by":"kasm-user","updated_at":"2026-01-01T16:45:26.757355793Z","closed_at":"2026-01-01T16:45:26.757355793Z","close_reason":"Cannot implement: Cloudflare D1 does not support multi-statement transactions. Wrapping persistRows in a transaction would only work for BetterSQLite3 (CLI) but not for D1 (production), creating an environment inconsistency.","labels":["database","reliability"]}
{"id":"main-617","title":"Phase 6 Testing: Store Enrichment UI","description":"Testing for Phase 6: Store Enrichment UI\n\n## Workflow Tests\n\n```\nTEST: New store appears in admin\n  GIVEN: Ingestion discovers new store\n  WHEN: Admin views pending stores\n  THEN: Store listed with status='pending'\n\nTEST: Approve makes store visible\n  GIVEN: Pending store\n  WHEN: Admin approves store\n  THEN: status='approved'\n  AND: approvedAt set\n  AND: Store appears in user-facing queries\n\nTEST: Reject removes store from queue\n  GIVEN: Pending store\n  WHEN: Admin rejects store\n  THEN: status='rejected'\n  AND: Store NOT in pending list\n  AND: Store NOT visible to users\n```\n\n## Permission Tests\n\n```\nTEST: Non-admin cannot approve\n  GIVEN: Regular user logged in\n  WHEN: Attempt to approve store\n  THEN: 403 Forbidden\n\nTEST: Admin actions audited\n  GIVEN: Admin approves store\n  THEN: updatedAt reflects action time\n  AND: (Optional) Audit log entry created\n```\n\n## Verification\n\n```bash\n# Pending stores visible in admin\n# Manual: Login as admin, view /admin/stores\n\n# Approve flow\n# Manual: Click approve, verify store appears in public\n```\n\n## Location\n\n- E2E tests in Playwright\n- Manual testing checklist","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-18T12:44:47.867644258Z","created_by":"kasm-user","updated_at":"2026-01-18T12:44:47.867644258Z","labels":["ace:test"],"dependencies":[{"issue_id":"main-617","depends_on_id":"main-bqm","type":"blocks","created_at":"2026-01-18T12:45:25.436176378Z","created_by":"kasm-user"}]}
{"id":"main-67u","title":"Schema: Add ingestion_chunks + store_enrichment_tasks tables","description":"Add new tables and modify existing:\n\n## New Tables\n\n### ingestion_chunks\n- id, file_id, chunk_index, start_row, end_row, row_count\n- status (pending|processing|completed|failed)\n- r2_key for chunk JSON location\n- persisted_count, error_count\n\n### store_enrichment_tasks\n- id, store_id, type (geocode|verify_address|ai_categorize)\n- status, input_data, output_data, confidence\n- verified_by, verified_at\n\n## Modify Existing\n- ingestion_files: add total_chunks, processed_chunks, chunk_size\n- ingestion_runs: add parent_run_id, rerun_type, rerun_target_id\n- ingestion_errors: add chunk_id FK","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-09T14:32:30.659786226Z","created_by":"kasm-user","updated_at":"2026-01-09T14:44:11.075268122Z","closed_at":"2026-01-09T14:44:11.075268122Z","close_reason":"Implemented schema changes: ingestion_chunks, store_enrichment_tasks tables, and modifications to ingestion_files, ingestion_runs, ingestion_errors. Migration 0008_thin_the_leader.sql generated.","dependencies":[{"issue_id":"main-67u","depends_on_id":"main-gmv","type":"parent-child","created_at":"2026-01-09T14:33:35.047075011Z","created_by":"kasm-user"}]}
{"id":"main-6ta","title":"Update Kaufland adapter for price transparency fields","description":"Map: cijena jed.mj.(EUR), Najniža MPC u 30dana, Sidrena cijena. Also map unitPriceBaseQuantity from kol.jed.mj. and unitPriceBaseUnit from jed.mj. (1 KOM/L/KG). Source: https://www.kaufland.hr/akcije-novosti/popis-mpc.html","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:13.649972+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.70121+01:00","closed_at":"2026-01-07T19:48:10.20510347Z","dependencies":[{"issue_id":"main-6ta","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:35.674319+01:00","created_by":"damir"},{"issue_id":"main-6ta","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.325156+01:00","created_by":"damir"}]}
{"id":"main-6xo","title":"Phase 5 Testing: Basket Optimization","description":"Testing for Phase 5: Basket Optimization\n\n## Single-Store Optimization Tests\n\n```\nTEST: Returns cheapest store for basket\n  GIVEN: Basket with items [A, B, C]\n  AND: Store1 total=100, Store2 total=90, Store3 total=110\n  WHEN: Optimize single-store\n  THEN: Returns Store2\n  AND: Total = 90\n\nTEST: Handles missing items\n  GIVEN: Basket with item X\n  AND: Store1 has X, Store2 doesn't have X\n  WHEN: Optimize\n  THEN: Store1 eligible, Store2 NOT eligible\n```\n\n## Multi-Store Optimization Tests\n\n```\nTEST: Splits basket across stores\n  GIVEN: Basket [A, B]\n  AND: Store1: A=10, B=100\n  AND: Store2: A=100, B=10\n  WHEN: Optimize multi-store (max_stores=2)\n  THEN: Returns split: Store1 for A, Store2 for B\n  AND: Total = 20 (not 110 single-store)\n\nTEST: Respects max_stores constraint\n  GIVEN: Optimal split requires 5 stores\n  AND: max_stores=3\n  WHEN: Optimize\n  THEN: Uses at most 3 stores\n  AND: Returns best possible with constraint\n```\n\n## Stability Tests\n\n```\nTEST: Same inputs = same outputs\n  GIVEN: Fixed basket and prices\n  WHEN: Optimize called 10 times\n  THEN: All results identical\n\nTEST: Cache refresh doesn't change valid results\n  GIVEN: Cached prices\n  WHEN: Cache refreshed (no price changes)\n  THEN: Optimization results unchanged\n```\n\n## Edge Case Tests\n\n```\nTEST: Empty basket returns empty result\nTEST: Single-item basket returns single store\nTEST: All stores missing item returns error\nTEST: Location-based filtering works\n```\n\n## Verification Commands\n\n```bash\n# Single-store optimization\ncurl -X POST localhost:8081/internal/optimize/single \\\n  -d '{\"basket_items\":[{\"product_id\":1,\"quantity\":2}], \"location\":{\"lat\":45.8, \"lon\":16.0}}'\n\n# Multi-store optimization\ncurl -X POST localhost:8081/internal/optimize/multi \\\n  -d '{\"basket_items\":[...], \"max_stores\":3}'\n```\n\n## Location\n\n- `services/price-service/internal/optimizer/engine_test.go`\n- `src/__tests__/e2e/basket.test.ts`","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-18T12:44:22.786994008Z","created_by":"kasm-user","updated_at":"2026-01-18T12:44:22.786994008Z","labels":["ace:test"],"dependencies":[{"issue_id":"main-6xo","depends_on_id":"main-c8l","type":"blocks","created_at":"2026-01-18T12:45:25.365144601Z","created_by":"kasm-user"}]}
{"id":"main-7ie","title":"Update Interspar adapter for price transparency fields","description":"Map: cijena za jedinicu mjere (EUR), Najniža cijena u posljednjih 30 dana (EUR), sidrena cijena na 2.5.2025. (EUR). Set anchorPriceAsOf=2025-05-02. Source: https://www.spar.hr/usluge/cjenici","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:58.214057+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.701802+01:00","closed_at":"2026-01-07T19:48:10.203760173Z","dependencies":[{"issue_id":"main-7ie","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:35.522916+01:00","created_by":"damir"},{"issue_id":"main-7ie","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.175998+01:00","created_by":"damir"}]}
{"id":"main-951","title":"explore removeing BetterSQLite3 and using vitest/wrangler settup for testing, not node https://developers.cloudflare.com/workers/development-testing/ https://developers.cloudflare.com/workers/vite-plugin/","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T16:31:36.87966588Z","updated_at":"2026-01-06T14:03:03.721412+01:00","closed_at":"2026-01-06T14:03:03.721412+01:00","close_reason":"Implemented in commit a5b684a - removed BetterSQLite3, migrated to Cloudflare vitest-pool-workers testing"}
{"id":"main-acl","title":"Use chunked parsing for large files to prevent CPU timeout","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-16T16:19:13.039086+01:00","created_by":"damir","updated_at":"2026-01-16T16:30:32.030973+01:00","closed_at":"2026-01-16T16:30:32.030973+01:00","close_reason":"Changed handleFetch and handleExpand to use parse_chunked instead of parse, with chunkSize of 1000 rows. All 274 tests pass."}
{"id":"main-b3i","title":"UI: Ingestion Dashboard","description":"Create /_admin/admin/ingestion route with drill-down\n\n## Features\n- Stats cards: runs today, files processed, errors, rows ingested\n- Run list with status badges and progress bars\n- Click run -\u003e files list\n- Click file -\u003e chunks list\n- Re-run buttons at each level\n- Error categorization view\n\n## Routes\n- /_admin/admin/ingestion - dashboard + run list\n- /_admin/admin/ingestion/$runId - run detail with files\n- /_admin/admin/ingestion/$runId/$fileId - file detail with chunks\n\n## Components\n- IngestionStatsCards.tsx - metrics overview\n- IngestionRunList.tsx - table of runs\n- IngestionRunCard.tsx - run with progress bar\n- IngestionFileList.tsx - files in a run\n- IngestionChunkList.tsx - chunks in a file\n- IngestionErrorList.tsx - errors with filters\n- RerunButton.tsx - trigger re-run\n- ProgressBar.tsx - visual progress\n\n## Files\n- src/routes/_admin.admin.ingestion.tsx\n- src/routes/_admin.admin.ingestion.$runId.tsx\n- src/routes/_admin.admin.ingestion.$runId.$fileId.tsx\n- src/components/admin/ingestion/*.tsx","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T14:33:04.967391989Z","created_by":"kasm-user","updated_at":"2026-01-09T19:01:21.817388582Z","closed_at":"2026-01-09T19:01:21.817388582Z","close_reason":"Implemented all UI components and routes","dependencies":[{"issue_id":"main-b3i","depends_on_id":"main-gmv","type":"parent-child","created_at":"2026-01-09T14:33:40.335719107Z","created_by":"kasm-user"},{"issue_id":"main-b3i","depends_on_id":"main-tvx","type":"blocks","created_at":"2026-01-09T14:33:55.349627013Z","created_by":"kasm-user"}]}
{"id":"main-b4a","title":"UI: Pending Store Approval page","description":"Create /_admin/admin/stores/pending route\n\n## UI Sketch\n```\n[PAGE: EXCEPTIONS \u003e PENDING STORES]\n\n+-----------------------------------------------------------------------------------+\n|  PENDING STORES (Action Required)                                                 |\n+-----------------------------------------------------------------------------------+\n|                                                                                   |\n|  [1] New Store Detected: \"DM_Summer_Promo\"                                        |\n|      Source File: dm_summer_prices.csv                                            |\n|      Detected Chain: DM                                                           |\n|                                                                                   |\n|  [ DECISION REQUIRED ]                                                            |\n|                                                                                   |\n|  Option A: [ APPROVE AS NEW PRICE SOURCE ]                                        |\n|  \"This is a distinct set of prices (e.g. specific region or web-only).\"           |\n|  -\u003e Creates Virtual Store \"DM_Summer_Promo\"                                       |\n|                                                                                   |\n|  Option B: [ MERGE INTO EXISTING SOURCE ]                                         |\n|  \"This file actually belongs to an existing price list.\"                          |\n|  -\u003e Map to: [ DM National Pricing v ]                                             |\n|                                                                                   |\n|  Option C: [ REJECT \u0026 BLOCK ]                                                     |\n|  \"This is garbage data.\"                                                          |\n|                                                                                   |\n+-----------------------------------------------------------------------------------+\n```\n\n## Components\n- PendingStoreInbox.tsx - list of pending stores\n- PendingStoreCard.tsx - card with 3 action buttons\n- StoreApprovalModal.tsx - confirm approve\n- StoreMergeModal.tsx - select target store\n- StoreRejectModal.tsx - confirm delete\n\n## Files\n- src/routes/_admin.admin.stores.pending.tsx\n- src/components/admin/stores/PendingStoreCard.tsx\n- src/components/admin/stores/StoreApprovalModal.tsx\n- src/components/admin/stores/StoreMergeModal.tsx","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T14:33:03.894279523Z","created_by":"kasm-user","updated_at":"2026-01-09T19:01:21.816432577Z","closed_at":"2026-01-09T19:01:21.816432577Z","close_reason":"Implemented all UI components and routes","dependencies":[{"issue_id":"main-b4a","depends_on_id":"main-gmv","type":"parent-child","created_at":"2026-01-09T14:33:40.128895142Z","created_by":"kasm-user"},{"issue_id":"main-b4a","depends_on_id":"main-g7b","type":"blocks","created_at":"2026-01-09T14:33:55.140201916Z","created_by":"kasm-user"}]}
{"id":"main-bqm","title":"Phase 6: Store Enrichment UI","description":"# Phase 6: Store Enrichment UI\n\nAdmin UI for managing pending stores discovered by scrapers.\n\n## Tasks\n\n1. Admin UI for pending stores\n2. Human approval workflow\n3. Go marks approved stores\n4. Test: new store → approve → active\n\n## Node.js/Frontend\n\n- Admin page listing pending stores\n- Form to enrich: address, lat/lon, city\n- Approve/reject actions\n\n## Go Endpoint\n\n```\nPATCH /internal/stores/:id/approve\n```\n\n- Updates status to 'approved'\n- Sets approvedAt timestamp\n\n## Store Status Flow\n\n```\ndiscovered by scraper → status='pending'\n                              ↓\n                    admin reviews in UI\n                              ↓\n                      approve/reject\n                              ↓\n                    status='approved' → visible to users\n```\n\n## Verification\n\n- New store from ingestion → appears in admin\n- Approve → visible to users\n- Rejected stores not shown to users","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-18T11:23:34.02243841Z","created_by":"kasm-user","updated_at":"2026-01-18T15:47:55.825107363Z","closed_at":"2026-01-18T15:47:55.825107363Z","close_reason":"Closed","labels":["ace:code"],"dependencies":[{"issue_id":"main-bqm","depends_on_id":"main-qm6","type":"parent-child","created_at":"2026-01-18T11:23:52.759041458Z","created_by":"kasm-user"},{"issue_id":"main-bqm","depends_on_id":"main-27n","type":"blocks","created_at":"2026-01-18T11:24:26.221282542Z","created_by":"kasm-user"}]}
{"id":"main-c46","title":"Verify Metro data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.430028489Z","created_by":"kasm-user","updated_at":"2026-01-09T08:09:57.346828705Z","closed_at":"2026-01-09T08:09:57.346828705Z","close_reason":"Verified: Metro (13,092 rows, 0 errors), Studenac (2 rows, 0 errors)"}
{"id":"main-c8l","title":"Phase 5: Basket Optimization","description":"# Phase 5: Basket Optimization\n\nImplement basket optimization algorithms in Go.\n\n## Tasks\n\n1. In-memory price cache\n2. Single/multi-store algorithms\n3. API via Node.js proxy\n4. Test: basket optimization works\n\n## Go Service Additions\n\n- In-memory price cache (refresh on ingestion)\n- Single-store optimizer\n- Multi-store optimizer (greedy/optimal)\n\n## API Endpoints\n\n```\nPOST /internal/optimize/single  {basket_items, location}\nPOST /internal/optimize/multi   {basket_items, location, max_stores}\n```\n\n## Go Structure\n\n```\nservices/price-service/internal/optimizer/\n├── engine.go\n├── cache.go\n└── multi.go\n```\n\n## Verification\n\n- Optimize basket returns cheapest store\n- Multi-store returns valid split\n- `POST /api/basket/optimize` works via Node proxy","status":"blocked","priority":2,"issue_type":"task","created_at":"2026-01-18T11:23:34.794047356Z","created_by":"kasm-user","updated_at":"2026-01-18T15:30:45.529052208Z","labels":["ace:code","ade:code"],"dependencies":[{"issue_id":"main-c8l","depends_on_id":"main-qm6","type":"parent-child","created_at":"2026-01-18T11:23:53.550275212Z","created_by":"kasm-user"},{"issue_id":"main-c8l","depends_on_id":"main-f2u","type":"blocks","created_at":"2026-01-18T11:24:26.170210491Z","created_by":"kasm-user"}]}
{"id":"main-c8x","title":"Update DM adapter for price transparency fields","description":"Map XLSX headers: Cijena za jedinicu mjere, Najniža cijena u posljednjih 30 dana prije rasprodaje, sidrena cijena na 2.5.2025. ili na datum ulistanja. Set anchorPriceAsOf=null due to ambiguous basis. Source: https://www.dm.hr/novo/promocije/nove-oznake-cijena-i-vazeci-cjenik-u-dm-u-2906632","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:21.355188+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.702413+01:00","closed_at":"2026-01-07T19:48:10.209244568Z","dependencies":[{"issue_id":"main-c8x","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:37.931888+01:00","created_by":"damir"},{"issue_id":"main-c8x","depends_on_id":"main-2u8","type":"blocks","created_at":"2026-01-06T14:05:01.589393+01:00","created_by":"damir"}]}
{"id":"main-ce0","title":"Verify chunked parsing works for XML files","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-16T16:19:43.961732+01:00","created_by":"damir","updated_at":"2026-01-16T16:19:43.961732+01:00","dependencies":[{"issue_id":"main-ce0","depends_on_id":"main-acl","type":"blocks","created_at":"2026-01-16T16:20:07.742582+01:00","created_by":"damir"}]}
{"id":"main-ceq","title":"Fix unsafe non-null assertion on config.csv in chain adapters","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-01T16:02:35.278840052Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.460524921Z","closed_at":"2026-01-01T16:32:16.460524921Z","close_reason":"Implementation completed by subagents","labels":["bug"]}
{"id":"main-dy8","title":"CLI: Store management commands","description":"## Goal\nCLI commands to list, approve, reject pending stores.\n\n## New File\n**File**: `src/ingestion/cli/stores.ts`\n\n## Commands\n\n### List pending stores\n```bash\npnpm ingest stores --pending\n```\nOutput table:\n| ID | Chain | Name | Identifiers | Created |\n|----|-------|------|-------------|---------|\n\n### List all stores for chain\n```bash\npnpm ingest stores --chain=dm\n```\nOutput table:\n| ID | Name | Virtual | Status | Price Source | City |\n|----|------|---------|--------|--------------|------|\n\n### Approve store\n```bash\npnpm ingest stores --approve \u003cstore_id\u003e\n```\n- Sets status='active'\n- Outputs: \"Approved store: {name}\"\n\n### Reject/delete store\n```bash\npnpm ingest stores --reject \u003cstore_id\u003e\n```\n- Deletes store, store_identifiers, and any storeItemState records\n- Outputs: \"Rejected and deleted store: {name}\"\n\n### Show store details\n```bash\npnpm ingest stores --show \u003cstore_id\u003e\n```\n- Shows all store fields + identifiers + price count\n\n## Register Command\n**File**: `src/ingestion/cli/index.ts`\n\nAdd stores subcommand to CLI.\n\n## Implementation Notes\n- Use drizzle queries\n- Use console.table or similar for formatted output\n- Handle errors gracefully (store not found, etc.)\n\n## Verification\n1. Create pending store via ingestion\n2. `pnpm ingest stores --pending` → shows it\n3. `pnpm ingest stores --approve \u003cid\u003e` → status changes\n4. `pnpm ingest stores --chain=dm` → shows all DM stores","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T13:51:25.409990684Z","created_by":"kasm-user","updated_at":"2026-01-09T14:20:04.509052251Z","closed_at":"2026-01-09T14:20:04.509052251Z","close_reason":"Implemented in parallel agents","dependencies":[{"issue_id":"main-dy8","depends_on_id":"main-qsn","type":"blocks","created_at":"2026-01-09T13:52:05.119706152Z","created_by":"kasm-user"}]}
{"id":"main-e72","title":"Update Metro adapter for price transparency fields","description":"Map: CIJENA_PO_MJERI, NAJNIZA_30_DANA, SIDRENA_02_05. Note: current adapter is XML-only but sample is CSV - needs alignment. Set anchorPriceAsOf=2025-05-02. Source: https://metrocjenik.com.hr/","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:17.7726+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.703027+01:00","closed_at":"2026-01-07T19:48:10.207112394Z","dependencies":[{"issue_id":"main-e72","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:37.692227+01:00","created_by":"damir"},{"issue_id":"main-e72","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.46656+01:00","created_by":"damir"}]}
{"id":"main-edl","title":"Query: Price resolution follows priceSourceStoreId","description":"## Goal\nWhen querying prices for a physical store, follow priceSourceStoreId to get prices from virtual store.\n\n## New File\n**File**: `src/db/queries/stores.ts` (or add to existing queries file)\n\n## Helper Functions\n\n### Get effective price store ID\n```typescript\n/**\n * Returns the store ID to use for price lookups.\n * Physical stores return their priceSourceStoreId.\n * Virtual stores return their own ID.\n */\nexport function getEffectivePriceStoreId(store: { \n  id: string; \n  priceSourceStoreId: string | null \n}): string {\n  return store.priceSourceStoreId ?? store.id\n}\n```\n\n### Get store with resolved price source\n```typescript\n/**\n * Fetches store and its price source store (if different).\n */\nexport async function getStoreWithPriceSource(\n  db: AnyDatabase,\n  storeId: string\n): Promise\u003c{\n  store: Store;\n  priceStore: Store;\n  usesSharedPricing: boolean;\n} | null\u003e {\n  const store = await db.query.stores.findFirst({\n    where: eq(stores.id, storeId)\n  })\n  if (\\!store) return null\n\n  if (store.priceSourceStoreId) {\n    const priceStore = await db.query.stores.findFirst({\n      where: eq(stores.id, store.priceSourceStoreId)\n    })\n    return { \n      store, \n      priceStore: priceStore\\!, \n      usesSharedPricing: true \n    }\n  }\n\n  return { store, priceStore: store, usesSharedPricing: false }\n}\n```\n\n### Get prices for store (convenience)\n```typescript\n/**\n * Gets prices for a store, following priceSourceStoreId if set.\n */\nexport async function getPricesForStore(\n  db: AnyDatabase,\n  storeId: string,\n  options?: { limit?: number; retailerItemId?: string }\n): Promise\u003cStoreItemState[]\u003e {\n  const resolved = await getStoreWithPriceSource(db, storeId)\n  if (\\!resolved) return []\n\n  return db.query.storeItemState.findMany({\n    where: and(\n      eq(storeItemState.storeId, resolved.priceStore.id),\n      options?.retailerItemId \n        ? eq(storeItemState.retailerItemId, options.retailerItemId) \n        : undefined\n    ),\n    limit: options?.limit\n  })\n}\n```\n\n## Usage Pattern\nWhen building price API:\n```typescript\n// DON'T query directly with user's storeId\nconst prices = await db.query.storeItemState.findMany({\n  where: eq(storeItemState.storeId, requestedStoreId) // WRONG for physical stores\n})\n\n// DO use the helper\nconst prices = await getPricesForStore(db, requestedStoreId)\n```\n\n## Export\nAdd exports to `src/db/index.ts` or appropriate barrel file.\n\n## Verification\n1. Create virtual store with prices\n2. Create physical store linked to virtual\n3. Call `getPricesForStore(db, physicalStoreId)`\n4. Verify returns virtual store's prices","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T13:51:55.881949682Z","created_by":"kasm-user","updated_at":"2026-01-09T14:20:04.510073924Z","closed_at":"2026-01-09T14:20:04.510073924Z","close_reason":"Implemented in parallel agents","dependencies":[{"issue_id":"main-edl","depends_on_id":"main-qsn","type":"blocks","created_at":"2026-01-09T13:52:05.213817839Z","created_by":"kasm-user"}]}
{"id":"main-f24","title":"UI: Store Registry page","description":"Create /_admin/admin/stores route\n\n## UI Sketch\n```\n[PAGE: STORES \u0026 CHAINS]\n\n+-----------------------------------------------------------------------------------+\n|  Filter: [Chain: DM  v]  [Status: Active v]  [Type: All v]                        |\n+-----------------------------------------------------------------------------------+\n|                                                                                   |\n|  [ VIRTUAL PRICE SOURCES (Import Linked) ]                                        |\n|  These stores are created automatically by your ingestion pipeline.               |\n|                                                                                   |\n|  Name (Identifier)       | Status   | Last Import | Linked Physical Stores        |\n|  ------------------------|----------|-------------|-------------------------------|\n|  DM National Pricing     | ACTIVE   | 2h ago      | 142 Locations (Inheriting)    |\n|  DM Online Only          | ACTIVE   | 1d ago      | 0 Locations                   |\n|                                                                                   |\n|  -------------------------------------------------------------------------------  |\n|                                                                                   |\n|  [ PHYSICAL LOCATIONS ]                                                           |\n|  Real-world addresses. They inherit prices from a source or have their own.       |\n|  [+ Add Physical Location]                                                        |\n|                                                                                   |\n|  Store Name              | City     | Price Source          | Action              |\n|  ------------------------|----------|-----------------------|---------------------|\n|  DM Zadar - Supernova    | Zadar    | DM National Pricing   | [Edit] [Unlink]     |\n|  DM Zagreb - Ilica       | Zagreb   | DM National Pricing   | [Edit] [Unlink]     |\n|  DM Split - Centar       | Split    | NONE (No Prices)      | [Link Source]       |\n|                                                                                   |\n+-----------------------------------------------------------------------------------+\n```\n\n## Components\n- StoreTable.tsx - TanStack Table with virtual/physical sections\n- StoreFilters.tsx - chain, status, type dropdowns\n- VirtualStoreCard.tsx - show linked count badge\n\n## Files\n- src/routes/_admin.admin.stores.tsx\n- src/components/admin/stores/StoreTable.tsx\n- src/components/admin/stores/StoreFilters.tsx","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T14:33:00.080289253Z","created_by":"kasm-user","updated_at":"2026-01-09T15:32:52.003787138Z","closed_at":"2026-01-09T15:32:52.003787138Z","close_reason":"Implemented Store Registry page with two-section layout (Virtual Price Sources + Physical Locations), link/unlink modals, and enhanced API endpoints","dependencies":[{"issue_id":"main-f24","depends_on_id":"main-gmv","type":"parent-child","created_at":"2026-01-09T14:33:39.718735136Z","created_by":"kasm-user"},{"issue_id":"main-f24","depends_on_id":"main-g7b","type":"blocks","created_at":"2026-01-09T14:33:54.710404154Z","created_by":"kasm-user"}]}
{"id":"main-f2u","title":"Phase 4: Price Groups (Go only)","description":"# Phase 4: Price Groups (Go only)\n\nImplement price group detection and storage for storage reduction.\n\n## Tasks\n\n1. Detection algorithm\n2. Group-level price storage\n3. Exception handling\n4. Test: storage reduced, prices correct\n\n## Tables to Add (Drizzle)\n\n- price_groups, group_prices, store_group_history, store_price_exceptions, item_price_stats\n\n## Key Design: Groups are IMMUTABLE\n\n- Same hash = same group reused\n- Groups identified by (chain_id, price_hash)\n- Hash version column for future changes\n\n## Price Hash Specification (CRITICAL)\n\nOne bug in hash = catastrophic group duplication.\n\n```go\n// services/price-service/internal/pricegroups/hash.go\n\nconst HashVersion = 1\n\nfunc ComputePriceHash(prices []ItemPrice) string {\n    // 1. Sort by item_id (ascending)\n    sort.Slice(prices, func(i, j int) bool {\n        return prices[i].ItemID \u003c prices[j].ItemID\n    })\n\n    // 2. Build canonical string: \"item_id:price:discount\\n\"\n    var buf bytes.Buffer\n    for _, p := range prices {\n        discount := p.DiscountPrice\n        if discount == nil {\n            discount = ptr(0)  // NULL → 0\n        }\n        fmt.Fprintf(\u0026buf, \"%d:%d:%d\\n\", p.ItemID, p.Price, *discount)\n    }\n\n    // 3. SHA256, hex-encoded\n    hash := sha256.Sum256(buf.Bytes())\n    return hex.EncodeToString(hash[:])\n}\n```\n\n## Hash Rules\n\n1. Sort by item_id - deterministic order\n2. NULL discount → 0 - not omitted, explicit zero\n3. Exclude anchor_price, unit_price - don't define price equality\n4. Integer cents only - no floats\n5. One implementation - all scrapers call this function\n6. Version column - if algorithm changes, bump hash_version\n\n## Detection Algorithm\n\n1. After ingestion, hash prices per store\n2. Group stores with identical hashes\n3. Compare to previous groups\n4. Store prices at group level\n5. Handle exceptions (store-specific promos)\n\n## Schema\n\n```typescript\nexport const priceGroups = pgTable('price_groups', {\n  id: serial('id').primaryKey(),\n  chainId: smallint('chain_id').notNull().references(() =\u003e chains.id),\n  priceHash: varchar('price_hash', { length: 64 }).notNull(),\n  hashVersion: smallint('hash_version').notNull().default(1),\n  storeCount: smallint('store_count').default(0),\n  itemCount: integer('item_count').default(0),\n  firstSeenAt: timestamp('first_seen_at', { withTimezone: true }).defaultNow(),\n  lastSeenAt: timestamp('last_seen_at', { withTimezone: true }).defaultNow(),\n}, (table) =\u003e ({\n  uniqChainHash: uniqueIndex('price_groups_chain_hash_idx')\n    .on(table.chainId, table.priceHash, table.hashVersion),\n}));\n\nexport const storeGroupHistory = pgTable('store_group_history', {\n  id: bigserial('id', { mode: 'number' }).primaryKey(),\n  storeId: integer('store_id').notNull().references(() =\u003e stores.id),\n  priceGroupId: integer('price_group_id').notNull().references(() =\u003e priceGroups.id),\n  validFrom: timestamp('valid_from', { withTimezone: true }).notNull(),\n  validTo: timestamp('valid_to', { withTimezone: true }),  // NULL = current\n}, ...);\n```\n\n## Raw SQL Required\n\n```sql\n-- Exclusion constraint (no overlapping ranges)\nALTER TABLE store_group_history\nADD CONSTRAINT store_group_no_overlap\nEXCLUDE USING gist (\n  store_id WITH =,\n  tstzrange(valid_from, coalesce(valid_to, 'infinity')) WITH \u0026\u0026\n);\n\n-- Partial unique index: only one current membership per store\nCREATE UNIQUE INDEX store_group_current_uniq\nON store_group_history (store_id)\nWHERE valid_to IS NULL;\n```\n\n## Verification\n\n- Price groups detected after ingestion\n- `SELECT COUNT(*) FROM group_prices` \u003c `SELECT COUNT(*) FROM retailer_items`\n- Price lookups return correct values","status":"blocked","priority":1,"issue_type":"task","created_at":"2026-01-18T11:23:39.789273431Z","created_by":"kasm-user","updated_at":"2026-01-18T15:28:03.313497057Z","labels":["ace:code","ade:code"],"dependencies":[{"issue_id":"main-f2u","depends_on_id":"main-27n","type":"blocks","created_at":"2026-01-18T11:24:44.811757637Z","created_by":"kasm-user"},{"issue_id":"main-f2u","depends_on_id":"main-qm6","type":"parent-child","created_at":"2026-01-18T11:27:06.723327719Z","created_by":"kasm-user"}]}
{"id":"main-fgy","title":"Croatian Price Transparency Fields Import","description":"Persist Croatian price-transparency fields that retailers publish: unit price, lowest price in last 30 days, and anchor (sidrena) price. New fields: unitPriceCents, unitPriceBaseQuantity, unitPriceBaseUnit, lowestPrice30dCents, anchorPriceCents, anchorPriceAsOf. Covers all 11 retail chains.","status":"closed","priority":1,"issue_type":"epic","assignee":"damir","created_at":"2026-01-06T14:03:09.235155+01:00","created_by":"damir","updated_at":"2026-01-07T16:53:41.251704+01:00","closed_at":"2026-01-07T16:53:41.251704+01:00","close_reason":"Merged to main at a82e00b8"}
{"id":"main-fmf","title":"Update Studenac adapter for price transparency fields","description":"Map XML tags: \u003cCijenaZaJedinicuMjere\u003e, \u003cNajnizaCijena\u003e, \u003cSidrenaCijena\u003e. Source: https://www.studenac.hr/popis-maloprodajnih-cijena","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:19.042893+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.703821+01:00","closed_at":"2026-01-07T19:48:10.207895688Z","dependencies":[{"issue_id":"main-fmf","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:37.771851+01:00","created_by":"damir"},{"issue_id":"main-fmf","depends_on_id":"main-19a","type":"blocks","created_at":"2026-01-06T14:05:02.784197+01:00","created_by":"damir"}]}
{"id":"main-fyt","title":"Centralize adapter registration to avoid duplicate code","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T16:02:47.471991465Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.470762624Z","closed_at":"2026-01-01T16:32:16.470762624Z","close_reason":"Implementation completed by subagents","labels":["refactor","tech-debt"]}
{"id":"main-g53","title":"Optimize persistRows with batch insert operations","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T16:03:00.623470061Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.471858382Z","closed_at":"2026-01-01T16:32:16.471858382Z","close_reason":"Implementation completed by subagents","labels":["database","performance"]}
{"id":"main-g7b","title":"API: Store management endpoints","description":"Create src/orpc/router/stores.ts\n\n## Endpoints\n- list: chainSlug?, status?, isVirtual?, search?, page\n- get: storeId\n- update: storeId, name?, address?, city?, lat?, lng?\n- approve: storeId (pending → active)\n- reject: storeId (delete)\n- merge: sourceStoreId, targetStoreId\n- linkPriceSource: storeId, priceSourceStoreId\n- unlinkPriceSource: storeId\n- getPending: chainSlug?\n- getLinkedPhysical: virtualStoreId\n\n## Enrichment\n- triggerEnrichment: storeId, type\n- getEnrichmentTasks: storeId\n- verifyEnrichment: taskId, accepted, corrections?","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T14:32:33.044902668Z","created_by":"kasm-user","updated_at":"2026-01-09T15:01:20.148876119Z","closed_at":"2026-01-09T15:01:20.148876119Z","close_reason":"Implemented oRPC routers with all required endpoints","dependencies":[{"issue_id":"main-g7b","depends_on_id":"main-gmv","type":"parent-child","created_at":"2026-01-09T14:33:35.470370091Z","created_by":"kasm-user"},{"issue_id":"main-g7b","depends_on_id":"main-67u","type":"blocks","created_at":"2026-01-09T14:33:52.784503014Z","created_by":"kasm-user"}]}
{"id":"main-gmv","title":"Ingestion Pipeline + Admin UI","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-09T14:32:12.965332944Z","created_by":"kasm-user","updated_at":"2026-01-09T19:45:41.890590338Z","closed_at":"2026-01-09T19:45:41.890590338Z","close_reason":"All child tasks completed: schema, worker, UI components (store modal, ingestion dashboard, pending approval, store registry), APIs (store management, ingestion monitoring), and store enrichment workflow"}
{"id":"main-j8s","title":"Phase 7: Product Matching","description":"# Phase 7: Product Matching\n\nLink products across chains using barcode and AI matching.\n\n## Tasks\n\n1. Barcode auto-match\n2. AI name matching\n3. Admin review UI\n4. Test: products linked across chains\n\n## Tables (Already Defined)\n\n```typescript\nexport const products = pgTable('products', {\n  id: serial('id').primaryKey(),\n  name: varchar('name', { length: 256 }).notNull(),\n  brand: varchar('brand', { length: 128 }),\n  category: varchar('category', { length: 64 }),\n  unit: varchar('unit', { length: 16 }),\n  unitQuantity: varchar('unit_quantity', { length: 32 }),\n  imageUrl: varchar('image_url', { length: 512 }),\n  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow(),\n});\n\nexport const productLinks = pgTable('product_links', {\n  productId: integer('product_id').notNull().references(() =\u003e products.id),\n  retailerItemId: bigint('retailer_item_id', { mode: 'number' }).notNull(),\n  matchType: varchar('match_type', { length: 16 }),  // 'barcode', 'ai', 'manual'\n  confidence: real('confidence'),\n  verifiedAt: timestamp('verified_at', { withTimezone: true }),\n  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow(),\n}, (table) =\u003e ({\n  pk: primaryKey({ columns: [table.productId, table.retailerItemId] }),\n  itemIdx: index('product_links_item_idx').on(table.retailerItemId),\n}));\n```\n\n## Matching Pipeline (Go)\n\n1. Barcode exact match\n2. AI name similarity (OpenAI embeddings)\n3. Queue uncertain matches for review\n\n## Admin UI\n\n- Review uncertain matches\n- Manual link/unlink\n- Confidence threshold settings\n\n## Verification\n\n- Products linked across chains\n- Search by product shows all chain prices","status":"blocked","priority":2,"issue_type":"task","created_at":"2026-01-18T11:23:36.173789568Z","created_by":"kasm-user","updated_at":"2026-01-18T15:30:42.860678844Z","labels":["ace:code","ade:code"],"dependencies":[{"issue_id":"main-j8s","depends_on_id":"main-qm6","type":"parent-child","created_at":"2026-01-18T11:23:54.249436225Z","created_by":"kasm-user"},{"issue_id":"main-j8s","depends_on_id":"main-f2u","type":"blocks","created_at":"2026-01-18T11:24:26.27151589Z","created_by":"kasm-user"}]}
{"id":"main-jfh","title":"Verify Interspar data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.270542535Z","created_by":"kasm-user","updated_at":"2026-01-09T07:20:04.694606899Z","closed_at":"2026-01-09T07:20:04.694606899Z","close_reason":"Closed"}
{"id":"main-jut","title":"Verify Trgocentar data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.53332547Z","created_by":"kasm-user","updated_at":"2026-01-09T08:21:58.931710544Z","closed_at":"2026-01-09T08:21:58.931710544Z","close_reason":"Verified: Trgocentar (3 rows, 0 errors after XML→CSV fix), DM (2 rows, 0 errors)"}
{"id":"main-ki7","title":"Update CSV parser for price transparency fields","description":"Extend src/ingestion/parsers/csv.ts CsvColumnMapping + mapping logic to support unitPrice, lowestPrice30d, anchorPrice fields. Reuse parsePrice() for conversion to cents.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:34.724982+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.704415+01:00","closed_at":"2026-01-07T18:36:30.478055014Z","dependencies":[{"issue_id":"main-ki7","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.295986+01:00","created_by":"damir"},{"issue_id":"main-ki7","depends_on_id":"main-28t","type":"blocks","created_at":"2026-01-06T14:04:50.028744+01:00","created_by":"damir"}]}
{"id":"main-luv","title":"Test chunked parsing fix on test environment","status":"in_progress","priority":1,"issue_type":"task","created_at":"2026-01-16T16:20:02.203727+01:00","created_by":"damir","updated_at":"2026-01-16T16:34:10.952985+01:00","dependencies":[{"issue_id":"main-luv","depends_on_id":"main-acl","type":"blocks","created_at":"2026-01-16T16:20:07.643782+01:00","created_by":"damir"}]}
{"id":"main-mej","title":"Update Lidl adapter for price transparency fields","description":"Map: CIJENA_ZA_JEDINICU_MJERE, NAJNIZA_CIJENA_U_POSLJ._30_DANA, Sidrena_cijena_na_02.05.2025. Set anchorPriceAsOf=2025-05-02.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:55.241546+01:00","created_by":"damir","updated_at":"2026-01-06T14:31:05.138259+01:00","closed_at":"2026-01-06T14:31:05.138259+01:00","close_reason":"Already implemented in 2026 format update","dependencies":[{"issue_id":"main-mej","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:35.364934+01:00","created_by":"damir"},{"issue_id":"main-mej","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.029571+01:00","created_by":"damir"}]}
{"id":"main-mte","title":"Implement discover() methods for all chain adapters","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-01T16:02:36.857680433Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.46453366Z","closed_at":"2026-01-01T16:32:16.46453366Z","close_reason":"Implementation completed by subagents","labels":["feature","ingestion"]}
{"id":"main-n3p","title":"Update Trgocentar adapter for price transparency fields","description":"Map XML tags: \u003cc_jmj\u003e, \u003cc_najniza_30\u003e, \u003cc_020525\u003e. Note: current adapter is CSV-only - needs alignment. Set anchorPriceAsOf=2025-05-02. Source: https://trgocentar.com/Trgovine-cjenik/","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:20.164649+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.70519+01:00","closed_at":"2026-01-07T19:48:10.208603982Z","dependencies":[{"issue_id":"main-n3p","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:37.852264+01:00","created_by":"damir"},{"issue_id":"main-n3p","depends_on_id":"main-19a","type":"blocks","created_at":"2026-01-06T14:05:02.864775+01:00","created_by":"damir"}]}
{"id":"main-n4p","title":"Update Konzum adapter for price transparency fields","description":"Map: CIJENA ZA JEDINICU MJERE, NAJNIŽA CIJENA U POSLJEDNIH 30 DANA, SIDRENA CIJENA NA 2.5.2025. Set anchorPriceAsOf=2025-05-02.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:54.261649+01:00","created_by":"damir","updated_at":"2026-01-06T14:31:05.13616+01:00","closed_at":"2026-01-06T14:31:05.13616+01:00","close_reason":"Already implemented in 2026 format update","dependencies":[{"issue_id":"main-n4p","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:35.278339+01:00","created_by":"damir"},{"issue_id":"main-n4p","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:04:59.953467+01:00","created_by":"damir"}]}
{"id":"main-oji","title":"Phase 2 Testing: Go Service + Scrapers","description":"Testing for Phase 2: Go Service + All 15 Scrapers\n\n## Ingestion Success Tests\n\n```\nTEST: All chains ingest successfully\n  GIVEN: Go service running\n  WHEN: Ingestion triggered for all chains\n  THEN: ingestion_runs created per chain\n  AND: status transitions: pending → completed\n  AND: files_count, items_count populated\n  AND: Errors recorded but don't abort run\n\nTEST: Retailer items persisted correctly\n  GIVEN: Successful ingestion run\n  THEN: retailer_items table populated\n  AND: Each item has chain_id, external_id, name\n  AND: Unique constraint on (chain_id, external_id) holds\n\nTEST: Stores discovered\n  GIVEN: New store in source data\n  WHEN: Ingestion runs\n  THEN: Store created with status='pending'\n  AND: Store NOT visible to users\n```\n\n## Idempotency Tests\n\n```\nTEST: Re-ingestion doesn't duplicate items\n  GIVEN: Successful ingestion run\n  WHEN: Same data ingested again\n  THEN: retailer_items count unchanged\n  AND: updatedAt timestamps updated\n  AND: No duplicate stores\n\nTEST: Re-ingestion doesn't duplicate stores\n  VERIFY: SELECT store_id, COUNT(*) FROM stores GROUP BY 1 HAVING COUNT(*) \u003e 1 returns 0\n```\n\n## Partial Failure Resilience Tests\n\n```\nTEST: Fetch failure doesn't block other chains\n  GIVEN: One scraper configured to fail fetch\n  WHEN: RunAll executes\n  THEN: Error logged for failed chain\n  AND: Other chains complete successfully\n  AND: Run marked completed (with errors)\n\nTEST: Parse failure doesn't block other files\n  GIVEN: One file in chain has parse error\n  WHEN: Chain ingestion runs\n  THEN: Error recorded for specific file\n  AND: Other files processed\n  AND: ingestion_runs.error_count incremented\n\nTEST: File-level isolation\n  GIVEN: Multi-file chain\n  WHEN: File 2 of 5 fails to parse\n  THEN: Files 1,3,4,5 successfully persisted\n  AND: Error details include file name\n```\n\n## Per-Scraper Tests (15 scrapers)\n\nFor each: DM, Lidl, Kaufland, Spar, Interspar, Konzum, Plodine, Studenac, Tommy, Eurospin, KTC, Ribola, Metro, Trgocentar, NTL\n\n```\nTEST: {Chain} scraper parses correctly\n  GIVEN: Sample data file for {chain}\n  WHEN: Parser runs\n  THEN: Expected item count extracted\n  AND: Prices in cents (integer)\n  AND: Required fields populated (external_id, name, price)\n```\n\n## Verification Commands\n\n```bash\n# Go builds\ncd services/price-service \u0026\u0026 go build ./cmd/server\n\n# Health check\ncurl localhost:8081/internal/health\n\n# Trigger ingestion\ncurl -X POST localhost:8081/internal/admin/ingest/dm\n\n# All 15 chains ingest\nfor chain in dm lidl kaufland spar interspar konzum plodine studenac tommy eurospin ktc ribola metro trgocentar ntl; do\n  curl -X POST localhost:8081/internal/admin/ingest/$chain\ndone\n\n# Verify items\npsql $DATABASE_URL -c \"SELECT chain_id, COUNT(*) FROM retailer_items GROUP BY 1\"\n```\n\n## Location\n\n- `services/price-service/internal/scrapers/*_test.go`","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-18T12:43:35.839223632Z","created_by":"kasm-user","updated_at":"2026-01-18T12:43:35.839223632Z","labels":["ace:test"],"dependencies":[{"issue_id":"main-oji","depends_on_id":"main-x33","type":"blocks","created_at":"2026-01-18T12:45:25.187648633Z","created_by":"kasm-user"}]}
{"id":"main-pvp","title":"[DONE] Reduce queue batch size to prevent timeout","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-16T16:20:19.663099+01:00","created_by":"damir","updated_at":"2026-01-16T16:20:26.184567+01:00","closed_at":"2026-01-16T16:20:26.184567+01:00","close_reason":"Already deployed - queue batch size reduced to 1"}
{"id":"main-qm6","title":"Postgres + Golang Price Service Migration","status":"open","priority":1,"issue_type":"epic","created_at":"2026-01-18T11:21:46.1644156Z","created_by":"kasm-user","updated_at":"2026-01-18T11:21:46.1644156Z","labels":["ace:epic"]}
{"id":"main-qm6.1","title":"Review: Postgres + Golang Migration","description":"Final review gate for the migration epic. All code tasks must be closed before this review begins.","status":"closed","priority":1,"issue_type":"task","owner":"damir.bijuklic@gmail.com","created_at":"2026-01-18T14:56:12.864836946Z","created_by":"damir","updated_at":"2026-01-18T17:57:32.729964621Z","closed_at":"2026-01-18T17:57:32.729964621Z","close_reason":"Closed","labels":["ace:review","ade:review"],"dependencies":[{"issue_id":"main-qm6.1","depends_on_id":"main-qm6","type":"parent-child","created_at":"2026-01-18T14:56:12.865861576Z","created_by":"damir"}]}
{"id":"main-qsn","title":"Schema: Add virtual store columns to stores table","description":"## Goal\nAdd columns to stores table to support virtual/physical store separation.\n\n## Schema Changes\n**File**: `src/db/schema.ts` - stores table\n\nAdd these columns:\n```typescript\nisVirtual: integer('is_virtual', { mode: 'boolean' }).default(true),\npriceSourceStoreId: text('price_source_store_id').references(() =\u003e stores.id),\nstatus: text('status').default('active'), // 'active' | 'pending'\n```\n\n## Migration SQL\n```sql\nALTER TABLE stores ADD COLUMN is_virtual INTEGER DEFAULT 1;\nALTER TABLE stores ADD COLUMN price_source_store_id TEXT REFERENCES stores(id);\nALTER TABLE stores ADD COLUMN status TEXT DEFAULT 'active';\n\n-- Indexes\nCREATE INDEX stores_status_idx ON stores(status);\nCREATE INDEX stores_price_source_idx ON stores(price_source_store_id);\n```\n\n## Column Definitions\n- `is_virtual`: true=import-linked store (holds prices), false=physical location\n- `price_source_store_id`: FK to another store for price inheritance\n- `status`: 'active' (normal) or 'pending' (awaiting approval)\n\n## Default Behavior\n- All existing stores get is_virtual=1 (they came from imports)\n- All existing stores get status='active' (grandfathered)\n\n## Verification\n1. Run `pnpm db:generate` to create migration\n2. Run `pnpm db:migrate` to apply\n3. Query: `SELECT is_virtual, status FROM stores LIMIT 5` → all should be 1, 'active'","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-09T13:50:56.92132449Z","created_by":"kasm-user","updated_at":"2026-01-09T13:57:57.25980227Z","closed_at":"2026-01-09T13:57:57.25980227Z","close_reason":"Added is_virtual, price_source_store_id, and status columns to stores table with indexes. Existing stores defaulted to is_virtual=1, status='active'"}
{"id":"main-r9p","title":"Update persist module for price transparency fields","description":"Update src/ingestion/core/persist.ts upserts for store_item_state to write new columns. Keep computePriceSignature() unchanged - don't include lowestPrice30d to avoid period churn.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:53.088711+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.705726+01:00","closed_at":"2026-01-07T18:36:30.482123118Z","dependencies":[{"issue_id":"main-r9p","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.532761+01:00","created_by":"damir"},{"issue_id":"main-r9p","depends_on_id":"main-28t","type":"blocks","created_at":"2026-01-06T14:04:51.384936+01:00","created_by":"damir"}]}
{"id":"main-rqe","title":"Verify DM data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.587432942Z","created_by":"kasm-user","updated_at":"2026-01-09T08:21:58.933690923Z","closed_at":"2026-01-09T08:21:58.933690923Z","close_reason":"Verified: Trgocentar (3 rows, 0 errors after XML→CSV fix), DM (2 rows, 0 errors)"}
{"id":"main-s1l","title":"Fix hardcoded absolute paths in chain adapter tests","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-01T16:02:48.414633302Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.467067679Z","closed_at":"2026-01-01T16:32:16.467067679Z","close_reason":"Implementation completed by subagents","labels":["bug","testing"]}
{"id":"main-tvx","title":"API: Ingestion monitoring endpoints","description":"Create src/orpc/router/ingestion.ts\n\n## Monitoring\n- listRuns: chainSlug?, status?, page\n- getRun: runId\n- listFiles: runId, status?\n- getFile: fileId\n- listChunks: fileId, status?\n- getChunk: chunkId\n- listErrors: runId?, fileId?, chunkId?, errorType?\n\n## Stats\n- getStats: timeRange (24h|7d|30d)\n\n## Re-runs\n- rerunRun: runId\n- rerunFile: fileId\n- rerunChunk: chunkId\n\n## Manual trigger\n- triggerChain: chainSlug","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T14:32:34.734746259Z","created_by":"kasm-user","updated_at":"2026-01-09T15:01:20.15102338Z","closed_at":"2026-01-09T15:01:20.15102338Z","close_reason":"Implemented oRPC routers with all required endpoints","dependencies":[{"issue_id":"main-tvx","depends_on_id":"main-gmv","type":"parent-child","created_at":"2026-01-09T14:33:35.685463535Z","created_by":"kasm-user"},{"issue_id":"main-tvx","depends_on_id":"main-67u","type":"blocks","created_at":"2026-01-09T14:33:53.006538725Z","created_by":"kasm-user"},{"issue_id":"main-tvx","depends_on_id":"main-wyq","type":"blocks","created_at":"2026-01-09T14:33:53.215256778Z","created_by":"kasm-user"}]}
{"id":"main-ugi","title":"Phase 8: Documentation","description":"# Phase 8: Documentation\n\nUpdate all documentation to reflect new architecture.\n\n## Tasks\n\n1. Update doc/planning/codebase/*\n2. Architecture diagrams\n3. API documentation\n4. Deployment guide\n\n## Files to Update\n\n- `doc/planning/codebase/ARCHITECTURE.md` - new system design\n- `doc/planning/codebase/STRUCTURE.md` - Go service structure\n- `doc/planning/codebase/STACK.md` - add Go, sqlc, pgx\n\n## Files to Create\n\n- `doc/planning/API.md` - internal Go API, oRPC routes\n- `doc/planning/DEPLOYMENT.md` - Hetzner setup\n- `services/price-service/README.md` - Go service docs\n\n## Content to Document\n\n### Architecture\n- Node.js as gateway, Go internal\n- Drizzle owns schema, sqlc reads it\n- Price groups algorithm\n- Schema ownership diagram\n\n### API Documentation\n- Internal Go API endpoints\n- oRPC routes that proxy to Go\n- Request/response formats\n\n### Deployment\n- Hetzner setup guide\n- PostgreSQL configuration\n- Environment variables\n- Docker/compose setup\n\n## Verification\n\n- `doc/planning/` updated and accurate\n- `services/price-service/README.md` complete\n- New developer can understand architecture from docs","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-18T11:23:36.439713766Z","created_by":"kasm-user","updated_at":"2026-01-18T15:56:30.571452403Z","closed_at":"2026-01-18T15:56:30.57145357Z","labels":["ace:code"],"dependencies":[{"issue_id":"main-ugi","depends_on_id":"main-qm6","type":"parent-child","created_at":"2026-01-18T11:23:54.443210447Z","created_by":"kasm-user"},{"issue_id":"main-ugi","depends_on_id":"main-c8l","type":"blocks","created_at":"2026-01-18T11:24:26.31984504Z","created_by":"kasm-user"},{"issue_id":"main-ugi","depends_on_id":"main-bqm","type":"blocks","created_at":"2026-01-18T11:24:26.373911908Z","created_by":"kasm-user"},{"issue_id":"main-ugi","depends_on_id":"main-j8s","type":"blocks","created_at":"2026-01-18T11:24:26.421507145Z","created_by":"kasm-user"}]}
{"id":"main-up6","title":"Phase 3 Testing: Node.js → Go Integration","description":"Testing for Phase 3: Node.js → Go Integration\n\n## E2E: Price Display Tests\n\n```\nTEST: Frontend loads prices\n  GIVEN: Items in database from Phase 2\n  WHEN: User navigates to price page\n  THEN: Prices display correctly\n  AND: Response comes through Node.js (not direct Go)\n\nTEST: Price data matches database\n  GIVEN: Known item with price=1299\n  WHEN: Frontend queries price\n  THEN: Displayed price = 12.99 kn\n```\n\n## Security Tests\n\n```\nTEST: Go service not publicly accessible\n  WHEN: curl localhost:8081 from browser\n  THEN: Connection refused (internal binding only)\n\nTEST: Go service accessible from Node.js\n  WHEN: Node.js calls http://localhost:8081/internal/prices/...\n  THEN: Response received successfully\n```\n\n## Contract Tests\n\n```\nTEST: Invalid storeId returns 404\n  WHEN: GET /api/prices/konzum/99999999\n  THEN: 404 Not Found (clean error)\n\nTEST: Invalid chainSlug returns 404\n  WHEN: GET /api/prices/invalid-chain/1\n  THEN: 404 Not Found\n\nTEST: Malformed request returns 400\n  WHEN: GET /api/prices/konzum/abc\n  THEN: 400 Bad Request\n```\n\n## Regression Tests\n\n```\nTEST: TS ingestion code deleted\n  VERIFY: src/ingestion/ directory doesn't exist\n  VERIFY: pnpm build succeeds\n  VERIFY: No imports from src/ingestion in codebase\n```\n\n## Verification Commands\n\n```bash\n# Frontend works\npnpm dev\n# Navigate to price pages\n\n# No direct Go access from browser\ncurl http://localhost:8081 # Should fail\n\n# TS ingestion deleted\nls src/ingestion/  # Should not exist\npnpm build  # Should succeed\n```\n\n## Location\n\n- `src/__tests__/e2e/prices.test.ts`","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-18T12:44:21.028655277Z","created_by":"kasm-user","updated_at":"2026-01-18T12:44:21.028655277Z","labels":["ace:test"],"dependencies":[{"issue_id":"main-up6","depends_on_id":"main-27n","type":"blocks","created_at":"2026-01-18T12:45:25.243789643Z","created_by":"kasm-user"}]}
{"id":"main-v2f","title":"Phase 1 Testing: Postgres Migration","description":"Testing for Phase 1: Port to Postgres\n\n## E2E: Authentication Flow\n\n```\nTEST: User can sign up\n  GIVEN: Clean database\n  WHEN: User submits signup form\n  THEN: User row created in PG `users` table\n  AND: Session created\n  AND: User redirected to dashboard\n\nTEST: User can log in\n  GIVEN: Existing user in database\n  WHEN: User submits correct credentials\n  THEN: Session created\n  AND: Session persists across server restarts\n\nTEST: User can log out\n  GIVEN: Logged-in user\n  WHEN: User clicks logout\n  THEN: Session invalidated\n  AND: Protected routes inaccessible\n```\n\n## Data Integrity Tests\n\n```\nTEST: All auth tables exist in Postgres\n  VERIFY: users, sessions, accounts, verification tables present\n  VERIFY: Correct column types (varchar, timestamp with timezone)\n\nTEST: No SQLite remnants\n  VERIFY: No `.db` files created in /data\n  VERIFY: No better-sqlite3 in node_modules\n  VERIFY: Build succeeds without SQLite deps\n\nTEST: Migrations are reproducible\n  GIVEN: Fresh Postgres database\n  WHEN: drizzle-kit migrate runs\n  THEN: Schema matches expected state\n```\n\n## Regression Tests\n\n```\nTEST: Existing frontend flows unchanged\n  VERIFY: All existing routes load\n  VERIFY: No console errors related to database\n```\n\n## Verification Commands\n\n```bash\n# Tables exist\npsql $DATABASE_URL -c \"\\dt\"\n\n# TanStack starts\npnpm dev\n\n# Auth works - Manual: Complete signup/login flow\n```\n\n## Location\n\n- `src/__tests__/e2e/auth.test.ts`","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-18T12:43:35.711541394Z","created_by":"kasm-user","updated_at":"2026-01-18T12:43:35.711541394Z","labels":["ace:test"],"dependencies":[{"issue_id":"main-v2f","depends_on_id":"main-10m","type":"blocks","created_at":"2026-01-18T12:45:25.132801775Z","created_by":"kasm-user"}]}
{"id":"main-wnh","title":"Update Plodine adapter for price transparency fields","description":"Map: Cijena po JM, Najniza cijena u poslj. 30 dana, Sidrena cijena na 2.5.2025. Set anchorPriceAsOf=2025-05-02. Source: https://www.plodine.hr/info-o-cijenama","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:56.927946+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.70625+01:00","closed_at":"2026-01-07T19:48:10.201715708Z","dependencies":[{"issue_id":"main-wnh","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:35.444186+01:00","created_by":"damir"},{"issue_id":"main-wnh","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.106606+01:00","created_by":"damir"}]}
{"id":"main-wo3","title":"Global Invariants Test Suite","description":"Cross-cutting tests that must pass after EVERY phase. Run continuously throughout migration.\n\n## Database Invariants\n\n| ID | Invariant | Test Method |\n|----|-----------|-------------|\n| DB-1 | No duplicate retailer items per chain | `SELECT chain_id, external_id, COUNT(*) FROM retailer_items GROUP BY 1,2 HAVING COUNT(*) \u003e 1` returns 0 rows |\n| DB-2 | At most one current price group per store | `SELECT store_id, COUNT(*) FROM store_group_history WHERE valid_to IS NULL GROUP BY 1 HAVING COUNT(*) \u003e 1` returns 0 rows |\n| DB-3 | No overlapping store group membership | GiST exclusion constraint prevents insert of overlapping ranges |\n| DB-4 | Group immutability | Once created, `price_groups.price_hash` never changes |\n| DB-5 | Historical price correctness | Query \"price at store X on date Y\" returns the price valid on that date |\n\n## Hash \u0026 Grouping Invariants (Critical - Failure = Catastrophic)\n\n| ID | Invariant | Test Method |\n|----|-----------|-------------|\n| HASH-1 | Same prices = same hash = same group | Identical price vectors produce identical SHA256 |\n| HASH-2 | Any price difference = different hash | Change 1 cent in 1 item = different hash |\n| HASH-3 | Order does not matter | Shuffled input produces same hash |\n| HASH-4 | NULL discount == 0 discount | `{item:100, discount:null}` == `{item:100, discount:0}` |\n| HASH-5 | Hash stable across runs/machines | Same input on different machines = same output |\n\n## API Invariants\n\n| ID | Invariant | Test Method |\n|----|-----------|-------------|\n| API-1 | Node.js is only public entrypoint | Direct browser call to Go port fails |\n| API-2 | Auth enforced consistently | Unauthenticated requests rejected |\n| API-3 | Idempotency | Re-running ingestion doesn't create duplicates |\n\n## Implementation\n\nLocation: `tests/integration/invariants.test.ts`\n\nThese tests should be run:\n- After each phase completion\n- In CI on every PR\n- Before any production deployment","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-18T12:43:34.565110877Z","created_by":"kasm-user","updated_at":"2026-01-18T12:43:34.565110877Z","labels":["ace:test"],"dependencies":[{"issue_id":"main-wo3","depends_on_id":"main-qm6","type":"blocks","created_at":"2026-01-18T12:45:26.482045931Z","created_by":"kasm-user"}]}
{"id":"main-wyq","title":"Worker: Chunking pipeline handlers","description":"Add new queue message types and handlers:\n\n## New Message Types\n- ParseChunkedQueueMessage\n- PersistChunkQueueMessage  \n- RerunQueueMessage\n- EnrichStoreQueueMessage\n\n## New Handlers in worker.ts\n1. handleParseChunked - parse file, split into chunks, store in R2, enqueue persist\n2. handlePersistChunk - load chunk from R2, persist rows, update status\n3. handleRerun - re-run at run/file/chunk level\n4. handleEnrichStore - call geocoding API, save results","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-09T14:32:32.050698131Z","created_by":"kasm-user","updated_at":"2026-01-09T14:50:25.426160745Z","closed_at":"2026-01-09T14:50:25.426160745Z","close_reason":"Implemented chunking pipeline handlers: ParseChunkedQueueMessage, PersistChunkQueueMessage, RerunQueueMessage, EnrichStoreQueueMessage with corresponding handlers handleParseChunked, handlePersistChunk, handleRerun, handleEnrichStore","dependencies":[{"issue_id":"main-wyq","depends_on_id":"main-gmv","type":"parent-child","created_at":"2026-01-09T14:33:35.252444057Z","created_by":"kasm-user"},{"issue_id":"main-wyq","depends_on_id":"main-67u","type":"blocks","created_at":"2026-01-09T14:33:52.549664396Z","created_by":"kasm-user"}]}
{"id":"main-x33","title":"Phase 2: Go Service + All 15 Scrapers","description":"# Phase 2: Go Service + All 15 Scrapers\n\nCreate Go module and port all 15 scrapers from TypeScript.\n\n## Tasks\n\n1. Create Go module (sqlc + pgx + chi)\n2. Add tables for ingestion (retailer_items, etc) via Drizzle\n3. Port ALL 15 scrapers (no job queue)\n4. Scheduler (robfig/cron)\n5. New stores → status='pending'\n6. Test: all chains ingest successfully\n\n## Setup\n\n```bash\nmkdir -p services/price-service\ncd services/price-service\ngo mod init github.com/fluximus-prime/kosarica-prices\n```\n\n## Go Dependencies\n\n- github.com/jackc/pgx/v5\n- github.com/go-chi/chi/v5\n- github.com/robfig/cron/v3\n- github.com/air-verse/air (hot reload)\n\n## Tables to Add (Drizzle)\n\n- chains, stores, retailer_items, ingestion_runs\n\n## Scrapers to Port (15 total)\n\nDM, Lidl, Kaufland, Spar, Interspar, Konzum, Plodine, Studenac, Tommy, Eurospin, KTC, Ribola, Metro, Trgocentar, NTL\n\n## retailer_items Schema\n\n```typescript\nexport const retailerItems = pgTable('retailer_items', {\n  id: bigserial('id', { mode: 'number' }).primaryKey(),\n  chainId: smallint('chain_id').notNull().references(() =\u003e chains.id),\n  externalId: varchar('external_id', { length: 64 }).notNull(),\n  barcode: varchar('barcode', { length: 32 }),\n  name: varchar('name', { length: 256 }).notNull(),\n  category: varchar('category', { length: 128 }),\n  brand: varchar('brand', { length: 128 }),\n  unit: varchar('unit', { length: 16 }),\n  unitQuantity: varchar('unit_quantity', { length: 32 }),\n  imageUrl: varchar('image_url', { length: 512 }),\n  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow(),\n  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow(),\n}, (table) =\u003e ({\n  uniqChainItem: uniqueIndex('retailer_items_chain_external_idx')\n    .on(table.chainId, table.externalId),\n  barcodeIdx: index('retailer_items_barcode_idx').on(table.barcode),\n}));\n```\n\n## Go Service Structure\n\n```\nservices/price-service/\n├── cmd/server/main.go\n├── internal/\n│   ├── db/                      # sqlc generated\n│   ├── api/\n│   ├── ingestion/\n│   │   ├── scheduler.go         # robfig/cron\n│   │   ├── pipeline.go\n│   │   └── persist.go\n│   └── scrapers/\n│       ├── adapter.go\n│       └── ... (15 total)\n├── queries/\n├── go.mod\n└── Dockerfile\n```\n\n## Air Config (Hot Reload)\n\n```toml\n# services/price-service/.air.toml\nroot = \".\"\ntmp_dir = \"tmp\"\n\n[build]\ncmd = \"go build -o ./tmp/main ./cmd/server\"\nbin = \"./tmp/main\"\nargs = [\"-port\", \"3003\"]\ninclude_ext = [\"go\", \"sql\"]\ndelay = 1000\n```\n\n## Verification\n\n- `cd services/price-service \u0026\u0026 go build ./cmd/server`\n- `curl localhost:8081/internal/health`\n- `curl -X POST localhost:8081/internal/admin/ingest/dm`\n- All 15 chains ingest without errors","status":"in_progress","priority":1,"issue_type":"task","created_at":"2026-01-18T11:23:43.61149936Z","created_by":"kasm-user","updated_at":"2026-01-19T13:58:48.822519505Z","labels":["ace:code","ade:code"],"dependencies":[{"issue_id":"main-x33","depends_on_id":"main-10m","type":"blocks","created_at":"2026-01-18T11:24:26.032254045Z","created_by":"kasm-user"},{"issue_id":"main-x33","depends_on_id":"main-qm6","type":"parent-child","created_at":"2026-01-18T11:27:06.670552634Z","created_by":"kasm-user"}]}
{"id":"main-yqi","title":"Verify Plodine data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.213550726Z","created_by":"kasm-user","updated_at":"2026-01-09T07:20:04.692416717Z","closed_at":"2026-01-09T07:20:04.692416717Z","close_reason":"Closed"}
{"id":"main-z1s","title":"Refactor chain adapters: Extract common base class to reduce duplication","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T16:02:34.140515731Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.465835961Z","closed_at":"2026-01-01T16:32:16.465835961Z","close_reason":"Implementation completed by subagents","labels":["refactor","tech-debt"]}
{"id":"main-zrq","title":"Generate Drizzle migration for price transparency columns","description":"Run drizzle-kit generate to create migration for new price transparency columns in store_item_state (and optionally store_item_price_periods).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T14:03:32.306583+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.706783+01:00","closed_at":"2026-01-07T17:00:40.006722921Z","dependencies":[{"issue_id":"main-zrq","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.134404+01:00","created_by":"damir"},{"issue_id":"main-zrq","depends_on_id":"main-4cn","type":"blocks","created_at":"2026-01-06T14:04:46.270452+01:00","created_by":"damir"}]}
{"id":"main-zu4","title":"Fix D1 SQL variable limit in persist batch","description":"## Problem\n`persistRowChunkBatched` in `src/ingestion/core/persist.ts` accumulates all write queries for a chunk into a single `db.batch()` call. When the total SQL bind parameters exceed D1's 999 variable limit, the batch fails with:\n\n```\nD1_ERROR: too many SQL variables at offset 696: SQLITE_ERROR\n```\n\n## Current Behavior\n- DEFAULT_BATCH_SIZE = 50 rows per chunk\n- Each row generates variable number of queries depending on:\n  - Insert vs update (inserts have more params)\n  - Number of barcodes\n  - Price change status (changed prices need 3 queries)\n- All queries batched into single `db.batch()` call\n\n## Solution Options\n1. **Dynamic splitting**: Count bind parameters as queries are added to writeQueries, split into sub-batches when approaching 999 limit\n2. **Configurable batch size**: Add batchSize parameter to persist functions, let caller tune based on their data characteristics\n3. **Hybrid**: Default dynamic splitting with optional override\n\n## Files\n- `src/ingestion/core/persist.ts:1193` - `persistRowChunkBatched` function\n- Line 1577 - `db.batch(writeQueries)` call that fails","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-09T05:26:01.177722657Z","created_by":"kasm-user","updated_at":"2026-01-09T07:04:36.474758349Z","closed_at":"2026-01-09T07:04:36.474758349Z","close_reason":"Fixed by using dynamic batch sizes based on column counts. storeItemState now uses 4 rows per batch (72 params) instead of 8 (144 params)."}
{"id":"main-zw6","title":"Add rate limiting and exponential backoff to chain adapter fetch methods","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T16:02:59.660865529Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.469664865Z","closed_at":"2026-01-01T16:32:16.469664865Z","close_reason":"Implementation completed by subagents","labels":["ingestion","reliability"]}
