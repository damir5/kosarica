{"id":"main-073","title":"Verify Kaufland data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.376110018Z","created_by":"kasm-user","updated_at":"2026-01-09T07:29:30.649948846Z","closed_at":"2026-01-09T07:29:30.649948846Z","close_reason":"Closed"}
{"id":"main-0fg","title":"Ingestion: Pending store approval workflow","description":"## Goal\nNew unknown stores created as pending (not active). Existing stores get identifiers added.\n\n## Changes to autoRegisterStore()\n**File**: `src/ingestion/core/persist.ts` (~line 742)\n\nCurrent signature:\n```typescript\nexport async function autoRegisterStore(\n  db: AnyDatabase,\n  chainSlug: string,\n  identifier: string,\n  identifierType: string,\n  options: StoreAutoRegisterOptions,\n): Promise\u003cstring | null\u003e\n```\n\nNew signature:\n```typescript\nexport async function autoRegisterStore(\n  db: AnyDatabase,\n  chainSlug: string,\n  identifier: string,\n  identifierType: string,\n  options: StoreAutoRegisterOptions,\n): Promise\u003c{ storeId: string; status: 'existing' | 'pending' | 'created' } | null\u003e\n```\n\n## New Logic\n1. Try resolve existing store by identifier → return { storeId, status: 'existing' }\n2. If not found, check if physical store exists with same name in chain\n3. If physical match → add identifier to it, return { storeId, status: 'existing' }\n4. If no match → create store with:\n   - `isVirtual=true` (it's import-linked)\n   - `status='pending'` (awaits approval)\n   - Return { storeId, status: 'pending' }\n\n## Special Case: National Stores\nWhen `identifierType === 'national'`:\n- Always set `isVirtual=true`\n- Set `status='active'` (national stores auto-approved)\n\n## Update Callers\nUpdate `persistRowsForStore()` and any other callers to handle new return type.\n\n## Logging\nLog when pending store created:\n```\n[persist] Created pending store: \"Store Name\" (identifier) for chain xyz - awaiting approval\n```\n\n## Verification\n1. Run ingestion for chain with new store file → verify store created with status='pending'\n2. Run ingestion for existing store → verify identifier added, no new store\n3. Run DM ingestion → verify dm_national has is_virtual=1, status='active'","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-09T13:51:11.401510284Z","created_by":"kasm-user","updated_at":"2026-01-09T14:20:04.506611276Z","closed_at":"2026-01-09T14:20:04.506611276Z","close_reason":"Implemented in parallel agents","dependencies":[{"issue_id":"main-0fg","depends_on_id":"main-qsn","type":"blocks","created_at":"2026-01-09T13:52:05.063401539Z","created_by":"kasm-user"}]}
{"id":"main-0fr","title":"CLI: Physical store creation and linking","description":"## Goal\nCommands to add physical stores and link them to virtual stores for pricing.\n\n## File\n**File**: `src/ingestion/cli/stores.ts` (extend existing)\n\n## Commands\n\n### Add physical store\n```bash\npnpm ingest stores --add \\\n  --chain=dm \\\n  --name=\"DM Zagreb Ilica\" \\\n  --address=\"Ilica 123\" \\\n  --city=\"Zagreb\" \\\n  --postal-code=\"10000\" \\\n  --lat=45.815 \\\n  --lng=15.982 \\\n  --price-source=dm_national\n```\n\nCreates store with:\n- `isVirtual=false`\n- `priceSourceStoreId` → resolved from --price-source identifier\n- `status='active'`\n- Location fields populated\n\n### Link existing store to price source\n```bash\npnpm ingest stores --link \u003cstore_id\u003e --price-source=\u003cidentifier\u003e\n```\n- Resolves identifier to store ID\n- Sets priceSourceStoreId on target store\n- Outputs: \"Linked {store} to price source {source}\"\n\n### Import physical stores from CSV\n```bash\npnpm ingest stores --import-csv ./dm_stores.csv --chain=dm --price-source=dm_national\n```\n\nCSV format:\n```csv\nname,address,city,postal_code,lat,lng\nDM Zagreb Ilica,Ilica 123,Zagreb,10000,45.815,15.982\nDM Split Riva,Riva 45,Split,21000,43.508,16.440\n```\n\n- Creates all stores with isVirtual=false\n- All link to specified --price-source\n- Reports: \"Imported X stores, Y errors\"\n\n## Validation\n- --chain required for --add and --import-csv\n- --price-source must resolve to existing virtual store\n- Physical stores require at least name and city\n- Lat/lng optional but recommended\n\n## Verification\n1. Add single physical DM store → verify isVirtual=false, priceSourceStoreId set\n2. Import CSV of 3 stores → verify all created and linked\n3. Query prices for physical store → should use virtual store's prices","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T13:51:40.374415702Z","created_by":"kasm-user","updated_at":"2026-01-09T14:27:07.90945938Z","closed_at":"2026-01-09T14:27:07.90945938Z","close_reason":"Implemented CLI commands for physical store creation and linking","dependencies":[{"issue_id":"main-0fr","depends_on_id":"main-dy8","type":"blocks","created_at":"2026-01-09T13:52:05.166821099Z","created_by":"kasm-user"}]}
{"id":"main-0ri","title":"UI: Add Physical Store modal","description":"Modal for adding physical stores with price source linking\n\n## UI Sketch\n```\n[MODAL: ADD PHYSICAL STORE]\n\n+---------------------------------------------------------------+\n|  Add New Physical Store (Chain: DM)                           |\n+---------------------------------------------------------------+\n|                                                               |\n|  1. Location Details                                          |\n|     Name:    [ DM Zadar Relja       ]                         |\n|     Address: [ Ul. Zrinsko Frankopanska 12 ]                  |\n|     City:    [ Zadar                ]                         |\n|     Geo:     [ 44.1123 ] , [ 15.2231 ]  [Pin on Map]          |\n|                                                               |\n|  2. Pricing Configuration                                     |\n|     How does this store get its prices?                       |\n|                                                               |\n|     ( ) Independent (Has its own import files)                |\n|     (*) Inherited (Uses a Virtual Price Source)               |\n|                                                               |\n|     Select Source:                                            |\n|     [ DM National Pricing (Recommended)   v ]                 |\n|                                                               |\n|  [ CANCEL ]                                   [ SAVE STORE ]  |\n+---------------------------------------------------------------+\n```\n\n## Components\n- StoreAddModal.tsx - Radix Dialog\n- StoreForm.tsx - form fields with validation\n- PriceSourceSelect.tsx - dropdown of virtual stores in chain\n- MapPinButton.tsx - open map picker (optional)\n\n## Files\n- src/components/admin/stores/StoreAddModal.tsx\n- src/components/admin/stores/StoreForm.tsx\n- src/components/admin/stores/PriceSourceSelect.tsx","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T14:33:01.103309137Z","created_by":"kasm-user","updated_at":"2026-01-09T19:01:21.814456232Z","closed_at":"2026-01-09T19:01:21.814456232Z","close_reason":"Implemented all UI components and routes","dependencies":[{"issue_id":"main-0ri","depends_on_id":"main-gmv","type":"parent-child","created_at":"2026-01-09T14:33:39.923351221Z","created_by":"kasm-user"},{"issue_id":"main-0ri","depends_on_id":"main-g7b","type":"blocks","created_at":"2026-01-09T14:33:54.923096759Z","created_by":"kasm-user"}]}
{"id":"main-0u1","title":"Verify Eurospin data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.322811463Z","created_by":"kasm-user","updated_at":"2026-01-09T07:29:30.647408197Z","closed_at":"2026-01-09T07:29:30.647408197Z","close_reason":"Closed"}
{"id":"main-11x","title":"Update KTC adapter for price transparency fields","description":"Map: Cijena za jedinicu mjere, Najniža cijena u posljednjih 30 dana. Note: no anchor column in sample. Source: https://www.ktc.hr/cjenici","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:15.802272+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.693219+01:00","closed_at":"2026-01-07T19:48:10.205766889Z","dependencies":[{"issue_id":"main-11x","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:37.617339+01:00","created_by":"damir"},{"issue_id":"main-11x","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.398525+01:00","created_by":"damir"}]}
{"id":"main-19a","title":"Update XML parser for price transparency fields","description":"Extend src/ingestion/parsers/xml.ts XmlFieldMapping + item mapping to support CijenaZaJedinicuMjere, NajnizaCijena, SidrenaCijena for Studenac/Trgocentar.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:37.609326+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.697638+01:00","closed_at":"2026-01-07T18:36:30.481364781Z","dependencies":[{"issue_id":"main-19a","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.451074+01:00","created_by":"damir"},{"issue_id":"main-19a","depends_on_id":"main-28t","type":"blocks","created_at":"2026-01-06T14:04:50.217483+01:00","created_by":"damir"}]}
{"id":"main-1q1","title":"see c27df4b8f3fbbdba2c4aca246f78aca15d741945 in https://github.com/damir5/nftraffle (with gh) and port table column copying to clipboard here","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T09:16:14.786404813Z","updated_at":"2025-12-31T09:20:56.66265317Z","closed_at":"2025-12-31T09:20:56.66265317Z","close_reason":"Ported table column copying to clipboard from nftraffle. Created CopyableCell component, integrated into UserViewModal and UserTable. Added sonner for toast notifications."}
{"id":"main-1qa","title":"Feature: Store enrichment workflow (geocoding + verification)","description":"AI + human enrichment for stores\n\n## Flow\n1. Store created/imported with address but no lat/lng\n2. Admin clicks \"Geocode Address\" or automatic trigger\n3. Worker calls geocoding API (Google/OpenStreetMap)\n4. Result saved to store_enrichment_tasks with confidence score\n5. If confidence \u003c 0.8, appears in verification queue\n6. Admin reviews: Accept / Reject / Edit coordinates\n7. Verified result applied to store\n\n## Components\n- StoreEnrichmentSection.tsx - in store detail page\n- EnrichmentTaskCard.tsx - show AI suggestion\n- VerifyLocationModal.tsx - accept/reject/edit\n- GeocodingService.ts - API integration\n\n## Files\n- src/ingestion/services/geocoding.ts\n- src/components/admin/stores/StoreEnrichmentSection.tsx\n- src/components/admin/stores/VerifyLocationModal.tsx","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-09T14:33:17.973187011Z","created_by":"kasm-user","updated_at":"2026-01-09T15:15:53.300870175Z","closed_at":"2026-01-09T15:15:53.300870175Z","close_reason":"Implemented store enrichment workflow with geocoding service, frontend UI components, and worker integration","dependencies":[{"issue_id":"main-1qa","depends_on_id":"main-gmv","type":"parent-child","created_at":"2026-01-09T14:33:40.540313317Z","created_by":"kasm-user"},{"issue_id":"main-1qa","depends_on_id":"main-g7b","type":"blocks","created_at":"2026-01-09T14:33:55.558279692Z","created_by":"kasm-user"}]}
{"id":"main-28t","title":"Extend NormalizedRow types with price transparency fields","description":"Update src/ingestion/core/types.ts NormalizedRow with optional fields: unitPriceCents, unitPriceBaseQuantity, unitPriceBaseUnit, lowestPrice30dCents, anchorPriceCents, anchorPriceAsOf.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:33.343828+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.698415+01:00","closed_at":"2026-01-07T17:14:04.499258764Z","dependencies":[{"issue_id":"main-28t","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.214309+01:00","created_by":"damir"},{"issue_id":"main-28t","depends_on_id":"main-zrq","type":"blocks","created_at":"2026-01-06T14:04:48.568573+01:00","created_by":"damir"}]}
{"id":"main-2al","title":"Add unique constraints to storeIdentifiers and productLinks tables","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T16:02:49.397566406Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.468320355Z","closed_at":"2026-01-01T16:32:16.468320355Z","close_reason":"Implementation completed by subagents","labels":["database","schema"]}
{"id":"main-2fr","title":"Add database indexes for price queries and common lookups","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T16:03:07.801405648Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.472944223Z","closed_at":"2026-01-01T16:32:16.472944223Z","close_reason":"Implementation completed by subagents","labels":["database","performance"]}
{"id":"main-2u8","title":"Update XLSX parser for price transparency fields","description":"Extend src/ingestion/parsers/xlsx.ts XlsxColumnMapping + mapping logic to support unitPrice, lowestPrice30d, anchorPrice fields for DM adapter.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:36.452387+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.699074+01:00","closed_at":"2026-01-07T18:36:30.480186775Z","dependencies":[{"issue_id":"main-2u8","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.372832+01:00","created_by":"damir"},{"issue_id":"main-2u8","depends_on_id":"main-28t","type":"blocks","created_at":"2026-01-06T14:04:50.123182+01:00","created_by":"damir"}]}
{"id":"main-3vl","title":"Update Eurospin adapter for price transparency fields","description":"Map: CIJENA_ZA_JEDINICU_MJERE, NAJNIŽA_MPC_U_30DANA, SIDRENA_CIJENA, plus POSEB.OBLIK_PROD__ZA_JEDINICU_MJERE for special sale unit price. Source: https://www.eurospin.hr/cjenik/","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:59.323181+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.699695+01:00","closed_at":"2026-01-07T19:48:10.204459009Z","dependencies":[{"issue_id":"main-3vl","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:35.597929+01:00","created_by":"damir"},{"issue_id":"main-3vl","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.24898+01:00","created_by":"damir"}]}
{"id":"main-4cn","title":"Add price transparency columns to store_item_state schema","description":"Update src/db/schema.ts store_item_state table with: unit_price, unit_price_base_quantity, unit_price_base_unit, lowest_price_30d, anchor_price, anchor_price_as_of. Optional: add to store_item_price_periods but exclude from price signature to avoid churn.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T14:03:30.548267+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.700332+01:00","closed_at":"2026-01-07T16:49:44.983259423Z","dependencies":[{"issue_id":"main-4cn","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.05294+01:00","created_by":"damir"}]}
{"id":"main-4fu","title":"Verify Studenac data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.481252333Z","created_by":"kasm-user","updated_at":"2026-01-09T08:09:57.349643026Z","closed_at":"2026-01-09T08:09:57.349643026Z","close_reason":"Verified: Metro (13,092 rows, 0 errors), Studenac (2 rows, 0 errors)"}
{"id":"main-4mn","title":"Price Tracking DB Schema \u0026 Ingestion Pipeline","description":"Add grocery price tracking with chains, stores, retailer items, and prices. Pipeline runnable from CLI and Cloudflare Workers with Queue fanout. Covers 11 retail chains with CSV/XML/XLSX parsing.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-29T19:43:40.877298+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.954281+01:00","closed_at":"2025-12-30T15:36:50.104998569Z"}
{"id":"main-4mn.1","title":"Add price tracking tables to schema.ts","description":"Add 14 new tables to src/db/schema.ts:\n- Retail World: chains, stores, store_identifiers, retailer_items, retailer_item_barcodes\n- Canonical Catalog: products, product_aliases, product_links, product_relations\n- Prices: store_item_state, store_item_price_periods\n- Ingestion: ingestion_runs, ingestion_files, ingestion_file_entries, ingestion_errors\n\nKey features:\n- chains: text PK slug (konzum, lidl, etc.)\n- store_identifiers: handle filename codes, portal IDs\n- retailer_item_barcodes: many-to-one for Lidl case\n- store_item_state: price_signature for dedup\n- store_item_price_periods: history only on change","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T19:44:02.541685+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.956337+01:00","closed_at":"2025-12-30T11:31:42.309531329Z","labels":["phase1","schema"],"dependencies":[{"issue_id":"main-4mn.1","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:02.54488+01:00","created_by":"daemon"},{"issue_id":"main-4mn.1","depends_on_id":"main-4mn.34","type":"blocks","created_at":"2025-12-29T19:48:20.860347+01:00","created_by":"daemon"}]}
{"id":"main-4mn.10","title":"Create XLSX parser","description":"Create src/ingestion/parsers/xlsx.ts:\n- Use xlsx library\n- Handle DM national file format\n- Map columns to NormalizedRow","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:03.129997+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.957179+01:00","closed_at":"2025-12-30T14:26:04.343217332Z","labels":["parsers","phase3"],"dependencies":[{"issue_id":"main-4mn.10","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:03.132137+01:00","created_by":"daemon"},{"issue_id":"main-4mn.10","depends_on_id":"main-4mn.7","type":"blocks","created_at":"2025-12-29T19:48:01.295495+01:00","created_by":"daemon"}]}
{"id":"main-4mn.11","title":"Create chain adapter registry","description":"Create src/ingestion/chains/index.ts:\n- Registry mapping chain_id → adapter\n- Chain config (URLs, formats, delimiters)\n- getAdapter(chain_id) function","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:28.501618+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.957979+01:00","closed_at":"2025-12-30T14:21:12.591187838Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.11","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:28.503709+01:00","created_by":"daemon"},{"issue_id":"main-4mn.11","depends_on_id":"main-4mn.3","type":"blocks","created_at":"2025-12-29T19:48:03.147307+01:00","created_by":"daemon"},{"issue_id":"main-4mn.11","depends_on_id":"main-4mn.7","type":"blocks","created_at":"2025-12-29T19:48:03.182901+01:00","created_by":"daemon"}]}
{"id":"main-4mn.12","title":"Implement Konzum chain adapter","description":"Create src/ingestion/chains/konzum.ts:\n- Format: CSV, delimiter: comma\n- Store resolution: filename (address + store ID)\n- Column mapping specific to Konzum format","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:29.343418+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.958693+01:00","closed_at":"2025-12-30T14:30:52.222403391Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.12","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:29.345437+01:00","created_by":"daemon"},{"issue_id":"main-4mn.12","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.388851+01:00","created_by":"daemon"}]}
{"id":"main-4mn.13","title":"Implement Lidl chain adapter","description":"Create src/ingestion/chains/lidl.ts:\n- Format: CSV, delimiter: comma\n- Store resolution: filename (daily ZIP → fanout)\n- Handle multiple GTINs per SKU\n- Column mapping specific to Lidl format","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:31.90735+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.959607+01:00","closed_at":"2025-12-30T14:36:33.779692922Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.13","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:31.909688+01:00","created_by":"daemon"},{"issue_id":"main-4mn.13","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.430367+01:00","created_by":"daemon"}]}
{"id":"main-4mn.14","title":"Implement Plodine chain adapter","description":"Create src/ingestion/chains/plodine.ts:\n- Format: CSV, delimiter: semicolon\n- Store resolution: filename\n- Handle ,69 decimal format (missing leading zero)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:32.78086+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.96026+01:00","closed_at":"2025-12-30T14:40:53.885056662Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.14","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:32.783305+01:00","created_by":"daemon"},{"issue_id":"main-4mn.14","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.467815+01:00","created_by":"daemon"}]}
{"id":"main-4mn.15","title":"Implement Interspar chain adapter","description":"Create src/ingestion/chains/interspar.ts:\n- Format: CSV, delimiter: semicolon\n- Store resolution: filename","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:34.198416+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.960982+01:00","closed_at":"2025-12-30T14:46:20.091500256Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.15","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:34.201028+01:00","created_by":"daemon"},{"issue_id":"main-4mn.15","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.502637+01:00","created_by":"daemon"}]}
{"id":"main-4mn.16","title":"Implement Studenac chain adapter","description":"Create src/ingestion/chains/studenac.ts:\n- Format: XML\n- Store resolution: XML content (store block inside)\n- Parse store info from within XML structure","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:35.136978+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.961648+01:00","closed_at":"2025-12-30T14:50:36.192536706Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.16","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:35.139865+01:00","created_by":"daemon"},{"issue_id":"main-4mn.16","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.536656+01:00","created_by":"daemon"}]}
{"id":"main-4mn.17","title":"Implement Kaufland chain adapter","description":"Create src/ingestion/chains/kaufland.ts:\n- Format: CSV, delimiter: tab\n- Store resolution: filename","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:47.687201+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.962293+01:00","closed_at":"2025-12-30T14:54:44.521161494Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.17","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:47.689059+01:00","created_by":"daemon"},{"issue_id":"main-4mn.17","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.571112+01:00","created_by":"daemon"}]}
{"id":"main-4mn.18","title":"Implement Eurospin chain adapter","description":"Create src/ingestion/chains/eurospin.ts:\n- Format: CSV, delimiter: semicolon\n- Store resolution: filename","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:49.052502+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.962922+01:00","closed_at":"2025-12-30T15:00:37.146431965Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.18","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:49.054628+01:00","created_by":"daemon"},{"issue_id":"main-4mn.18","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.60454+01:00","created_by":"daemon"}]}
{"id":"main-4mn.19","title":"Implement DM chain adapter","description":"Create src/ingestion/chains/dm.ts:\n- Format: XLSX\n- Store resolution: single national file (all stores)\n- Parse Excel structure","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:50.30759+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.963565+01:00","closed_at":"2025-12-30T15:00:37.154120155Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.19","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:50.30982+01:00","created_by":"daemon"},{"issue_id":"main-4mn.19","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.639809+01:00","created_by":"daemon"}]}
{"id":"main-4mn.2","title":"Generate Drizzle migration for price tracking","description":"Run drizzle-kit generate to create migration for the new price tracking tables.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T19:44:03.982069+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.964196+01:00","closed_at":"2025-12-30T12:02:34.076178986Z","labels":["phase1","schema"],"dependencies":[{"issue_id":"main-4mn.2","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:03.985166+01:00","created_by":"daemon"},{"issue_id":"main-4mn.2","depends_on_id":"main-4mn.1","type":"blocks","created_at":"2025-12-29T19:47:47.748724+01:00","created_by":"daemon"}]}
{"id":"main-4mn.20","title":"Implement KTC chain adapter","description":"Create src/ingestion/chains/ktc.ts:\n- Format: CSV, delimiter: semicolon\n- Store resolution: filename","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:51.350841+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.964859+01:00","closed_at":"2025-12-30T15:00:37.155974107Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.20","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:51.353314+01:00","created_by":"daemon"},{"issue_id":"main-4mn.20","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.674216+01:00","created_by":"daemon"}]}
{"id":"main-4mn.21","title":"Implement Metro chain adapter","description":"Create src/ingestion/chains/metro.ts:\n- Format: CSV, delimiter: comma\n- Store resolution: filename","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:52.52463+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.965518+01:00","closed_at":"2025-12-30T15:00:37.157571388Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.21","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:52.526794+01:00","created_by":"daemon"},{"issue_id":"main-4mn.21","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.70854+01:00","created_by":"daemon"}]}
{"id":"main-4mn.22","title":"Implement Trgocentar chain adapter","description":"Create src/ingestion/chains/trgocentar.ts:\n- Format: XML\n- Store resolution: filename + XML\n- Parse XML structure","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:54.365347+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.96616+01:00","closed_at":"2025-12-30T15:00:37.159138376Z","labels":["chains","phase4"],"dependencies":[{"issue_id":"main-4mn.22","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:54.367923+01:00","created_by":"daemon"},{"issue_id":"main-4mn.22","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.743861+01:00","created_by":"daemon"}]}
{"id":"main-4mn.23","title":"Create discover CLI command","description":"Create src/ingestion/cli/discover.ts:\n- List artifacts for chain+date\n- Usage: npx tsx src/ingestion/cli/discover.ts -c konzum -d 2025-12-29\n- Return URLs or paths of available files","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:19.177629+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.966797+01:00","closed_at":"2025-12-30T15:08:13.970096594Z","labels":["cli","phase5"],"dependencies":[{"issue_id":"main-4mn.23","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:19.17971+01:00","created_by":"daemon"},{"issue_id":"main-4mn.23","depends_on_id":"main-4mn.6","type":"blocks","created_at":"2025-12-29T19:48:15.256344+01:00","created_by":"daemon"},{"issue_id":"main-4mn.23","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:15.291579+01:00","created_by":"daemon"}]}
{"id":"main-4mn.24","title":"Create fetch CLI command","description":"Create src/ingestion/cli/fetch.ts:\n- Download + record ingestion_files\n- Usage: npx tsx src/ingestion/cli/fetch.ts -c konzum -u \u003curl_or_path\u003e\n- Store to R2/FS, compute SHA256","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:20.295853+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.967446+01:00","closed_at":"2025-12-30T15:08:13.991374439Z","labels":["cli","phase5"],"dependencies":[{"issue_id":"main-4mn.24","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:20.298066+01:00","created_by":"daemon"},{"issue_id":"main-4mn.24","depends_on_id":"main-4mn.6","type":"blocks","created_at":"2025-12-29T19:48:15.325642+01:00","created_by":"daemon"},{"issue_id":"main-4mn.24","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:15.359249+01:00","created_by":"daemon"}]}
{"id":"main-4mn.25","title":"Create expand CLI command","description":"Create src/ingestion/cli/expand.ts:\n- ZIP → entries\n- Usage: npx tsx src/ingestion/cli/expand.ts -f ingestion_file_id\n- Record ingestion_file_entries","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:21.302574+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.968119+01:00","closed_at":"2025-12-30T15:08:13.994040743Z","labels":["cli","phase5"],"dependencies":[{"issue_id":"main-4mn.25","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:21.305192+01:00","created_by":"daemon"},{"issue_id":"main-4mn.25","depends_on_id":"main-4mn.6","type":"blocks","created_at":"2025-12-29T19:48:15.393621+01:00","created_by":"daemon"},{"issue_id":"main-4mn.25","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:15.428546+01:00","created_by":"daemon"}]}
{"id":"main-4mn.26","title":"Create parse CLI command","description":"Create src/ingestion/cli/parse.ts:\n- Parse one file/entry\n- Usage: npx tsx src/ingestion/cli/parse.ts -c konzum -f \u003cpath\u003e\n- Use appropriate parser (CSV/XML/XLSX)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:22.700953+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.968777+01:00","closed_at":"2025-12-30T15:08:13.996537837Z","labels":["cli","phase5"],"dependencies":[{"issue_id":"main-4mn.26","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:22.703375+01:00","created_by":"daemon"},{"issue_id":"main-4mn.26","depends_on_id":"main-4mn.6","type":"blocks","created_at":"2025-12-29T19:48:15.462037+01:00","created_by":"daemon"},{"issue_id":"main-4mn.26","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:15.495373+01:00","created_by":"daemon"}]}
{"id":"main-4mn.27","title":"Create run CLI command (end-to-end)","description":"Create src/ingestion/cli/run.ts:\n- End-to-end for chain/date\n- Usage: npx tsx src/ingestion/cli/run.ts -c konzum -d 2025-12-29 [--store \u003cstore_id\u003e]\n- Support --dry-run flag\n- Orchestrate discover → fetch → expand → parse → persist","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:24.87748+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.969426+01:00","closed_at":"2025-12-30T15:08:13.998622972Z","labels":["cli","phase5"],"dependencies":[{"issue_id":"main-4mn.27","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:24.880002+01:00","created_by":"daemon"},{"issue_id":"main-4mn.27","depends_on_id":"main-4mn.6","type":"blocks","created_at":"2025-12-29T19:48:15.52855+01:00","created_by":"daemon"},{"issue_id":"main-4mn.27","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:15.561245+01:00","created_by":"daemon"}]}
{"id":"main-4mn.28","title":"Test each chain with sample data","description":"Test each chain adapter with sample data from ../data/sample/:\n- Verify parsing of all 11 chains\n- Check column mapping correctness\n- Validate NormalizedRow output","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:45.95908+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.970043+01:00","closed_at":"2025-12-30T15:22:10.670378951Z","labels":["phase6","testing"],"dependencies":[{"issue_id":"main-4mn.28","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:45.962074+01:00","created_by":"daemon"},{"issue_id":"main-4mn.28","depends_on_id":"main-4mn.27","type":"blocks","created_at":"2025-12-29T19:48:16.934603+01:00","created_by":"daemon"}]}
{"id":"main-4mn.29","title":"Verify price signature deduplication","description":"Test price_signature dedup logic:\n- Run same data twice\n- Verify no duplicate price_periods created\n- Verify last_seen_ts updated on second run\n- Verify new period created only on actual change","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:47.576289+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.970958+01:00","closed_at":"2025-12-30T15:22:10.680333156Z","labels":["phase6","testing"],"dependencies":[{"issue_id":"main-4mn.29","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:47.578468+01:00","created_by":"daemon"},{"issue_id":"main-4mn.29","depends_on_id":"main-4mn.27","type":"blocks","created_at":"2025-12-29T19:48:16.96941+01:00","created_by":"daemon"}]}
{"id":"main-4mn.3","title":"Create ingestion core types","description":"Create src/ingestion/core/types.ts with shared interfaces:\n- NormalizedRow: parsed row with prices, barcodes, quantities\n- StoreDescriptor: resolved store info\n- ChainAdapter interface\n- QueueMessage types for Cloudflare","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:28.391652+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.971749+01:00","closed_at":"2025-12-30T12:05:40.753171105Z","labels":["core","phase2"],"dependencies":[{"issue_id":"main-4mn.3","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:28.393798+01:00","created_by":"daemon"},{"issue_id":"main-4mn.3","depends_on_id":"main-4mn.1","type":"blocks","created_at":"2025-12-29T19:47:50.078824+01:00","created_by":"daemon"}]}
{"id":"main-4mn.30","title":"Verify store resolution","description":"Test store resolution strategy:\n- Filename-first resolution\n- Registry lookup fallback\n- Unresolved fallback with store_identifiers(kind='unresolved')\n- Test across different chain formats","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:48.93219+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.972409+01:00","closed_at":"2025-12-30T15:22:10.682119508Z","labels":["phase6","testing"],"dependencies":[{"issue_id":"main-4mn.30","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:48.934658+01:00","created_by":"daemon"},{"issue_id":"main-4mn.30","depends_on_id":"main-4mn.27","type":"blocks","created_at":"2025-12-29T19:48:17.003823+01:00","created_by":"daemon"}]}
{"id":"main-4mn.31","title":"Create Cloudflare Worker for ingestion","description":"Create src/ingestion/worker.ts:\n- Queue consumer for parse_entry messages\n- Cron scheduled handler for discover+fetch\n- Handle QueueMessage types:\n  - expand_zip: run_id, file_id\n  - parse_entry: run_id, entry_id, chain_id\n- Batch parse + persist","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:47:14.32944+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.973043+01:00","closed_at":"2025-12-30T15:22:10.683669571Z","labels":["cloudflare","phase7"],"dependencies":[{"issue_id":"main-4mn.31","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:47:14.332271+01:00","created_by":"daemon"},{"issue_id":"main-4mn.31","depends_on_id":"main-4mn.6","type":"blocks","created_at":"2025-12-29T19:48:17.979169+01:00","created_by":"daemon"},{"issue_id":"main-4mn.31","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:18.013409+01:00","created_by":"daemon"}]}
{"id":"main-4mn.32","title":"Update wrangler.jsonc for Queue and R2","description":"Update wrangler.jsonc:\n- Add queue producer: INGESTION_QUEUE → price-ingestion\n- Add queue consumer: max_batch_size: 10, max_retries: 3\n- Add R2 bucket: DATA_BUCKET → kosarica-data\n- Configure cron triggers","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:47:16.607282+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.973679+01:00","closed_at":"2025-12-30T15:36:31.7439163Z","labels":["cloudflare","phase7"],"dependencies":[{"issue_id":"main-4mn.32","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:47:16.609488+01:00","created_by":"daemon"},{"issue_id":"main-4mn.32","depends_on_id":"main-4mn.31","type":"blocks","created_at":"2025-12-29T19:48:18.048271+01:00","created_by":"daemon"}]}
{"id":"main-4mn.33","title":"Test ZIP fanout with Queue","description":"Test Cloudflare Queue fanout:\n- ZIP with multiple entries\n- Verify entries enqueued as parse_entry messages\n- Verify parallel processing\n- Check backpressure and retry behavior","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:47:17.826935+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.974288+01:00","closed_at":"2025-12-30T15:36:31.748570839Z","labels":["cloudflare","phase7"],"dependencies":[{"issue_id":"main-4mn.33","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:47:17.829296+01:00","created_by":"daemon"},{"issue_id":"main-4mn.33","depends_on_id":"main-4mn.31","type":"blocks","created_at":"2025-12-29T19:48:18.082775+01:00","created_by":"daemon"}]}
{"id":"main-4mn.34","title":"Add npm dependencies for ingestion","description":"Update package.json with new dependencies:\n- fast-xml-parser (XML parsing)\n- xlsx (XLSX parsing)\n- adm-zip (ZIP extraction)\n- iconv-lite (encoding conversion)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T19:47:26.014527+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.974877+01:00","closed_at":"2025-12-30T11:15:38.020455527Z","labels":["phase1","setup"],"dependencies":[{"issue_id":"main-4mn.34","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:47:26.017634+01:00","created_by":"daemon"}]}
{"id":"main-4mn.4","title":"Create storage abstraction","description":"Create src/ingestion/core/storage.ts:\n- Abstraction over local FS and Cloudflare R2\n- Store/retrieve files by key\n- Compute SHA256 for dedup","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:29.826339+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.975466+01:00","closed_at":"2025-12-30T13:32:06.465553487Z","labels":["core","phase2"],"dependencies":[{"issue_id":"main-4mn.4","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:29.829083+01:00","created_by":"daemon"},{"issue_id":"main-4mn.4","depends_on_id":"main-4mn.1","type":"blocks","created_at":"2025-12-29T19:47:50.126383+01:00","created_by":"daemon"}]}
{"id":"main-4mn.5","title":"Create normalization utilities","description":"Create src/ingestion/core/normalize.ts:\n- Decimal styles: 3,69 → 3.69, ,69 → 0.69\n- Quantity formats: '315 G' → {value: 315, unit: 'G'}\n- Pack notation: '6x500ml' → {pack_count: 6, pack_unit_value: 500, pack_unit_unit: 'ML'}\n- Barcode cleanup: remove spaces, quotes, Excel quoting","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:31.003811+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.976058+01:00","closed_at":"2025-12-30T13:36:42.944104901Z","labels":["core","phase2"],"dependencies":[{"issue_id":"main-4mn.5","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:31.006331+01:00","created_by":"daemon"},{"issue_id":"main-4mn.5","depends_on_id":"main-4mn.1","type":"blocks","created_at":"2025-12-29T19:47:50.165985+01:00","created_by":"daemon"}]}
{"id":"main-4mn.6","title":"Create persist module with signature dedup","description":"Create src/ingestion/core/persist.ts:\n- Upsert stores, retailer_items, retailer_item_barcodes\n- Compute price_signature hash\n- If signature unchanged: update last_seen_ts only\n- If signature changed: close old period, open new period\n- Insert to store_item_price_periods only on change","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:32.544076+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.976638+01:00","closed_at":"2025-12-30T13:44:07.709663089Z","labels":["core","phase2"],"dependencies":[{"issue_id":"main-4mn.6","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:32.547218+01:00","created_by":"daemon"},{"issue_id":"main-4mn.6","depends_on_id":"main-4mn.1","type":"blocks","created_at":"2025-12-29T19:47:50.201372+01:00","created_by":"daemon"},{"issue_id":"main-4mn.6","depends_on_id":"main-4mn.3","type":"blocks","created_at":"2025-12-29T19:47:51.708077+01:00","created_by":"daemon"}]}
{"id":"main-4mn.7","title":"Create base parser interface","description":"Create src/ingestion/parsers/base.ts:\n- Abstract Parser class/interface\n- parse(content: Buffer, options: ParseOptions) → NormalizedRow[]\n- Common error handling","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:56.55452+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.977168+01:00","closed_at":"2025-12-30T13:48:18.9336486Z","labels":["parsers","phase3"],"dependencies":[{"issue_id":"main-4mn.7","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:56.557012+01:00","created_by":"daemon"},{"issue_id":"main-4mn.7","depends_on_id":"main-4mn.3","type":"blocks","created_at":"2025-12-29T19:48:01.184795+01:00","created_by":"daemon"}]}
{"id":"main-4mn.8","title":"Create CSV parser","description":"Create src/ingestion/parsers/csv.ts:\n- Configurable delimiter (comma, semicolon, tab)\n- Handle different encodings (utf-8, windows-1250)\n- Return NormalizedRow[]","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:58.042047+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.977659+01:00","closed_at":"2025-12-30T14:03:35.954062838Z","labels":["parsers","phase3"],"dependencies":[{"issue_id":"main-4mn.8","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:58.044236+01:00","created_by":"daemon"},{"issue_id":"main-4mn.8","depends_on_id":"main-4mn.7","type":"blocks","created_at":"2025-12-29T19:48:01.225085+01:00","created_by":"daemon"}]}
{"id":"main-4mn.9","title":"Create XML parser","description":"Create src/ingestion/parsers/xml.ts:\n- Use fast-xml-parser\n- Handle Studenac/Trgocentar XML formats\n- Extract store blocks from XML content","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:58.983067+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.978133+01:00","closed_at":"2025-12-30T14:10:10.211549429Z","labels":["parsers","phase3"],"dependencies":[{"issue_id":"main-4mn.9","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:58.985332+01:00","created_by":"daemon"},{"issue_id":"main-4mn.9","depends_on_id":"main-4mn.7","type":"blocks","created_at":"2025-12-29T19:48:01.262345+01:00","created_by":"daemon"}]}
{"id":"main-4we","title":"Wrap persistRows in database transaction for atomicity","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T16:02:58.591061325Z","created_by":"kasm-user","updated_at":"2026-01-01T16:45:26.757355793Z","closed_at":"2026-01-01T16:45:26.757355793Z","close_reason":"Cannot implement: Cloudflare D1 does not support multi-statement transactions. Wrapping persistRows in a transaction would only work for BetterSQLite3 (CLI) but not for D1 (production), creating an environment inconsistency.","labels":["database","reliability"]}
{"id":"main-5fm","title":"Another Test [feature, P1]","description":"Description with priority and type","acceptance_criteria":"- [ ] Test criterion","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-29T19:42:59.659742+01:00","updated_at":"2025-12-29T19:43:07.652074+01:00","deleted_at":"2025-12-29T19:43:07.652074+01:00","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"main-67u","title":"Schema: Add ingestion_chunks + store_enrichment_tasks tables","description":"Add new tables and modify existing:\n\n## New Tables\n\n### ingestion_chunks\n- id, file_id, chunk_index, start_row, end_row, row_count\n- status (pending|processing|completed|failed)\n- r2_key for chunk JSON location\n- persisted_count, error_count\n\n### store_enrichment_tasks\n- id, store_id, type (geocode|verify_address|ai_categorize)\n- status, input_data, output_data, confidence\n- verified_by, verified_at\n\n## Modify Existing\n- ingestion_files: add total_chunks, processed_chunks, chunk_size\n- ingestion_runs: add parent_run_id, rerun_type, rerun_target_id\n- ingestion_errors: add chunk_id FK","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-09T14:32:30.659786226Z","created_by":"kasm-user","updated_at":"2026-01-09T14:44:11.075268122Z","closed_at":"2026-01-09T14:44:11.075268122Z","close_reason":"Implemented schema changes: ingestion_chunks, store_enrichment_tasks tables, and modifications to ingestion_files, ingestion_runs, ingestion_errors. Migration 0008_thin_the_leader.sql generated.","dependencies":[{"issue_id":"main-67u","depends_on_id":"main-gmv","type":"parent-child","created_at":"2026-01-09T14:33:35.047075011Z","created_by":"kasm-user"}]}
{"id":"main-6ta","title":"Update Kaufland adapter for price transparency fields","description":"Map: cijena jed.mj.(EUR), Najniža MPC u 30dana, Sidrena cijena. Also map unitPriceBaseQuantity from kol.jed.mj. and unitPriceBaseUnit from jed.mj. (1 KOM/L/KG). Source: https://www.kaufland.hr/akcije-novosti/popis-mpc.html","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:13.649972+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.70121+01:00","closed_at":"2026-01-07T19:48:10.20510347Z","dependencies":[{"issue_id":"main-6ta","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:35.674319+01:00","created_by":"damir"},{"issue_id":"main-6ta","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.325156+01:00","created_by":"damir"}]}
{"id":"main-7ie","title":"Update Interspar adapter for price transparency fields","description":"Map: cijena za jedinicu mjere (EUR), Najniža cijena u posljednjih 30 dana (EUR), sidrena cijena na 2.5.2025. (EUR). Set anchorPriceAsOf=2025-05-02. Source: https://www.spar.hr/usluge/cjenici","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:58.214057+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.701802+01:00","closed_at":"2026-01-07T19:48:10.203760173Z","dependencies":[{"issue_id":"main-7ie","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:35.522916+01:00","created_by":"damir"},{"issue_id":"main-7ie","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.175998+01:00","created_by":"damir"}]}
{"id":"main-951","title":"explore removeing BetterSQLite3 and using vitest/wrangler settup for testing, not node https://developers.cloudflare.com/workers/development-testing/ https://developers.cloudflare.com/workers/vite-plugin/","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T16:31:36.87966588Z","updated_at":"2026-01-06T14:03:03.721412+01:00","closed_at":"2026-01-06T14:03:03.721412+01:00","close_reason":"Implemented in commit a5b684a - removed BetterSQLite3, migrated to Cloudflare vitest-pool-workers testing"}
{"id":"main-acl","title":"Use chunked parsing for large files to prevent CPU timeout","status":"open","priority":1,"issue_type":"bug","created_at":"2026-01-16T16:19:13.039086+01:00","created_by":"damir","updated_at":"2026-01-16T16:19:13.039086+01:00","comments":[{"id":11,"issue_id":"main-acl","author":"damir","text":"## Problem\nQueue messages for parsing large CSV/XML files are being \"Canceled\" because the parse+persist operation exceeds the Cloudflare Workers 30-second CPU time limit. Files with 6,000-11,000+ entries fail consistently.\n\n## Root Cause Analysis\n1. `handleFetch` always sends `parse` messages, never `parse_chunked`\n2. `handleParse` tries to persist ALL rows in one transaction\n3. Files with thousands of entries cause the persist operation to timeout\n4. The worker is killed and the message is \"Canceled\"\n\n## Current Flow (Broken)\n```\ndiscover → fetch → parse → persist ALL rows at once → TIMEOUT\n```\n\n## Desired Flow (Fixed)\n```\ndiscover → fetch → parse_chunked → persist_chunk (x N) → complete\n```\n\n## Files Affected\n- `/src/ingestion/worker.ts` - `handleFetch` function (lines ~262-328)\n\n## Implementation\nChange `handleFetch` to always use `parse_chunked` instead of `parse`:\n\n1. In `handleFetch`, replace the `ParseQueueMessage` with `ParseChunkedQueueMessage`\n2. Add a reasonable chunk size (e.g., 500-1000 rows per chunk)\n3. The existing `handleParseChunked` already handles:\n   - Parsing the full file\n   - Splitting rows into chunks\n   - Storing chunks in R2\n   - Enqueueing `persist_chunk` messages\n   - Updating file and run status\n\n## Chunk Size Considerations\n- 500 rows: Safe, ~60 persist_chunk messages for a 30K row file\n- 1000 rows: Good balance, ~30 messages for 30K rows\n- The persist operation for 1000 rows should complete well under 30s\n\n## Testing\n1. Trigger ingestion for konzum chain\n2. Verify files complete instead of getting stuck in \"processing\"\n3. Check `ingestion_chunks` table has entries\n4. Verify run completes with processed_files \u003e 0\n","created_at":"2026-01-16T15:19:31Z"}]}
{"id":"main-b3i","title":"UI: Ingestion Dashboard","description":"Create /_admin/admin/ingestion route with drill-down\n\n## Features\n- Stats cards: runs today, files processed, errors, rows ingested\n- Run list with status badges and progress bars\n- Click run -\u003e files list\n- Click file -\u003e chunks list\n- Re-run buttons at each level\n- Error categorization view\n\n## Routes\n- /_admin/admin/ingestion - dashboard + run list\n- /_admin/admin/ingestion/$runId - run detail with files\n- /_admin/admin/ingestion/$runId/$fileId - file detail with chunks\n\n## Components\n- IngestionStatsCards.tsx - metrics overview\n- IngestionRunList.tsx - table of runs\n- IngestionRunCard.tsx - run with progress bar\n- IngestionFileList.tsx - files in a run\n- IngestionChunkList.tsx - chunks in a file\n- IngestionErrorList.tsx - errors with filters\n- RerunButton.tsx - trigger re-run\n- ProgressBar.tsx - visual progress\n\n## Files\n- src/routes/_admin.admin.ingestion.tsx\n- src/routes/_admin.admin.ingestion.$runId.tsx\n- src/routes/_admin.admin.ingestion.$runId.$fileId.tsx\n- src/components/admin/ingestion/*.tsx","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T14:33:04.967391989Z","created_by":"kasm-user","updated_at":"2026-01-09T19:01:21.817388582Z","closed_at":"2026-01-09T19:01:21.817388582Z","close_reason":"Implemented all UI components and routes","dependencies":[{"issue_id":"main-b3i","depends_on_id":"main-gmv","type":"parent-child","created_at":"2026-01-09T14:33:40.335719107Z","created_by":"kasm-user"},{"issue_id":"main-b3i","depends_on_id":"main-tvx","type":"blocks","created_at":"2026-01-09T14:33:55.349627013Z","created_by":"kasm-user"}]}
{"id":"main-b4a","title":"UI: Pending Store Approval page","description":"Create /_admin/admin/stores/pending route\n\n## UI Sketch\n```\n[PAGE: EXCEPTIONS \u003e PENDING STORES]\n\n+-----------------------------------------------------------------------------------+\n|  PENDING STORES (Action Required)                                                 |\n+-----------------------------------------------------------------------------------+\n|                                                                                   |\n|  [1] New Store Detected: \"DM_Summer_Promo\"                                        |\n|      Source File: dm_summer_prices.csv                                            |\n|      Detected Chain: DM                                                           |\n|                                                                                   |\n|  [ DECISION REQUIRED ]                                                            |\n|                                                                                   |\n|  Option A: [ APPROVE AS NEW PRICE SOURCE ]                                        |\n|  \"This is a distinct set of prices (e.g. specific region or web-only).\"           |\n|  -\u003e Creates Virtual Store \"DM_Summer_Promo\"                                       |\n|                                                                                   |\n|  Option B: [ MERGE INTO EXISTING SOURCE ]                                         |\n|  \"This file actually belongs to an existing price list.\"                          |\n|  -\u003e Map to: [ DM National Pricing v ]                                             |\n|                                                                                   |\n|  Option C: [ REJECT \u0026 BLOCK ]                                                     |\n|  \"This is garbage data.\"                                                          |\n|                                                                                   |\n+-----------------------------------------------------------------------------------+\n```\n\n## Components\n- PendingStoreInbox.tsx - list of pending stores\n- PendingStoreCard.tsx - card with 3 action buttons\n- StoreApprovalModal.tsx - confirm approve\n- StoreMergeModal.tsx - select target store\n- StoreRejectModal.tsx - confirm delete\n\n## Files\n- src/routes/_admin.admin.stores.pending.tsx\n- src/components/admin/stores/PendingStoreCard.tsx\n- src/components/admin/stores/StoreApprovalModal.tsx\n- src/components/admin/stores/StoreMergeModal.tsx","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T14:33:03.894279523Z","created_by":"kasm-user","updated_at":"2026-01-09T19:01:21.816432577Z","closed_at":"2026-01-09T19:01:21.816432577Z","close_reason":"Implemented all UI components and routes","dependencies":[{"issue_id":"main-b4a","depends_on_id":"main-gmv","type":"parent-child","created_at":"2026-01-09T14:33:40.128895142Z","created_by":"kasm-user"},{"issue_id":"main-b4a","depends_on_id":"main-g7b","type":"blocks","created_at":"2026-01-09T14:33:55.140201916Z","created_by":"kasm-user"}]}
{"id":"main-c46","title":"Verify Metro data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.430028489Z","created_by":"kasm-user","updated_at":"2026-01-09T08:09:57.346828705Z","closed_at":"2026-01-09T08:09:57.346828705Z","close_reason":"Verified: Metro (13,092 rows, 0 errors), Studenac (2 rows, 0 errors)"}
{"id":"main-c8x","title":"Update DM adapter for price transparency fields","description":"Map XLSX headers: Cijena za jedinicu mjere, Najniža cijena u posljednjih 30 dana prije rasprodaje, sidrena cijena na 2.5.2025. ili na datum ulistanja. Set anchorPriceAsOf=null due to ambiguous basis. Source: https://www.dm.hr/novo/promocije/nove-oznake-cijena-i-vazeci-cjenik-u-dm-u-2906632","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:21.355188+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.702413+01:00","closed_at":"2026-01-07T19:48:10.209244568Z","dependencies":[{"issue_id":"main-c8x","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:37.931888+01:00","created_by":"damir"},{"issue_id":"main-c8x","depends_on_id":"main-2u8","type":"blocks","created_at":"2026-01-06T14:05:01.589393+01:00","created_by":"damir"}]}
{"id":"main-ce0","title":"Verify chunked parsing works for XML files","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-16T16:19:43.961732+01:00","created_by":"damir","updated_at":"2026-01-16T16:19:43.961732+01:00","dependencies":[{"issue_id":"main-ce0","depends_on_id":"main-acl","type":"blocks","created_at":"2026-01-16T16:20:07.742582+01:00","created_by":"damir"}],"comments":[{"id":12,"issue_id":"main-ce0","author":"damir","text":"## Context\nThe chunked parsing fix (main-acl) changes handleFetch to use parse_chunked for all files. This affects CSV, XML, and XLSX files.\n\n## Why This Works for All File Types\nThe chunking happens AFTER parsing, not during:\n1. Full file is parsed into NormalizedRow[]\n2. Rows are split into chunks of N rows each\n3. Each chunk is persisted separately\n\nThis means:\n- CSV: Works naturally (rows are independent)\n- XML: Works because we parse to rows first, then chunk\n- XLSX: Works because we parse to rows first, then chunk\n\n## XML-Specific Considerations\nXML parsers typically load the entire document into memory, so there's no benefit to streaming. The current approach of:\n1. Parse entire XML → get all products\n2. Convert to NormalizedRow[]\n3. Chunk the rows\n4. Persist chunks\n\n...is already the correct approach for XML.\n\n## Verification Needed\n- [ ] Confirm XmlParser produces NormalizedRow[] compatible with chunking\n- [ ] Test with a chain that uses XML (e.g., check available chains)\n- [ ] Verify chunk persist works with XML-sourced rows\n\n## No Code Changes Required\nThis issue is informational - the chunked parsing fix will work for XML without modifications because chunking operates on NormalizedRow[] which is format-agnostic.\n","created_at":"2026-01-16T15:19:49Z"}]}
{"id":"main-ceq","title":"Fix unsafe non-null assertion on config.csv in chain adapters","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-01T16:02:35.278840052Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.460524921Z","closed_at":"2026-01-01T16:32:16.460524921Z","close_reason":"Implementation completed by subagents","labels":["bug"]}
{"id":"main-dy8","title":"CLI: Store management commands","description":"## Goal\nCLI commands to list, approve, reject pending stores.\n\n## New File\n**File**: `src/ingestion/cli/stores.ts`\n\n## Commands\n\n### List pending stores\n```bash\npnpm ingest stores --pending\n```\nOutput table:\n| ID | Chain | Name | Identifiers | Created |\n|----|-------|------|-------------|---------|\n\n### List all stores for chain\n```bash\npnpm ingest stores --chain=dm\n```\nOutput table:\n| ID | Name | Virtual | Status | Price Source | City |\n|----|------|---------|--------|--------------|------|\n\n### Approve store\n```bash\npnpm ingest stores --approve \u003cstore_id\u003e\n```\n- Sets status='active'\n- Outputs: \"Approved store: {name}\"\n\n### Reject/delete store\n```bash\npnpm ingest stores --reject \u003cstore_id\u003e\n```\n- Deletes store, store_identifiers, and any storeItemState records\n- Outputs: \"Rejected and deleted store: {name}\"\n\n### Show store details\n```bash\npnpm ingest stores --show \u003cstore_id\u003e\n```\n- Shows all store fields + identifiers + price count\n\n## Register Command\n**File**: `src/ingestion/cli/index.ts`\n\nAdd stores subcommand to CLI.\n\n## Implementation Notes\n- Use drizzle queries\n- Use console.table or similar for formatted output\n- Handle errors gracefully (store not found, etc.)\n\n## Verification\n1. Create pending store via ingestion\n2. `pnpm ingest stores --pending` → shows it\n3. `pnpm ingest stores --approve \u003cid\u003e` → status changes\n4. `pnpm ingest stores --chain=dm` → shows all DM stores","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T13:51:25.409990684Z","created_by":"kasm-user","updated_at":"2026-01-09T14:20:04.509052251Z","closed_at":"2026-01-09T14:20:04.509052251Z","close_reason":"Implemented in parallel agents","dependencies":[{"issue_id":"main-dy8","depends_on_id":"main-qsn","type":"blocks","created_at":"2026-01-09T13:52:05.119706152Z","created_by":"kasm-user"}]}
{"id":"main-e72","title":"Update Metro adapter for price transparency fields","description":"Map: CIJENA_PO_MJERI, NAJNIZA_30_DANA, SIDRENA_02_05. Note: current adapter is XML-only but sample is CSV - needs alignment. Set anchorPriceAsOf=2025-05-02. Source: https://metrocjenik.com.hr/","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:17.7726+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.703027+01:00","closed_at":"2026-01-07T19:48:10.207112394Z","dependencies":[{"issue_id":"main-e72","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:37.692227+01:00","created_by":"damir"},{"issue_id":"main-e72","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.46656+01:00","created_by":"damir"}]}
{"id":"main-edl","title":"Query: Price resolution follows priceSourceStoreId","description":"## Goal\nWhen querying prices for a physical store, follow priceSourceStoreId to get prices from virtual store.\n\n## New File\n**File**: `src/db/queries/stores.ts` (or add to existing queries file)\n\n## Helper Functions\n\n### Get effective price store ID\n```typescript\n/**\n * Returns the store ID to use for price lookups.\n * Physical stores return their priceSourceStoreId.\n * Virtual stores return their own ID.\n */\nexport function getEffectivePriceStoreId(store: { \n  id: string; \n  priceSourceStoreId: string | null \n}): string {\n  return store.priceSourceStoreId ?? store.id\n}\n```\n\n### Get store with resolved price source\n```typescript\n/**\n * Fetches store and its price source store (if different).\n */\nexport async function getStoreWithPriceSource(\n  db: AnyDatabase,\n  storeId: string\n): Promise\u003c{\n  store: Store;\n  priceStore: Store;\n  usesSharedPricing: boolean;\n} | null\u003e {\n  const store = await db.query.stores.findFirst({\n    where: eq(stores.id, storeId)\n  })\n  if (\\!store) return null\n\n  if (store.priceSourceStoreId) {\n    const priceStore = await db.query.stores.findFirst({\n      where: eq(stores.id, store.priceSourceStoreId)\n    })\n    return { \n      store, \n      priceStore: priceStore\\!, \n      usesSharedPricing: true \n    }\n  }\n\n  return { store, priceStore: store, usesSharedPricing: false }\n}\n```\n\n### Get prices for store (convenience)\n```typescript\n/**\n * Gets prices for a store, following priceSourceStoreId if set.\n */\nexport async function getPricesForStore(\n  db: AnyDatabase,\n  storeId: string,\n  options?: { limit?: number; retailerItemId?: string }\n): Promise\u003cStoreItemState[]\u003e {\n  const resolved = await getStoreWithPriceSource(db, storeId)\n  if (\\!resolved) return []\n\n  return db.query.storeItemState.findMany({\n    where: and(\n      eq(storeItemState.storeId, resolved.priceStore.id),\n      options?.retailerItemId \n        ? eq(storeItemState.retailerItemId, options.retailerItemId) \n        : undefined\n    ),\n    limit: options?.limit\n  })\n}\n```\n\n## Usage Pattern\nWhen building price API:\n```typescript\n// DON'T query directly with user's storeId\nconst prices = await db.query.storeItemState.findMany({\n  where: eq(storeItemState.storeId, requestedStoreId) // WRONG for physical stores\n})\n\n// DO use the helper\nconst prices = await getPricesForStore(db, requestedStoreId)\n```\n\n## Export\nAdd exports to `src/db/index.ts` or appropriate barrel file.\n\n## Verification\n1. Create virtual store with prices\n2. Create physical store linked to virtual\n3. Call `getPricesForStore(db, physicalStoreId)`\n4. Verify returns virtual store's prices","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T13:51:55.881949682Z","created_by":"kasm-user","updated_at":"2026-01-09T14:20:04.510073924Z","closed_at":"2026-01-09T14:20:04.510073924Z","close_reason":"Implemented in parallel agents","dependencies":[{"issue_id":"main-edl","depends_on_id":"main-qsn","type":"blocks","created_at":"2026-01-09T13:52:05.213817839Z","created_by":"kasm-user"}]}
{"id":"main-f24","title":"UI: Store Registry page","description":"Create /_admin/admin/stores route\n\n## UI Sketch\n```\n[PAGE: STORES \u0026 CHAINS]\n\n+-----------------------------------------------------------------------------------+\n|  Filter: [Chain: DM  v]  [Status: Active v]  [Type: All v]                        |\n+-----------------------------------------------------------------------------------+\n|                                                                                   |\n|  [ VIRTUAL PRICE SOURCES (Import Linked) ]                                        |\n|  These stores are created automatically by your ingestion pipeline.               |\n|                                                                                   |\n|  Name (Identifier)       | Status   | Last Import | Linked Physical Stores        |\n|  ------------------------|----------|-------------|-------------------------------|\n|  DM National Pricing     | ACTIVE   | 2h ago      | 142 Locations (Inheriting)    |\n|  DM Online Only          | ACTIVE   | 1d ago      | 0 Locations                   |\n|                                                                                   |\n|  -------------------------------------------------------------------------------  |\n|                                                                                   |\n|  [ PHYSICAL LOCATIONS ]                                                           |\n|  Real-world addresses. They inherit prices from a source or have their own.       |\n|  [+ Add Physical Location]                                                        |\n|                                                                                   |\n|  Store Name              | City     | Price Source          | Action              |\n|  ------------------------|----------|-----------------------|---------------------|\n|  DM Zadar - Supernova    | Zadar    | DM National Pricing   | [Edit] [Unlink]     |\n|  DM Zagreb - Ilica       | Zagreb   | DM National Pricing   | [Edit] [Unlink]     |\n|  DM Split - Centar       | Split    | NONE (No Prices)      | [Link Source]       |\n|                                                                                   |\n+-----------------------------------------------------------------------------------+\n```\n\n## Components\n- StoreTable.tsx - TanStack Table with virtual/physical sections\n- StoreFilters.tsx - chain, status, type dropdowns\n- VirtualStoreCard.tsx - show linked count badge\n\n## Files\n- src/routes/_admin.admin.stores.tsx\n- src/components/admin/stores/StoreTable.tsx\n- src/components/admin/stores/StoreFilters.tsx","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T14:33:00.080289253Z","created_by":"kasm-user","updated_at":"2026-01-09T15:32:52.003787138Z","closed_at":"2026-01-09T15:32:52.003787138Z","close_reason":"Implemented Store Registry page with two-section layout (Virtual Price Sources + Physical Locations), link/unlink modals, and enhanced API endpoints","dependencies":[{"issue_id":"main-f24","depends_on_id":"main-gmv","type":"parent-child","created_at":"2026-01-09T14:33:39.718735136Z","created_by":"kasm-user"},{"issue_id":"main-f24","depends_on_id":"main-g7b","type":"blocks","created_at":"2026-01-09T14:33:54.710404154Z","created_by":"kasm-user"}]}
{"id":"main-fgy","title":"Croatian Price Transparency Fields Import","description":"Persist Croatian price-transparency fields that retailers publish: unit price, lowest price in last 30 days, and anchor (sidrena) price. New fields: unitPriceCents, unitPriceBaseQuantity, unitPriceBaseUnit, lowestPrice30dCents, anchorPriceCents, anchorPriceAsOf. Covers all 11 retail chains.","status":"closed","priority":1,"issue_type":"epic","assignee":"damir","created_at":"2026-01-06T14:03:09.235155+01:00","created_by":"damir","updated_at":"2026-01-07T16:53:41.251704+01:00","closed_at":"2026-01-07T16:53:41.251704+01:00","close_reason":"Merged to main at a82e00b8","comments":[{"id":1,"issue_id":"main-fgy","author":"coordinator","text":"## Run Started\n\n- **Run ID**: run-20260106-200159-4d77cb\n- **Pod**: ade-pod-main-fgy\n- **Branch**: `beads/main-fgy-croatian-price-transparency-fields-import`\n- **Worktree**: `/Users/damir/dev/test/kosarica/main/main-fgy`\n- **Started**: 2026-01-06T20:01:59+01:00\n\n\u003e Coordinator is executing this bead...\n","created_at":"2026-01-06T19:01:59Z"},{"id":2,"issue_id":"main-fgy","author":"coordinator","text":"## Run Complete\n\n- **Run ID**: run-20260106-200159-4d77cb\n- **Pod**: ade-pod-main-fgy\n- **Branch**: `beads/main-fgy-croatian-price-transparency-fields-import`\n- **Worktree**: `/Users/damir/dev/test/kosarica/main/main-fgy`\n- **Exit Code**: 0\n- **Duration**: 23m30s\n- **Completed**: 2026-01-06T20:25:29+01:00\n\n✅ Worker completed successfully.\n","created_at":"2026-01-06T19:25:29Z"},{"id":3,"issue_id":"main-fgy","author":"coordinator","text":"## Run Started\n\n- **Run ID**: run-20260107-095854-048805\n- **Pod**: ade-pod-main-fgy\n- **Branch**: `beads/main-fgy-croatian-price-transparency-fields-import`\n- **Worktree**: `/Users/damir/dev/test/kosarica/main/main-fgy`\n- **Started**: 2026-01-07T09:58:55+01:00\n\n\u003e Coordinator is executing this bead...\n","created_at":"2026-01-07T08:58:55Z"},{"id":4,"issue_id":"main-fgy","author":"coordinator","text":"## Run Failed\n\n- **Run ID**: run-20260107-095854-048805\n- **Pod**: ade-pod-main-fgy\n- **Branch**: `beads/main-fgy-croatian-price-transparency-fields-import`\n- **Worktree**: `/Users/damir/dev/test/kosarica/main/main-fgy`\n- **Exit Code**: 1\n- **Duration**: 1s\n- **Failed**: 2026-01-07T09:58:56+01:00\n\n### Last Output\n\n```\n--dangerously-skip-permissions cannot be used with root/sudo privileges for security reasons\n\n```\n\n❌ Worker execution failed.\n\n**Next Action**: Review the output above and error details. Consider:\n- Checking pod logs for more context\n- Verifying environment setup in the pod\n- Reviewing the worker prompt and issue description\n- Retrying with updated configuration or prompt\n","created_at":"2026-01-07T08:58:56Z"},{"id":5,"issue_id":"main-fgy","author":"coordinator","text":"## Run Started\n\n- **Run ID**: run-20260107-100128-203356\n- **Pod**: ade-pod-main-fgy\n- **Branch**: `beads/main-fgy-croatian-price-transparency-fields-import`\n- **Worktree**: `/Users/damir/dev/test/kosarica/main/main-fgy`\n- **Started**: 2026-01-07T10:01:28+01:00\n\n\u003e Coordinator is executing this bead...\n","created_at":"2026-01-07T09:01:28Z"},{"id":6,"issue_id":"main-fgy","author":"coordinator","text":"## Run Complete\n\n- **Run ID**: run-20260107-100128-203356\n- **Pod**: ade-pod-main-fgy\n- **Branch**: `beads/main-fgy-croatian-price-transparency-fields-import`\n- **Worktree**: `/Users/damir/dev/test/kosarica/main/main-fgy`\n- **Exit Code**: 0\n- **Duration**: 12m4s\n- **Completed**: 2026-01-07T10:13:33+01:00\n\n✅ Worker completed successfully.\n","created_at":"2026-01-07T09:13:33Z"},{"id":7,"issue_id":"main-fgy","author":"coordinator","text":"## Finish Failed: Safety Check\n\n**Branch**: `beads/main-fgy-croatian-price-transparency-fields-import`\n**Worktree**: `/Users/damir/dev/test/kosarica/main/main-fgy`\n**Pod**: ade-pod-main-fgy\n**Failed At**: 2026-01-07T15:55:15+01:00\n\n### Safety Check Failed\n\n```\npod ade-pod-main-fgy is still running - worker must exit before merge\n```\n\n### Next Actions\n\nReview the safety check failure above. Common issues:\n\n- **Pod still running**: Stop the worker pod before finishing\n- **Uncommitted changes**: Commit or stash changes in the worktree\n- **Worker failed**: Fix the worker errors before merging\n\n❌ **Bead marked as blocked.** Manual intervention required.\n","created_at":"2026-01-07T14:55:15Z"},{"id":8,"issue_id":"main-fgy","author":"coordinator","text":"## Finish Failed: Safety Check\n\n**Branch**: `beads/main-fgy-croatian-price-transparency-fields-import`\n**Worktree**: `/Users/damir/dev/test/kosarica/main/main-fgy`\n**Pod**: ade-pod-main-fgy\n**Failed At**: 2026-01-07T16:00:15+01:00\n\n### Safety Check Failed\n\n```\npod ade-pod-main-fgy is still running - worker must exit before merge\n```\n\n### Next Actions\n\nReview the safety check failure above. Common issues:\n\n- **Pod still running**: Stop the worker pod before finishing\n- **Uncommitted changes**: Commit or stash changes in the worktree\n- **Worker failed**: Fix the worker errors before merging\n\n❌ **Bead marked as blocked.** Manual intervention required.\n","created_at":"2026-01-07T15:00:15Z"},{"id":9,"issue_id":"main-fgy","author":"coordinator","text":"## Finish Failed: Safety Check\n\n**Branch**: `beads/main-fgy-croatian-price-transparency-fields-import`\n**Worktree**: `/Users/damir/dev/test/kosarica/main/main-fgy`\n**Pod**: ade-pod-main-fgy\n**Failed At**: 2026-01-07T16:00:27+01:00\n\n### Safety Check Failed\n\n```\nworktree has uncommitted changes: uncommitted changes:\n?? .beads/redirect\n\n```\n\n### Next Actions\n\nReview the safety check failure above. Common issues:\n\n- **Pod still running**: Stop the worker pod before finishing\n- **Uncommitted changes**: Commit or stash changes in the worktree\n- **Worker failed**: Fix the worker errors before merging\n\n❌ **Bead marked as blocked.** Manual intervention required.\n","created_at":"2026-01-07T15:00:27Z"},{"id":10,"issue_id":"main-fgy","author":"coordinator","text":"## Merge Complete\n\n- **Merge Method**: direct\n- **Merged Commit**: a82e00b8ac8fe4779ff5ea486d6f5b19c93262a4\n- **Branch**: `beads/main-fgy-croatian-price-transparency-fields-import`\n- **Target**: main\n- **PR URL**: N/A\n- **Merged At**: 2026-01-07T16:53:41+01:00\n\n### Verification Summary\n\n- **Tests**: skipped\n- **Build**: N/A\n- **Linters**: N/A\n\n✅ Changes merged successfully.\n","created_at":"2026-01-07T15:53:41Z"}]}
{"id":"main-fmf","title":"Update Studenac adapter for price transparency fields","description":"Map XML tags: \u003cCijenaZaJedinicuMjere\u003e, \u003cNajnizaCijena\u003e, \u003cSidrenaCijena\u003e. Source: https://www.studenac.hr/popis-maloprodajnih-cijena","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:19.042893+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.703821+01:00","closed_at":"2026-01-07T19:48:10.207895688Z","dependencies":[{"issue_id":"main-fmf","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:37.771851+01:00","created_by":"damir"},{"issue_id":"main-fmf","depends_on_id":"main-19a","type":"blocks","created_at":"2026-01-06T14:05:02.784197+01:00","created_by":"damir"}]}
{"id":"main-fyt","title":"Centralize adapter registration to avoid duplicate code","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T16:02:47.471991465Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.470762624Z","closed_at":"2026-01-01T16:32:16.470762624Z","close_reason":"Implementation completed by subagents","labels":["refactor","tech-debt"]}
{"id":"main-g53","title":"Optimize persistRows with batch insert operations","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T16:03:00.623470061Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.471858382Z","closed_at":"2026-01-01T16:32:16.471858382Z","close_reason":"Implementation completed by subagents","labels":["database","performance"]}
{"id":"main-g7b","title":"API: Store management endpoints","description":"Create src/orpc/router/stores.ts\n\n## Endpoints\n- list: chainSlug?, status?, isVirtual?, search?, page\n- get: storeId\n- update: storeId, name?, address?, city?, lat?, lng?\n- approve: storeId (pending → active)\n- reject: storeId (delete)\n- merge: sourceStoreId, targetStoreId\n- linkPriceSource: storeId, priceSourceStoreId\n- unlinkPriceSource: storeId\n- getPending: chainSlug?\n- getLinkedPhysical: virtualStoreId\n\n## Enrichment\n- triggerEnrichment: storeId, type\n- getEnrichmentTasks: storeId\n- verifyEnrichment: taskId, accepted, corrections?","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T14:32:33.044902668Z","created_by":"kasm-user","updated_at":"2026-01-09T15:01:20.148876119Z","closed_at":"2026-01-09T15:01:20.148876119Z","close_reason":"Implemented oRPC routers with all required endpoints","dependencies":[{"issue_id":"main-g7b","depends_on_id":"main-gmv","type":"parent-child","created_at":"2026-01-09T14:33:35.470370091Z","created_by":"kasm-user"},{"issue_id":"main-g7b","depends_on_id":"main-67u","type":"blocks","created_at":"2026-01-09T14:33:52.784503014Z","created_by":"kasm-user"}]}
{"id":"main-gmv","title":"Ingestion Pipeline + Admin UI","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-09T14:32:12.965332944Z","created_by":"kasm-user","updated_at":"2026-01-09T19:45:41.890590338Z","closed_at":"2026-01-09T19:45:41.890590338Z","close_reason":"All child tasks completed: schema, worker, UI components (store modal, ingestion dashboard, pending approval, store registry), APIs (store management, ingestion monitoring), and store enrichment workflow"}
{"id":"main-gu4","title":"Another Test","description":"type: feature","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-29T19:43:07.743867+01:00","updated_at":"2025-12-29T19:43:17.625779+01:00","deleted_at":"2025-12-29T19:43:17.625779+01:00","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"main-jfh","title":"Verify Interspar data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.270542535Z","created_by":"kasm-user","updated_at":"2026-01-09T07:20:04.694606899Z","closed_at":"2026-01-09T07:20:04.694606899Z","close_reason":"Closed"}
{"id":"main-jut","title":"Verify Trgocentar data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.53332547Z","created_by":"kasm-user","updated_at":"2026-01-09T08:21:58.931710544Z","closed_at":"2026-01-09T08:21:58.931710544Z","close_reason":"Verified: Trgocentar (3 rows, 0 errors after XML→CSV fix), DM (2 rows, 0 errors)"}
{"id":"main-ki7","title":"Update CSV parser for price transparency fields","description":"Extend src/ingestion/parsers/csv.ts CsvColumnMapping + mapping logic to support unitPrice, lowestPrice30d, anchorPrice fields. Reuse parsePrice() for conversion to cents.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:34.724982+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.704415+01:00","closed_at":"2026-01-07T18:36:30.478055014Z","dependencies":[{"issue_id":"main-ki7","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.295986+01:00","created_by":"damir"},{"issue_id":"main-ki7","depends_on_id":"main-28t","type":"blocks","created_at":"2026-01-06T14:04:50.028744+01:00","created_by":"damir"}]}
{"id":"main-luv","title":"Test chunked parsing fix on test environment","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-16T16:20:02.203727+01:00","created_by":"damir","updated_at":"2026-01-16T16:20:02.203727+01:00","dependencies":[{"issue_id":"main-luv","depends_on_id":"main-acl","type":"blocks","created_at":"2026-01-16T16:20:07.643782+01:00","created_by":"damir"}],"comments":[{"id":13,"issue_id":"main-luv","author":"damir","text":"## Testing Plan for Chunked Parsing Fix\n\n### Prerequisites\n- main-acl (chunked parsing fix) is deployed\n\n### Test Steps\n\n1. **Cancel existing stuck runs**\n   ```sql\n   UPDATE ingestion_runs SET status = 'cancelled' WHERE status IN ('running', 'pending');\n   UPDATE ingestion_files SET status = 'cancelled' WHERE status = 'processing';\n   ```\n\n2. **Trigger new ingestion**\n   ```bash\n   curl -X POST \"https://kosarica-test.damir-bijuklic.workers.dev/api/rpc/admin/ingestion/triggerChain\" \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\"json\":{\"chainSlug\":\"konzum\"}}'\n   ```\n\n3. **Monitor queue processing**\n   ```bash\n   wrangler tail kosarica-test --format pretty\n   ```\n   - Should see \"Ok\" for all messages (no \"Canceled\")\n\n4. **Verify database state**\n   ```sql\n   -- Check run progress\n   SELECT id, status, total_files, processed_files, processed_entries \n   FROM ingestion_runs WHERE status = 'running';\n   \n   -- Check file statuses (should have \"completed\" files)\n   SELECT status, COUNT(*) FROM ingestion_files \n   WHERE run_id = '\u003crun_id\u003e' GROUP BY status;\n   \n   -- Check chunks were created\n   SELECT COUNT(*) FROM ingestion_chunks WHERE run_id = '\u003crun_id\u003e';\n   ```\n\n5. **Expected Results**\n   - All queue messages complete with \"Ok\"\n   - Files transition: pending → processing → completed\n   - ingestion_chunks table has entries\n   - Run eventually completes with processed_files = total_files\n\n### Failure Modes to Watch For\n- Messages still \"Canceled\" → chunk size too large, reduce to 500\n- Chunks created but not persisted → check persist_chunk handler\n- Files stuck in \"processing\" → check chunk completion logic\n","created_at":"2026-01-16T15:20:07Z"}]}
{"id":"main-mej","title":"Update Lidl adapter for price transparency fields","description":"Map: CIJENA_ZA_JEDINICU_MJERE, NAJNIZA_CIJENA_U_POSLJ._30_DANA, Sidrena_cijena_na_02.05.2025. Set anchorPriceAsOf=2025-05-02.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:55.241546+01:00","created_by":"damir","updated_at":"2026-01-06T14:31:05.138259+01:00","closed_at":"2026-01-06T14:31:05.138259+01:00","close_reason":"Already implemented in 2026 format update","dependencies":[{"issue_id":"main-mej","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:35.364934+01:00","created_by":"damir"},{"issue_id":"main-mej","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.029571+01:00","created_by":"damir"}]}
{"id":"main-mte","title":"Implement discover() methods for all chain adapters","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-01T16:02:36.857680433Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.46453366Z","closed_at":"2026-01-01T16:32:16.46453366Z","close_reason":"Implementation completed by subagents","labels":["feature","ingestion"]}
{"id":"main-n3p","title":"Update Trgocentar adapter for price transparency fields","description":"Map XML tags: \u003cc_jmj\u003e, \u003cc_najniza_30\u003e, \u003cc_020525\u003e. Note: current adapter is CSV-only - needs alignment. Set anchorPriceAsOf=2025-05-02. Source: https://trgocentar.com/Trgovine-cjenik/","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:20.164649+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.70519+01:00","closed_at":"2026-01-07T19:48:10.208603982Z","dependencies":[{"issue_id":"main-n3p","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:37.852264+01:00","created_by":"damir"},{"issue_id":"main-n3p","depends_on_id":"main-19a","type":"blocks","created_at":"2026-01-06T14:05:02.864775+01:00","created_by":"damir"}]}
{"id":"main-n4p","title":"Update Konzum adapter for price transparency fields","description":"Map: CIJENA ZA JEDINICU MJERE, NAJNIŽA CIJENA U POSLJEDNIH 30 DANA, SIDRENA CIJENA NA 2.5.2025. Set anchorPriceAsOf=2025-05-02.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:54.261649+01:00","created_by":"damir","updated_at":"2026-01-06T14:31:05.13616+01:00","closed_at":"2026-01-06T14:31:05.13616+01:00","close_reason":"Already implemented in 2026 format update","dependencies":[{"issue_id":"main-n4p","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:35.278339+01:00","created_by":"damir"},{"issue_id":"main-n4p","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:04:59.953467+01:00","created_by":"damir"}]}
{"id":"main-ppu","title":"Test Issue Title","description":"Description here","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-29T19:42:50.188537+01:00","updated_at":"2025-12-29T19:43:07.650859+01:00","deleted_at":"2025-12-29T19:43:07.650859+01:00","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"main-pvp","title":"[DONE] Reduce queue batch size to prevent timeout","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-16T16:20:19.663099+01:00","created_by":"damir","updated_at":"2026-01-16T16:20:26.184567+01:00","closed_at":"2026-01-16T16:20:26.184567+01:00","close_reason":"Already deployed - queue batch size reduced to 1","comments":[{"id":14,"issue_id":"main-pvp","author":"damir","text":"## Change Made\nReduced queue consumer `max_batch_size` from 10 to 1 in wrangler.test.jsonc to prevent batch processing timeouts.\n\n## Rationale\n- With batch_size=10, the worker tried to process 10 messages in parallel\n- Each fetch/parse operation could take several seconds\n- Combined processing exceeded CPU time limit, causing all messages to be \"Canceled\"\n\n## Current Configuration\n```jsonc\n\"consumers\": [\n  {\n    \"queue\": \"kosarica-ingestion-test\",\n    \"max_batch_size\": 1,\n    \"max_retries\": 3,\n    \"dead_letter_queue\": \"kosarica-ingestion-dlq-test\",\n    \"max_concurrency\": 5\n  }\n]\n```\n\n## Effect\n- Each worker invocation processes only 1 message\n- `max_concurrency: 5` allows 5 concurrent worker instances\n- Fetch messages now complete successfully\n- Parse messages still timeout due to large file persist (separate issue main-acl)\n\n## Files Changed\n- `/wrangler.test.jsonc` - queue consumer configuration\n\n## Status: DEPLOYED\nThis change is already deployed to test environment.\n","created_at":"2026-01-16T15:20:26Z"}]}
{"id":"main-qsn","title":"Schema: Add virtual store columns to stores table","description":"## Goal\nAdd columns to stores table to support virtual/physical store separation.\n\n## Schema Changes\n**File**: `src/db/schema.ts` - stores table\n\nAdd these columns:\n```typescript\nisVirtual: integer('is_virtual', { mode: 'boolean' }).default(true),\npriceSourceStoreId: text('price_source_store_id').references(() =\u003e stores.id),\nstatus: text('status').default('active'), // 'active' | 'pending'\n```\n\n## Migration SQL\n```sql\nALTER TABLE stores ADD COLUMN is_virtual INTEGER DEFAULT 1;\nALTER TABLE stores ADD COLUMN price_source_store_id TEXT REFERENCES stores(id);\nALTER TABLE stores ADD COLUMN status TEXT DEFAULT 'active';\n\n-- Indexes\nCREATE INDEX stores_status_idx ON stores(status);\nCREATE INDEX stores_price_source_idx ON stores(price_source_store_id);\n```\n\n## Column Definitions\n- `is_virtual`: true=import-linked store (holds prices), false=physical location\n- `price_source_store_id`: FK to another store for price inheritance\n- `status`: 'active' (normal) or 'pending' (awaiting approval)\n\n## Default Behavior\n- All existing stores get is_virtual=1 (they came from imports)\n- All existing stores get status='active' (grandfathered)\n\n## Verification\n1. Run `pnpm db:generate` to create migration\n2. Run `pnpm db:migrate` to apply\n3. Query: `SELECT is_virtual, status FROM stores LIMIT 5` → all should be 1, 'active'","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-09T13:50:56.92132449Z","created_by":"kasm-user","updated_at":"2026-01-09T13:57:57.25980227Z","closed_at":"2026-01-09T13:57:57.25980227Z","close_reason":"Added is_virtual, price_source_store_id, and status columns to stores table with indexes. Existing stores defaulted to is_virtual=1, status='active'"}
{"id":"main-r9p","title":"Update persist module for price transparency fields","description":"Update src/ingestion/core/persist.ts upserts for store_item_state to write new columns. Keep computePriceSignature() unchanged - don't include lowestPrice30d to avoid period churn.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:53.088711+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.705726+01:00","closed_at":"2026-01-07T18:36:30.482123118Z","dependencies":[{"issue_id":"main-r9p","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.532761+01:00","created_by":"damir"},{"issue_id":"main-r9p","depends_on_id":"main-28t","type":"blocks","created_at":"2026-01-06T14:04:51.384936+01:00","created_by":"damir"}]}
{"id":"main-rqe","title":"Verify DM data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.587432942Z","created_by":"kasm-user","updated_at":"2026-01-09T08:21:58.933690923Z","closed_at":"2026-01-09T08:21:58.933690923Z","close_reason":"Verified: Trgocentar (3 rows, 0 errors after XML→CSV fix), DM (2 rows, 0 errors)"}
{"id":"main-s1l","title":"Fix hardcoded absolute paths in chain adapter tests","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-01T16:02:48.414633302Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.467067679Z","closed_at":"2026-01-01T16:32:16.467067679Z","close_reason":"Implementation completed by subagents","labels":["bug","testing"]}
{"id":"main-tvx","title":"API: Ingestion monitoring endpoints","description":"Create src/orpc/router/ingestion.ts\n\n## Monitoring\n- listRuns: chainSlug?, status?, page\n- getRun: runId\n- listFiles: runId, status?\n- getFile: fileId\n- listChunks: fileId, status?\n- getChunk: chunkId\n- listErrors: runId?, fileId?, chunkId?, errorType?\n\n## Stats\n- getStats: timeRange (24h|7d|30d)\n\n## Re-runs\n- rerunRun: runId\n- rerunFile: fileId\n- rerunChunk: chunkId\n\n## Manual trigger\n- triggerChain: chainSlug","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T14:32:34.734746259Z","created_by":"kasm-user","updated_at":"2026-01-09T15:01:20.15102338Z","closed_at":"2026-01-09T15:01:20.15102338Z","close_reason":"Implemented oRPC routers with all required endpoints","dependencies":[{"issue_id":"main-tvx","depends_on_id":"main-gmv","type":"parent-child","created_at":"2026-01-09T14:33:35.685463535Z","created_by":"kasm-user"},{"issue_id":"main-tvx","depends_on_id":"main-67u","type":"blocks","created_at":"2026-01-09T14:33:53.006538725Z","created_by":"kasm-user"},{"issue_id":"main-tvx","depends_on_id":"main-wyq","type":"blocks","created_at":"2026-01-09T14:33:53.215256778Z","created_by":"kasm-user"}]}
{"id":"main-wnh","title":"Update Plodine adapter for price transparency fields","description":"Map: Cijena po JM, Najniza cijena u poslj. 30 dana, Sidrena cijena na 2.5.2025. Set anchorPriceAsOf=2025-05-02. Source: https://www.plodine.hr/info-o-cijenama","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:56.927946+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.70625+01:00","closed_at":"2026-01-07T19:48:10.201715708Z","dependencies":[{"issue_id":"main-wnh","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:35.444186+01:00","created_by":"damir"},{"issue_id":"main-wnh","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.106606+01:00","created_by":"damir"}]}
{"id":"main-wyq","title":"Worker: Chunking pipeline handlers","description":"Add new queue message types and handlers:\n\n## New Message Types\n- ParseChunkedQueueMessage\n- PersistChunkQueueMessage  \n- RerunQueueMessage\n- EnrichStoreQueueMessage\n\n## New Handlers in worker.ts\n1. handleParseChunked - parse file, split into chunks, store in R2, enqueue persist\n2. handlePersistChunk - load chunk from R2, persist rows, update status\n3. handleRerun - re-run at run/file/chunk level\n4. handleEnrichStore - call geocoding API, save results","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-09T14:32:32.050698131Z","created_by":"kasm-user","updated_at":"2026-01-09T14:50:25.426160745Z","closed_at":"2026-01-09T14:50:25.426160745Z","close_reason":"Implemented chunking pipeline handlers: ParseChunkedQueueMessage, PersistChunkQueueMessage, RerunQueueMessage, EnrichStoreQueueMessage with corresponding handlers handleParseChunked, handlePersistChunk, handleRerun, handleEnrichStore","dependencies":[{"issue_id":"main-wyq","depends_on_id":"main-gmv","type":"parent-child","created_at":"2026-01-09T14:33:35.252444057Z","created_by":"kasm-user"},{"issue_id":"main-wyq","depends_on_id":"main-67u","type":"blocks","created_at":"2026-01-09T14:33:52.549664396Z","created_by":"kasm-user"}]}
{"id":"main-yqi","title":"Verify Plodine data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.213550726Z","created_by":"kasm-user","updated_at":"2026-01-09T07:20:04.692416717Z","closed_at":"2026-01-09T07:20:04.692416717Z","close_reason":"Closed"}
{"id":"main-z1s","title":"Refactor chain adapters: Extract common base class to reduce duplication","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T16:02:34.140515731Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.465835961Z","closed_at":"2026-01-01T16:32:16.465835961Z","close_reason":"Implementation completed by subagents","labels":["refactor","tech-debt"]}
{"id":"main-zrq","title":"Generate Drizzle migration for price transparency columns","description":"Run drizzle-kit generate to create migration for new price transparency columns in store_item_state (and optionally store_item_price_periods).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T14:03:32.306583+01:00","created_by":"damir","updated_at":"2026-01-14T11:38:01.706783+01:00","closed_at":"2026-01-07T17:00:40.006722921Z","dependencies":[{"issue_id":"main-zrq","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.134404+01:00","created_by":"damir"},{"issue_id":"main-zrq","depends_on_id":"main-4cn","type":"blocks","created_at":"2026-01-06T14:04:46.270452+01:00","created_by":"damir"}]}
{"id":"main-zu4","title":"Fix D1 SQL variable limit in persist batch","description":"## Problem\n`persistRowChunkBatched` in `src/ingestion/core/persist.ts` accumulates all write queries for a chunk into a single `db.batch()` call. When the total SQL bind parameters exceed D1's 999 variable limit, the batch fails with:\n\n```\nD1_ERROR: too many SQL variables at offset 696: SQLITE_ERROR\n```\n\n## Current Behavior\n- DEFAULT_BATCH_SIZE = 50 rows per chunk\n- Each row generates variable number of queries depending on:\n  - Insert vs update (inserts have more params)\n  - Number of barcodes\n  - Price change status (changed prices need 3 queries)\n- All queries batched into single `db.batch()` call\n\n## Solution Options\n1. **Dynamic splitting**: Count bind parameters as queries are added to writeQueries, split into sub-batches when approaching 999 limit\n2. **Configurable batch size**: Add batchSize parameter to persist functions, let caller tune based on their data characteristics\n3. **Hybrid**: Default dynamic splitting with optional override\n\n## Files\n- `src/ingestion/core/persist.ts:1193` - `persistRowChunkBatched` function\n- Line 1577 - `db.batch(writeQueries)` call that fails","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-09T05:26:01.177722657Z","created_by":"kasm-user","updated_at":"2026-01-09T07:04:36.474758349Z","closed_at":"2026-01-09T07:04:36.474758349Z","close_reason":"Fixed by using dynamic batch sizes based on column counts. storeItemState now uses 4 rows per batch (72 params) instead of 8 (144 params)."}
{"id":"main-zw6","title":"Add rate limiting and exponential backoff to chain adapter fetch methods","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T16:02:59.660865529Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.469664865Z","closed_at":"2026-01-01T16:32:16.469664865Z","close_reason":"Implementation completed by subagents","labels":["ingestion","reliability"]}
