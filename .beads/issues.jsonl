{"id":"main-073","title":"Verify Kaufland data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.376110018Z","created_by":"kasm-user","updated_at":"2026-01-09T07:29:30.649948846Z","closed_at":"2026-01-09T07:29:30.649948846Z","close_reason":"Closed"}
{"id":"main-0fg","title":"Ingestion: Pending store approval workflow","description":"## Goal\nNew unknown stores created as pending (not active). Existing stores get identifiers added.\n\n## Changes to autoRegisterStore()\n**File**: `src/ingestion/core/persist.ts` (~line 742)\n\nCurrent signature:\n```typescript\nexport async function autoRegisterStore(\n  db: AnyDatabase,\n  chainSlug: string,\n  identifier: string,\n  identifierType: string,\n  options: StoreAutoRegisterOptions,\n): Promise\u003cstring | null\u003e\n```\n\nNew signature:\n```typescript\nexport async function autoRegisterStore(\n  db: AnyDatabase,\n  chainSlug: string,\n  identifier: string,\n  identifierType: string,\n  options: StoreAutoRegisterOptions,\n): Promise\u003c{ storeId: string; status: 'existing' | 'pending' | 'created' } | null\u003e\n```\n\n## New Logic\n1. Try resolve existing store by identifier → return { storeId, status: 'existing' }\n2. If not found, check if physical store exists with same name in chain\n3. If physical match → add identifier to it, return { storeId, status: 'existing' }\n4. If no match → create store with:\n   - `isVirtual=true` (it's import-linked)\n   - `status='pending'` (awaits approval)\n   - Return { storeId, status: 'pending' }\n\n## Special Case: National Stores\nWhen `identifierType === 'national'`:\n- Always set `isVirtual=true`\n- Set `status='active'` (national stores auto-approved)\n\n## Update Callers\nUpdate `persistRowsForStore()` and any other callers to handle new return type.\n\n## Logging\nLog when pending store created:\n```\n[persist] Created pending store: \"Store Name\" (identifier) for chain xyz - awaiting approval\n```\n\n## Verification\n1. Run ingestion for chain with new store file → verify store created with status='pending'\n2. Run ingestion for existing store → verify identifier added, no new store\n3. Run DM ingestion → verify dm_national has is_virtual=1, status='active'","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-09T13:51:11.401510284Z","created_by":"kasm-user","updated_at":"2026-01-09T13:51:11.401510284Z","dependencies":[{"issue_id":"main-0fg","depends_on_id":"main-qsn","type":"blocks","created_at":"2026-01-09T13:52:05.063401539Z","created_by":"kasm-user"}]}
{"id":"main-0fr","title":"CLI: Physical store creation and linking","description":"## Goal\nCommands to add physical stores and link them to virtual stores for pricing.\n\n## File\n**File**: `src/ingestion/cli/stores.ts` (extend existing)\n\n## Commands\n\n### Add physical store\n```bash\npnpm ingest stores --add \\\n  --chain=dm \\\n  --name=\"DM Zagreb Ilica\" \\\n  --address=\"Ilica 123\" \\\n  --city=\"Zagreb\" \\\n  --postal-code=\"10000\" \\\n  --lat=45.815 \\\n  --lng=15.982 \\\n  --price-source=dm_national\n```\n\nCreates store with:\n- `isVirtual=false`\n- `priceSourceStoreId` → resolved from --price-source identifier\n- `status='active'`\n- Location fields populated\n\n### Link existing store to price source\n```bash\npnpm ingest stores --link \u003cstore_id\u003e --price-source=\u003cidentifier\u003e\n```\n- Resolves identifier to store ID\n- Sets priceSourceStoreId on target store\n- Outputs: \"Linked {store} to price source {source}\"\n\n### Import physical stores from CSV\n```bash\npnpm ingest stores --import-csv ./dm_stores.csv --chain=dm --price-source=dm_national\n```\n\nCSV format:\n```csv\nname,address,city,postal_code,lat,lng\nDM Zagreb Ilica,Ilica 123,Zagreb,10000,45.815,15.982\nDM Split Riva,Riva 45,Split,21000,43.508,16.440\n```\n\n- Creates all stores with isVirtual=false\n- All link to specified --price-source\n- Reports: \"Imported X stores, Y errors\"\n\n## Validation\n- --chain required for --add and --import-csv\n- --price-source must resolve to existing virtual store\n- Physical stores require at least name and city\n- Lat/lng optional but recommended\n\n## Verification\n1. Add single physical DM store → verify isVirtual=false, priceSourceStoreId set\n2. Import CSV of 3 stores → verify all created and linked\n3. Query prices for physical store → should use virtual store's prices","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-09T13:51:40.374415702Z","created_by":"kasm-user","updated_at":"2026-01-09T13:51:40.374415702Z","dependencies":[{"issue_id":"main-0fr","depends_on_id":"main-dy8","type":"blocks","created_at":"2026-01-09T13:52:05.166821099Z","created_by":"kasm-user"}]}
{"id":"main-0u1","title":"Verify Eurospin data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.322811463Z","created_by":"kasm-user","updated_at":"2026-01-09T07:29:30.647408197Z","closed_at":"2026-01-09T07:29:30.647408197Z","close_reason":"Closed"}
{"id":"main-11x","title":"Update KTC adapter for price transparency fields","description":"Map: Cijena za jedinicu mjere, Najniža cijena u posljednjih 30 dana. Note: no anchor column in sample. Source: https://www.ktc.hr/cjenici","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:15.802272+01:00","created_by":"damir","updated_at":"2026-01-07T19:48:10.205766889Z","closed_at":"2026-01-07T19:48:10.205766889Z","close_reason":"All adapters tested and working with price transparency fields","dependencies":[{"issue_id":"main-11x","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:37.617339+01:00","created_by":"damir"},{"issue_id":"main-11x","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.398525+01:00","created_by":"damir"}]}
{"id":"main-19a","title":"Update XML parser for price transparency fields","description":"Extend src/ingestion/parsers/xml.ts XmlFieldMapping + item mapping to support CijenaZaJedinicuMjere, NajnizaCijena, SidrenaCijena for Studenac/Trgocentar.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:37.609326+01:00","created_by":"damir","updated_at":"2026-01-07T18:36:30.481364781Z","closed_at":"2026-01-07T18:36:30.481364781Z","close_reason":"All price transparency fields implemented in parsers and persist module","dependencies":[{"issue_id":"main-19a","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.451074+01:00","created_by":"damir"},{"issue_id":"main-19a","depends_on_id":"main-28t","type":"blocks","created_at":"2026-01-06T14:04:50.217483+01:00","created_by":"damir"}]}
{"id":"main-1q1","title":"see c27df4b8f3fbbdba2c4aca246f78aca15d741945 in https://github.com/damir5/nftraffle (with gh) and port table column copying to clipboard here","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T09:16:14.786404813Z","updated_at":"2025-12-31T09:20:56.66265317Z","closed_at":"2025-12-31T09:20:56.66265317Z","close_reason":"Ported table column copying to clipboard from nftraffle. Created CopyableCell component, integrated into UserViewModal and UserTable. Added sonner for toast notifications."}
{"id":"main-28t","title":"Extend NormalizedRow types with price transparency fields","description":"Update src/ingestion/core/types.ts NormalizedRow with optional fields: unitPriceCents, unitPriceBaseQuantity, unitPriceBaseUnit, lowestPrice30dCents, anchorPriceCents, anchorPriceAsOf.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:33.343828+01:00","created_by":"damir","updated_at":"2026-01-07T17:14:04.499258764Z","closed_at":"2026-01-07T17:14:04.499258764Z","close_reason":"Already implemented - NormalizedRow in src/ingestion/core/types.ts already has all price transparency fields (unitPrice, unitPriceBaseQuantity, unitPriceBaseUnit, lowestPrice30d, anchorPrice, anchorPriceAsOf) with naming matching the database schema","dependencies":[{"issue_id":"main-28t","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.214309+01:00","created_by":"damir"},{"issue_id":"main-28t","depends_on_id":"main-zrq","type":"blocks","created_at":"2026-01-06T14:04:48.568573+01:00","created_by":"damir"}]}
{"id":"main-2al","title":"Add unique constraints to storeIdentifiers and productLinks tables","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T16:02:49.397566406Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.468320355Z","closed_at":"2026-01-01T16:32:16.468320355Z","close_reason":"Implementation completed by subagents"}
{"id":"main-2fr","title":"Add database indexes for price queries and common lookups","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T16:03:07.801405648Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.472944223Z","closed_at":"2026-01-01T16:32:16.472944223Z","close_reason":"Implementation completed by subagents"}
{"id":"main-2u8","title":"Update XLSX parser for price transparency fields","description":"Extend src/ingestion/parsers/xlsx.ts XlsxColumnMapping + mapping logic to support unitPrice, lowestPrice30d, anchorPrice fields for DM adapter.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:36.452387+01:00","created_by":"damir","updated_at":"2026-01-07T18:36:30.480186775Z","closed_at":"2026-01-07T18:36:30.480186775Z","close_reason":"All price transparency fields implemented in parsers and persist module","dependencies":[{"issue_id":"main-2u8","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.372832+01:00","created_by":"damir"},{"issue_id":"main-2u8","depends_on_id":"main-28t","type":"blocks","created_at":"2026-01-06T14:04:50.123182+01:00","created_by":"damir"}]}
{"id":"main-3vl","title":"Update Eurospin adapter for price transparency fields","description":"Map: CIJENA_ZA_JEDINICU_MJERE, NAJNIŽA_MPC_U_30DANA, SIDRENA_CIJENA, plus POSEB.OBLIK_PROD__ZA_JEDINICU_MJERE for special sale unit price. Source: https://www.eurospin.hr/cjenik/","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:59.323181+01:00","created_by":"damir","updated_at":"2026-01-07T19:48:10.204459009Z","closed_at":"2026-01-07T19:48:10.204459009Z","close_reason":"All adapters tested and working with price transparency fields","dependencies":[{"issue_id":"main-3vl","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:35.597929+01:00","created_by":"damir"},{"issue_id":"main-3vl","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.24898+01:00","created_by":"damir"}]}
{"id":"main-4cn","title":"Add price transparency columns to store_item_state schema","description":"Update src/db/schema.ts store_item_state table with: unit_price, unit_price_base_quantity, unit_price_base_unit, lowest_price_30d, anchor_price, anchor_price_as_of. Optional: add to store_item_price_periods but exclude from price signature to avoid churn.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T14:03:30.548267+01:00","created_by":"damir","updated_at":"2026-01-07T16:49:44.983259423Z","closed_at":"2026-01-07T16:49:44.983259423Z","close_reason":"Fixed duplicate price transparency columns (removed *Cents variants), renamed to unitPrice/lowestPrice30d/anchorPrice to match schema spec, updated all ingestion code","dependencies":[{"issue_id":"main-4cn","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.05294+01:00","created_by":"damir"}]}
{"id":"main-4fu","title":"Verify Studenac data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.481252333Z","created_by":"kasm-user","updated_at":"2026-01-09T08:09:57.349643026Z","closed_at":"2026-01-09T08:09:57.349643026Z","close_reason":"Verified: Metro (13,092 rows, 0 errors), Studenac (2 rows, 0 errors)"}
{"id":"main-4mn","title":"Price Tracking DB Schema \u0026 Ingestion Pipeline","description":"Add grocery price tracking with chains, stores, retailer items, and prices. Pipeline runnable from CLI and Cloudflare Workers with Queue fanout. Covers 11 retail chains with CSV/XML/XLSX parsing.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-29T19:43:40.877298+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.954281+01:00","closed_at":"2025-12-30T15:36:50.104998569Z"}
{"id":"main-4mn.1","title":"Add price tracking tables to schema.ts","description":"Add 14 new tables to src/db/schema.ts:\n- Retail World: chains, stores, store_identifiers, retailer_items, retailer_item_barcodes\n- Canonical Catalog: products, product_aliases, product_links, product_relations\n- Prices: store_item_state, store_item_price_periods\n- Ingestion: ingestion_runs, ingestion_files, ingestion_file_entries, ingestion_errors\n\nKey features:\n- chains: text PK slug (konzum, lidl, etc.)\n- store_identifiers: handle filename codes, portal IDs\n- retailer_item_barcodes: many-to-one for Lidl case\n- store_item_state: price_signature for dedup\n- store_item_price_periods: history only on change","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T19:44:02.541685+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.956337+01:00","closed_at":"2025-12-30T11:31:42.309531329Z","dependencies":[{"issue_id":"main-4mn.1","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:02.54488+01:00","created_by":"daemon"},{"issue_id":"main-4mn.1","depends_on_id":"main-4mn.34","type":"blocks","created_at":"2025-12-29T19:48:20.860347+01:00","created_by":"daemon"}]}
{"id":"main-4mn.10","title":"Create XLSX parser","description":"Create src/ingestion/parsers/xlsx.ts:\n- Use xlsx library\n- Handle DM national file format\n- Map columns to NormalizedRow","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:03.129997+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.957179+01:00","closed_at":"2025-12-30T14:26:04.343217332Z","dependencies":[{"issue_id":"main-4mn.10","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:03.132137+01:00","created_by":"daemon"},{"issue_id":"main-4mn.10","depends_on_id":"main-4mn.7","type":"blocks","created_at":"2025-12-29T19:48:01.295495+01:00","created_by":"daemon"}]}
{"id":"main-4mn.11","title":"Create chain adapter registry","description":"Create src/ingestion/chains/index.ts:\n- Registry mapping chain_id → adapter\n- Chain config (URLs, formats, delimiters)\n- getAdapter(chain_id) function","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:28.501618+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.957979+01:00","closed_at":"2025-12-30T14:21:12.591187838Z","dependencies":[{"issue_id":"main-4mn.11","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:28.503709+01:00","created_by":"daemon"},{"issue_id":"main-4mn.11","depends_on_id":"main-4mn.3","type":"blocks","created_at":"2025-12-29T19:48:03.147307+01:00","created_by":"daemon"},{"issue_id":"main-4mn.11","depends_on_id":"main-4mn.7","type":"blocks","created_at":"2025-12-29T19:48:03.182901+01:00","created_by":"daemon"}]}
{"id":"main-4mn.12","title":"Implement Konzum chain adapter","description":"Create src/ingestion/chains/konzum.ts:\n- Format: CSV, delimiter: comma\n- Store resolution: filename (address + store ID)\n- Column mapping specific to Konzum format","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:29.343418+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.958693+01:00","closed_at":"2025-12-30T14:30:52.222403391Z","dependencies":[{"issue_id":"main-4mn.12","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:29.345437+01:00","created_by":"daemon"},{"issue_id":"main-4mn.12","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.388851+01:00","created_by":"daemon"}]}
{"id":"main-4mn.13","title":"Implement Lidl chain adapter","description":"Create src/ingestion/chains/lidl.ts:\n- Format: CSV, delimiter: comma\n- Store resolution: filename (daily ZIP → fanout)\n- Handle multiple GTINs per SKU\n- Column mapping specific to Lidl format","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:31.90735+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.959607+01:00","closed_at":"2025-12-30T14:36:33.779692922Z","dependencies":[{"issue_id":"main-4mn.13","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:31.909688+01:00","created_by":"daemon"},{"issue_id":"main-4mn.13","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.430367+01:00","created_by":"daemon"}]}
{"id":"main-4mn.14","title":"Implement Plodine chain adapter","description":"Create src/ingestion/chains/plodine.ts:\n- Format: CSV, delimiter: semicolon\n- Store resolution: filename\n- Handle ,69 decimal format (missing leading zero)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:32.78086+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.96026+01:00","closed_at":"2025-12-30T14:40:53.885056662Z","dependencies":[{"issue_id":"main-4mn.14","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:32.783305+01:00","created_by":"daemon"},{"issue_id":"main-4mn.14","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.467815+01:00","created_by":"daemon"}]}
{"id":"main-4mn.15","title":"Implement Interspar chain adapter","description":"Create src/ingestion/chains/interspar.ts:\n- Format: CSV, delimiter: semicolon\n- Store resolution: filename","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:34.198416+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.960982+01:00","closed_at":"2025-12-30T14:46:20.091500256Z","dependencies":[{"issue_id":"main-4mn.15","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:34.201028+01:00","created_by":"daemon"},{"issue_id":"main-4mn.15","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.502637+01:00","created_by":"daemon"}]}
{"id":"main-4mn.16","title":"Implement Studenac chain adapter","description":"Create src/ingestion/chains/studenac.ts:\n- Format: XML\n- Store resolution: XML content (store block inside)\n- Parse store info from within XML structure","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:35.136978+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.961648+01:00","closed_at":"2025-12-30T14:50:36.192536706Z","dependencies":[{"issue_id":"main-4mn.16","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:35.139865+01:00","created_by":"daemon"},{"issue_id":"main-4mn.16","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.536656+01:00","created_by":"daemon"}]}
{"id":"main-4mn.17","title":"Implement Kaufland chain adapter","description":"Create src/ingestion/chains/kaufland.ts:\n- Format: CSV, delimiter: tab\n- Store resolution: filename","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:47.687201+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.962293+01:00","closed_at":"2025-12-30T14:54:44.521161494Z","dependencies":[{"issue_id":"main-4mn.17","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:47.689059+01:00","created_by":"daemon"},{"issue_id":"main-4mn.17","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.571112+01:00","created_by":"daemon"}]}
{"id":"main-4mn.18","title":"Implement Eurospin chain adapter","description":"Create src/ingestion/chains/eurospin.ts:\n- Format: CSV, delimiter: semicolon\n- Store resolution: filename","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:49.052502+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.962922+01:00","closed_at":"2025-12-30T15:00:37.146431965Z","dependencies":[{"issue_id":"main-4mn.18","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:49.054628+01:00","created_by":"daemon"},{"issue_id":"main-4mn.18","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.60454+01:00","created_by":"daemon"}]}
{"id":"main-4mn.19","title":"Implement DM chain adapter","description":"Create src/ingestion/chains/dm.ts:\n- Format: XLSX\n- Store resolution: single national file (all stores)\n- Parse Excel structure","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:50.30759+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.963565+01:00","closed_at":"2025-12-30T15:00:37.154120155Z","dependencies":[{"issue_id":"main-4mn.19","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:50.30982+01:00","created_by":"daemon"},{"issue_id":"main-4mn.19","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.639809+01:00","created_by":"daemon"}]}
{"id":"main-4mn.2","title":"Generate Drizzle migration for price tracking","description":"Run drizzle-kit generate to create migration for the new price tracking tables.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T19:44:03.982069+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.964196+01:00","closed_at":"2025-12-30T12:02:34.076178986Z","dependencies":[{"issue_id":"main-4mn.2","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:03.985166+01:00","created_by":"daemon"},{"issue_id":"main-4mn.2","depends_on_id":"main-4mn.1","type":"blocks","created_at":"2025-12-29T19:47:47.748724+01:00","created_by":"daemon"}]}
{"id":"main-4mn.20","title":"Implement KTC chain adapter","description":"Create src/ingestion/chains/ktc.ts:\n- Format: CSV, delimiter: semicolon\n- Store resolution: filename","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:51.350841+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.964859+01:00","closed_at":"2025-12-30T15:00:37.155974107Z","dependencies":[{"issue_id":"main-4mn.20","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:51.353314+01:00","created_by":"daemon"},{"issue_id":"main-4mn.20","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.674216+01:00","created_by":"daemon"}]}
{"id":"main-4mn.21","title":"Implement Metro chain adapter","description":"Create src/ingestion/chains/metro.ts:\n- Format: CSV, delimiter: comma\n- Store resolution: filename","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:52.52463+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.965518+01:00","closed_at":"2025-12-30T15:00:37.157571388Z","dependencies":[{"issue_id":"main-4mn.21","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:52.526794+01:00","created_by":"daemon"},{"issue_id":"main-4mn.21","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.70854+01:00","created_by":"daemon"}]}
{"id":"main-4mn.22","title":"Implement Trgocentar chain adapter","description":"Create src/ingestion/chains/trgocentar.ts:\n- Format: XML\n- Store resolution: filename + XML\n- Parse XML structure","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:45:54.365347+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.96616+01:00","closed_at":"2025-12-30T15:00:37.159138376Z","dependencies":[{"issue_id":"main-4mn.22","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:45:54.367923+01:00","created_by":"daemon"},{"issue_id":"main-4mn.22","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:04.743861+01:00","created_by":"daemon"}]}
{"id":"main-4mn.23","title":"Create discover CLI command","description":"Create src/ingestion/cli/discover.ts:\n- List artifacts for chain+date\n- Usage: npx tsx src/ingestion/cli/discover.ts -c konzum -d 2025-12-29\n- Return URLs or paths of available files","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:19.177629+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.966797+01:00","closed_at":"2025-12-30T15:08:13.970096594Z","dependencies":[{"issue_id":"main-4mn.23","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:19.17971+01:00","created_by":"daemon"},{"issue_id":"main-4mn.23","depends_on_id":"main-4mn.6","type":"blocks","created_at":"2025-12-29T19:48:15.256344+01:00","created_by":"daemon"},{"issue_id":"main-4mn.23","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:15.291579+01:00","created_by":"daemon"}]}
{"id":"main-4mn.24","title":"Create fetch CLI command","description":"Create src/ingestion/cli/fetch.ts:\n- Download + record ingestion_files\n- Usage: npx tsx src/ingestion/cli/fetch.ts -c konzum -u \u003curl_or_path\u003e\n- Store to R2/FS, compute SHA256","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:20.295853+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.967446+01:00","closed_at":"2025-12-30T15:08:13.991374439Z","dependencies":[{"issue_id":"main-4mn.24","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:20.298066+01:00","created_by":"daemon"},{"issue_id":"main-4mn.24","depends_on_id":"main-4mn.6","type":"blocks","created_at":"2025-12-29T19:48:15.325642+01:00","created_by":"daemon"},{"issue_id":"main-4mn.24","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:15.359249+01:00","created_by":"daemon"}]}
{"id":"main-4mn.25","title":"Create expand CLI command","description":"Create src/ingestion/cli/expand.ts:\n- ZIP → entries\n- Usage: npx tsx src/ingestion/cli/expand.ts -f ingestion_file_id\n- Record ingestion_file_entries","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:21.302574+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.968119+01:00","closed_at":"2025-12-30T15:08:13.994040743Z","dependencies":[{"issue_id":"main-4mn.25","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:21.305192+01:00","created_by":"daemon"},{"issue_id":"main-4mn.25","depends_on_id":"main-4mn.6","type":"blocks","created_at":"2025-12-29T19:48:15.393621+01:00","created_by":"daemon"},{"issue_id":"main-4mn.25","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:15.428546+01:00","created_by":"daemon"}]}
{"id":"main-4mn.26","title":"Create parse CLI command","description":"Create src/ingestion/cli/parse.ts:\n- Parse one file/entry\n- Usage: npx tsx src/ingestion/cli/parse.ts -c konzum -f \u003cpath\u003e\n- Use appropriate parser (CSV/XML/XLSX)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:22.700953+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.968777+01:00","closed_at":"2025-12-30T15:08:13.996537837Z","dependencies":[{"issue_id":"main-4mn.26","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:22.703375+01:00","created_by":"daemon"},{"issue_id":"main-4mn.26","depends_on_id":"main-4mn.6","type":"blocks","created_at":"2025-12-29T19:48:15.462037+01:00","created_by":"daemon"},{"issue_id":"main-4mn.26","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:15.495373+01:00","created_by":"daemon"}]}
{"id":"main-4mn.27","title":"Create run CLI command (end-to-end)","description":"Create src/ingestion/cli/run.ts:\n- End-to-end for chain/date\n- Usage: npx tsx src/ingestion/cli/run.ts -c konzum -d 2025-12-29 [--store \u003cstore_id\u003e]\n- Support --dry-run flag\n- Orchestrate discover → fetch → expand → parse → persist","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:24.87748+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.969426+01:00","closed_at":"2025-12-30T15:08:13.998622972Z","dependencies":[{"issue_id":"main-4mn.27","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:24.880002+01:00","created_by":"daemon"},{"issue_id":"main-4mn.27","depends_on_id":"main-4mn.6","type":"blocks","created_at":"2025-12-29T19:48:15.52855+01:00","created_by":"daemon"},{"issue_id":"main-4mn.27","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:15.561245+01:00","created_by":"daemon"}]}
{"id":"main-4mn.28","title":"Test each chain with sample data","description":"Test each chain adapter with sample data from ../data/sample/:\n- Verify parsing of all 11 chains\n- Check column mapping correctness\n- Validate NormalizedRow output","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:45.95908+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.970043+01:00","closed_at":"2025-12-30T15:22:10.670378951Z","dependencies":[{"issue_id":"main-4mn.28","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:45.962074+01:00","created_by":"daemon"},{"issue_id":"main-4mn.28","depends_on_id":"main-4mn.27","type":"blocks","created_at":"2025-12-29T19:48:16.934603+01:00","created_by":"daemon"}]}
{"id":"main-4mn.29","title":"Verify price signature deduplication","description":"Test price_signature dedup logic:\n- Run same data twice\n- Verify no duplicate price_periods created\n- Verify last_seen_ts updated on second run\n- Verify new period created only on actual change","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:47.576289+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.970958+01:00","closed_at":"2025-12-30T15:22:10.680333156Z","dependencies":[{"issue_id":"main-4mn.29","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:47.578468+01:00","created_by":"daemon"},{"issue_id":"main-4mn.29","depends_on_id":"main-4mn.27","type":"blocks","created_at":"2025-12-29T19:48:16.96941+01:00","created_by":"daemon"}]}
{"id":"main-4mn.3","title":"Create ingestion core types","description":"Create src/ingestion/core/types.ts with shared interfaces:\n- NormalizedRow: parsed row with prices, barcodes, quantities\n- StoreDescriptor: resolved store info\n- ChainAdapter interface\n- QueueMessage types for Cloudflare","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:28.391652+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.971749+01:00","closed_at":"2025-12-30T12:05:40.753171105Z","dependencies":[{"issue_id":"main-4mn.3","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:28.393798+01:00","created_by":"daemon"},{"issue_id":"main-4mn.3","depends_on_id":"main-4mn.1","type":"blocks","created_at":"2025-12-29T19:47:50.078824+01:00","created_by":"daemon"}]}
{"id":"main-4mn.30","title":"Verify store resolution","description":"Test store resolution strategy:\n- Filename-first resolution\n- Registry lookup fallback\n- Unresolved fallback with store_identifiers(kind='unresolved')\n- Test across different chain formats","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:46:48.93219+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.972409+01:00","closed_at":"2025-12-30T15:22:10.682119508Z","dependencies":[{"issue_id":"main-4mn.30","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:46:48.934658+01:00","created_by":"daemon"},{"issue_id":"main-4mn.30","depends_on_id":"main-4mn.27","type":"blocks","created_at":"2025-12-29T19:48:17.003823+01:00","created_by":"daemon"}]}
{"id":"main-4mn.31","title":"Create Cloudflare Worker for ingestion","description":"Create src/ingestion/worker.ts:\n- Queue consumer for parse_entry messages\n- Cron scheduled handler for discover+fetch\n- Handle QueueMessage types:\n  - expand_zip: run_id, file_id\n  - parse_entry: run_id, entry_id, chain_id\n- Batch parse + persist","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:47:14.32944+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.973043+01:00","closed_at":"2025-12-30T15:22:10.683669571Z","dependencies":[{"issue_id":"main-4mn.31","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:47:14.332271+01:00","created_by":"daemon"},{"issue_id":"main-4mn.31","depends_on_id":"main-4mn.6","type":"blocks","created_at":"2025-12-29T19:48:17.979169+01:00","created_by":"daemon"},{"issue_id":"main-4mn.31","depends_on_id":"main-4mn.11","type":"blocks","created_at":"2025-12-29T19:48:18.013409+01:00","created_by":"daemon"}]}
{"id":"main-4mn.32","title":"Update wrangler.jsonc for Queue and R2","description":"Update wrangler.jsonc:\n- Add queue producer: INGESTION_QUEUE → price-ingestion\n- Add queue consumer: max_batch_size: 10, max_retries: 3\n- Add R2 bucket: DATA_BUCKET → kosarica-data\n- Configure cron triggers","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:47:16.607282+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.973679+01:00","closed_at":"2025-12-30T15:36:31.7439163Z","dependencies":[{"issue_id":"main-4mn.32","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:47:16.609488+01:00","created_by":"daemon"},{"issue_id":"main-4mn.32","depends_on_id":"main-4mn.31","type":"blocks","created_at":"2025-12-29T19:48:18.048271+01:00","created_by":"daemon"}]}
{"id":"main-4mn.33","title":"Test ZIP fanout with Queue","description":"Test Cloudflare Queue fanout:\n- ZIP with multiple entries\n- Verify entries enqueued as parse_entry messages\n- Verify parallel processing\n- Check backpressure and retry behavior","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:47:17.826935+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.974288+01:00","closed_at":"2025-12-30T15:36:31.748570839Z","dependencies":[{"issue_id":"main-4mn.33","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:47:17.829296+01:00","created_by":"daemon"},{"issue_id":"main-4mn.33","depends_on_id":"main-4mn.31","type":"blocks","created_at":"2025-12-29T19:48:18.082775+01:00","created_by":"daemon"}]}
{"id":"main-4mn.34","title":"Add npm dependencies for ingestion","description":"Update package.json with new dependencies:\n- fast-xml-parser (XML parsing)\n- xlsx (XLSX parsing)\n- adm-zip (ZIP extraction)\n- iconv-lite (encoding conversion)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T19:47:26.014527+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.974877+01:00","closed_at":"2025-12-30T11:15:38.020455527Z","dependencies":[{"issue_id":"main-4mn.34","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:47:26.017634+01:00","created_by":"daemon"}]}
{"id":"main-4mn.4","title":"Create storage abstraction","description":"Create src/ingestion/core/storage.ts:\n- Abstraction over local FS and Cloudflare R2\n- Store/retrieve files by key\n- Compute SHA256 for dedup","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:29.826339+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.975466+01:00","closed_at":"2025-12-30T13:32:06.465553487Z","dependencies":[{"issue_id":"main-4mn.4","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:29.829083+01:00","created_by":"daemon"},{"issue_id":"main-4mn.4","depends_on_id":"main-4mn.1","type":"blocks","created_at":"2025-12-29T19:47:50.126383+01:00","created_by":"daemon"}]}
{"id":"main-4mn.5","title":"Create normalization utilities","description":"Create src/ingestion/core/normalize.ts:\n- Decimal styles: 3,69 → 3.69, ,69 → 0.69\n- Quantity formats: '315 G' → {value: 315, unit: 'G'}\n- Pack notation: '6x500ml' → {pack_count: 6, pack_unit_value: 500, pack_unit_unit: 'ML'}\n- Barcode cleanup: remove spaces, quotes, Excel quoting","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:31.003811+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.976058+01:00","closed_at":"2025-12-30T13:36:42.944104901Z","dependencies":[{"issue_id":"main-4mn.5","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:31.006331+01:00","created_by":"daemon"},{"issue_id":"main-4mn.5","depends_on_id":"main-4mn.1","type":"blocks","created_at":"2025-12-29T19:47:50.165985+01:00","created_by":"daemon"}]}
{"id":"main-4mn.6","title":"Create persist module with signature dedup","description":"Create src/ingestion/core/persist.ts:\n- Upsert stores, retailer_items, retailer_item_barcodes\n- Compute price_signature hash\n- If signature unchanged: update last_seen_ts only\n- If signature changed: close old period, open new period\n- Insert to store_item_price_periods only on change","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:32.544076+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.976638+01:00","closed_at":"2025-12-30T13:44:07.709663089Z","dependencies":[{"issue_id":"main-4mn.6","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:32.547218+01:00","created_by":"daemon"},{"issue_id":"main-4mn.6","depends_on_id":"main-4mn.1","type":"blocks","created_at":"2025-12-29T19:47:50.201372+01:00","created_by":"daemon"},{"issue_id":"main-4mn.6","depends_on_id":"main-4mn.3","type":"blocks","created_at":"2025-12-29T19:47:51.708077+01:00","created_by":"daemon"}]}
{"id":"main-4mn.7","title":"Create base parser interface","description":"Create src/ingestion/parsers/base.ts:\n- Abstract Parser class/interface\n- parse(content: Buffer, options: ParseOptions) → NormalizedRow[]\n- Common error handling","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:56.55452+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.977168+01:00","closed_at":"2025-12-30T13:48:18.9336486Z","dependencies":[{"issue_id":"main-4mn.7","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:56.557012+01:00","created_by":"daemon"},{"issue_id":"main-4mn.7","depends_on_id":"main-4mn.3","type":"blocks","created_at":"2025-12-29T19:48:01.184795+01:00","created_by":"daemon"}]}
{"id":"main-4mn.8","title":"Create CSV parser","description":"Create src/ingestion/parsers/csv.ts:\n- Configurable delimiter (comma, semicolon, tab)\n- Handle different encodings (utf-8, windows-1250)\n- Return NormalizedRow[]","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:58.042047+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.977659+01:00","closed_at":"2025-12-30T14:03:35.954062838Z","dependencies":[{"issue_id":"main-4mn.8","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:58.044236+01:00","created_by":"daemon"},{"issue_id":"main-4mn.8","depends_on_id":"main-4mn.7","type":"blocks","created_at":"2025-12-29T19:48:01.225085+01:00","created_by":"daemon"}]}
{"id":"main-4mn.9","title":"Create XML parser","description":"Create src/ingestion/parsers/xml.ts:\n- Use fast-xml-parser\n- Handle Studenac/Trgocentar XML formats\n- Extract store blocks from XML content","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T19:44:58.983067+01:00","created_by":"damir","updated_at":"2026-01-02T10:10:09.978133+01:00","closed_at":"2025-12-30T14:10:10.211549429Z","dependencies":[{"issue_id":"main-4mn.9","depends_on_id":"main-4mn","type":"parent-child","created_at":"2025-12-29T19:44:58.985332+01:00","created_by":"daemon"},{"issue_id":"main-4mn.9","depends_on_id":"main-4mn.7","type":"blocks","created_at":"2025-12-29T19:48:01.262345+01:00","created_by":"daemon"}]}
{"id":"main-4we","title":"Wrap persistRows in database transaction for atomicity","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T16:02:58.591061325Z","created_by":"kasm-user","updated_at":"2026-01-01T16:45:26.757355793Z","closed_at":"2026-01-01T16:45:26.757355793Z","close_reason":"Cannot implement: Cloudflare D1 does not support multi-statement transactions. Wrapping persistRows in a transaction would only work for BetterSQLite3 (CLI) but not for D1 (production), creating an environment inconsistency."}
{"id":"main-5fm","title":"Another Test [feature, P1]","description":"Description with priority and type","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-29T19:42:59.659742+01:00","updated_at":"2025-12-29T19:43:07.652074+01:00","deleted_at":"2025-12-29T19:43:07.652074+01:00","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"main-6ta","title":"Update Kaufland adapter for price transparency fields","description":"Map: cijena jed.mj.(EUR), Najniža MPC u 30dana, Sidrena cijena. Also map unitPriceBaseQuantity from kol.jed.mj. and unitPriceBaseUnit from jed.mj. (1 KOM/L/KG). Source: https://www.kaufland.hr/akcije-novosti/popis-mpc.html","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:13.649972+01:00","created_by":"damir","updated_at":"2026-01-07T19:48:10.20510347Z","closed_at":"2026-01-07T19:48:10.20510347Z","close_reason":"All adapters tested and working with price transparency fields","dependencies":[{"issue_id":"main-6ta","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:35.674319+01:00","created_by":"damir"},{"issue_id":"main-6ta","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.325156+01:00","created_by":"damir"}]}
{"id":"main-7ie","title":"Update Interspar adapter for price transparency fields","description":"Map: cijena za jedinicu mjere (EUR), Najniža cijena u posljednjih 30 dana (EUR), sidrena cijena na 2.5.2025. (EUR). Set anchorPriceAsOf=2025-05-02. Source: https://www.spar.hr/usluge/cjenici","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:58.214057+01:00","created_by":"damir","updated_at":"2026-01-07T19:48:10.203760173Z","closed_at":"2026-01-07T19:48:10.203760173Z","close_reason":"All adapters tested and working with price transparency fields","dependencies":[{"issue_id":"main-7ie","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:35.522916+01:00","created_by":"damir"},{"issue_id":"main-7ie","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.175998+01:00","created_by":"damir"}]}
{"id":"main-951","title":"explore removeing BetterSQLite3 and using vitest/wrangler settup for testing, not node https://developers.cloudflare.com/workers/development-testing/ https://developers.cloudflare.com/workers/vite-plugin/","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T16:31:36.87966588Z","updated_at":"2026-01-06T14:03:03.721412+01:00","closed_at":"2026-01-06T14:03:03.721412+01:00","close_reason":"Implemented in commit a5b684a - removed BetterSQLite3, migrated to Cloudflare vitest-pool-workers testing"}
{"id":"main-c46","title":"Verify Metro data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.430028489Z","created_by":"kasm-user","updated_at":"2026-01-09T08:09:57.346828705Z","closed_at":"2026-01-09T08:09:57.346828705Z","close_reason":"Verified: Metro (13,092 rows, 0 errors), Studenac (2 rows, 0 errors)"}
{"id":"main-c8x","title":"Update DM adapter for price transparency fields","description":"Map XLSX headers: Cijena za jedinicu mjere, Najniža cijena u posljednjih 30 dana prije rasprodaje, sidrena cijena na 2.5.2025. ili na datum ulistanja. Set anchorPriceAsOf=null due to ambiguous basis. Source: https://www.dm.hr/novo/promocije/nove-oznake-cijena-i-vazeci-cjenik-u-dm-u-2906632","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:21.355188+01:00","created_by":"damir","updated_at":"2026-01-07T19:48:10.209244568Z","closed_at":"2026-01-07T19:48:10.209244568Z","close_reason":"All adapters tested and working with price transparency fields","dependencies":[{"issue_id":"main-c8x","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:37.931888+01:00","created_by":"damir"},{"issue_id":"main-c8x","depends_on_id":"main-2u8","type":"blocks","created_at":"2026-01-06T14:05:01.589393+01:00","created_by":"damir"}]}
{"id":"main-ceq","title":"Fix unsafe non-null assertion on config.csv in chain adapters","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-01T16:02:35.278840052Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.460524921Z","closed_at":"2026-01-01T16:32:16.460524921Z","close_reason":"Implementation completed by subagents"}
{"id":"main-dy8","title":"CLI: Store management commands","description":"## Goal\nCLI commands to list, approve, reject pending stores.\n\n## New File\n**File**: `src/ingestion/cli/stores.ts`\n\n## Commands\n\n### List pending stores\n```bash\npnpm ingest stores --pending\n```\nOutput table:\n| ID | Chain | Name | Identifiers | Created |\n|----|-------|------|-------------|---------|\n\n### List all stores for chain\n```bash\npnpm ingest stores --chain=dm\n```\nOutput table:\n| ID | Name | Virtual | Status | Price Source | City |\n|----|------|---------|--------|--------------|------|\n\n### Approve store\n```bash\npnpm ingest stores --approve \u003cstore_id\u003e\n```\n- Sets status='active'\n- Outputs: \"Approved store: {name}\"\n\n### Reject/delete store\n```bash\npnpm ingest stores --reject \u003cstore_id\u003e\n```\n- Deletes store, store_identifiers, and any storeItemState records\n- Outputs: \"Rejected and deleted store: {name}\"\n\n### Show store details\n```bash\npnpm ingest stores --show \u003cstore_id\u003e\n```\n- Shows all store fields + identifiers + price count\n\n## Register Command\n**File**: `src/ingestion/cli/index.ts`\n\nAdd stores subcommand to CLI.\n\n## Implementation Notes\n- Use drizzle queries\n- Use console.table or similar for formatted output\n- Handle errors gracefully (store not found, etc.)\n\n## Verification\n1. Create pending store via ingestion\n2. `pnpm ingest stores --pending` → shows it\n3. `pnpm ingest stores --approve \u003cid\u003e` → status changes\n4. `pnpm ingest stores --chain=dm` → shows all DM stores","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-09T13:51:25.409990684Z","created_by":"kasm-user","updated_at":"2026-01-09T13:51:25.409990684Z","dependencies":[{"issue_id":"main-dy8","depends_on_id":"main-qsn","type":"blocks","created_at":"2026-01-09T13:52:05.119706152Z","created_by":"kasm-user"}]}
{"id":"main-e72","title":"Update Metro adapter for price transparency fields","description":"Map: CIJENA_PO_MJERI, NAJNIZA_30_DANA, SIDRENA_02_05. Note: current adapter is XML-only but sample is CSV - needs alignment. Set anchorPriceAsOf=2025-05-02. Source: https://metrocjenik.com.hr/","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:17.7726+01:00","created_by":"damir","updated_at":"2026-01-07T19:48:10.207112394Z","closed_at":"2026-01-07T19:48:10.207112394Z","close_reason":"All adapters tested and working with price transparency fields","dependencies":[{"issue_id":"main-e72","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:37.692227+01:00","created_by":"damir"},{"issue_id":"main-e72","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.46656+01:00","created_by":"damir"}]}
{"id":"main-edl","title":"Query: Price resolution follows priceSourceStoreId","description":"## Goal\nWhen querying prices for a physical store, follow priceSourceStoreId to get prices from virtual store.\n\n## New File\n**File**: `src/db/queries/stores.ts` (or add to existing queries file)\n\n## Helper Functions\n\n### Get effective price store ID\n```typescript\n/**\n * Returns the store ID to use for price lookups.\n * Physical stores return their priceSourceStoreId.\n * Virtual stores return their own ID.\n */\nexport function getEffectivePriceStoreId(store: { \n  id: string; \n  priceSourceStoreId: string | null \n}): string {\n  return store.priceSourceStoreId ?? store.id\n}\n```\n\n### Get store with resolved price source\n```typescript\n/**\n * Fetches store and its price source store (if different).\n */\nexport async function getStoreWithPriceSource(\n  db: AnyDatabase,\n  storeId: string\n): Promise\u003c{\n  store: Store;\n  priceStore: Store;\n  usesSharedPricing: boolean;\n} | null\u003e {\n  const store = await db.query.stores.findFirst({\n    where: eq(stores.id, storeId)\n  })\n  if (\\!store) return null\n\n  if (store.priceSourceStoreId) {\n    const priceStore = await db.query.stores.findFirst({\n      where: eq(stores.id, store.priceSourceStoreId)\n    })\n    return { \n      store, \n      priceStore: priceStore\\!, \n      usesSharedPricing: true \n    }\n  }\n\n  return { store, priceStore: store, usesSharedPricing: false }\n}\n```\n\n### Get prices for store (convenience)\n```typescript\n/**\n * Gets prices for a store, following priceSourceStoreId if set.\n */\nexport async function getPricesForStore(\n  db: AnyDatabase,\n  storeId: string,\n  options?: { limit?: number; retailerItemId?: string }\n): Promise\u003cStoreItemState[]\u003e {\n  const resolved = await getStoreWithPriceSource(db, storeId)\n  if (\\!resolved) return []\n\n  return db.query.storeItemState.findMany({\n    where: and(\n      eq(storeItemState.storeId, resolved.priceStore.id),\n      options?.retailerItemId \n        ? eq(storeItemState.retailerItemId, options.retailerItemId) \n        : undefined\n    ),\n    limit: options?.limit\n  })\n}\n```\n\n## Usage Pattern\nWhen building price API:\n```typescript\n// DON'T query directly with user's storeId\nconst prices = await db.query.storeItemState.findMany({\n  where: eq(storeItemState.storeId, requestedStoreId) // WRONG for physical stores\n})\n\n// DO use the helper\nconst prices = await getPricesForStore(db, requestedStoreId)\n```\n\n## Export\nAdd exports to `src/db/index.ts` or appropriate barrel file.\n\n## Verification\n1. Create virtual store with prices\n2. Create physical store linked to virtual\n3. Call `getPricesForStore(db, physicalStoreId)`\n4. Verify returns virtual store's prices","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-09T13:51:55.881949682Z","created_by":"kasm-user","updated_at":"2026-01-09T13:51:55.881949682Z","dependencies":[{"issue_id":"main-edl","depends_on_id":"main-qsn","type":"blocks","created_at":"2026-01-09T13:52:05.213817839Z","created_by":"kasm-user"}]}
{"id":"main-fgy","title":"Croatian Price Transparency Fields Import","description":"Persist Croatian price-transparency fields that retailers publish: unit price, lowest price in last 30 days, and anchor (sidrena) price. New fields: unitPriceCents, unitPriceBaseQuantity, unitPriceBaseUnit, lowestPrice30dCents, anchorPriceCents, anchorPriceAsOf. Covers all 11 retail chains.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-06T14:03:09.235155+01:00","created_by":"damir","updated_at":"2026-01-07T09:13:06.40179714Z","closed_at":"2026-01-07T09:13:07.40179714Z"}
{"id":"main-fmf","title":"Update Studenac adapter for price transparency fields","description":"Map XML tags: \u003cCijenaZaJedinicuMjere\u003e, \u003cNajnizaCijena\u003e, \u003cSidrenaCijena\u003e. Source: https://www.studenac.hr/popis-maloprodajnih-cijena","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:19.042893+01:00","created_by":"damir","updated_at":"2026-01-07T19:48:10.207895688Z","closed_at":"2026-01-07T19:48:10.207895688Z","close_reason":"All adapters tested and working with price transparency fields","dependencies":[{"issue_id":"main-fmf","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:37.771851+01:00","created_by":"damir"},{"issue_id":"main-fmf","depends_on_id":"main-19a","type":"blocks","created_at":"2026-01-06T14:05:02.784197+01:00","created_by":"damir"}]}
{"id":"main-fyt","title":"Centralize adapter registration to avoid duplicate code","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T16:02:47.471991465Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.470762624Z","closed_at":"2026-01-01T16:32:16.470762624Z","close_reason":"Implementation completed by subagents"}
{"id":"main-g53","title":"Optimize persistRows with batch insert operations","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T16:03:00.623470061Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.471858382Z","closed_at":"2026-01-01T16:32:16.471858382Z","close_reason":"Implementation completed by subagents"}
{"id":"main-gu4","title":"Another Test","description":"type: feature","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-29T19:43:07.743867+01:00","updated_at":"2025-12-29T19:43:17.625779+01:00","deleted_at":"2025-12-29T19:43:17.625779+01:00","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"main-jfh","title":"Verify Interspar data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.270542535Z","created_by":"kasm-user","updated_at":"2026-01-09T07:20:04.694606899Z","closed_at":"2026-01-09T07:20:04.694606899Z","close_reason":"Closed"}
{"id":"main-jut","title":"Verify Trgocentar data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.53332547Z","created_by":"kasm-user","updated_at":"2026-01-09T08:21:58.931710544Z","closed_at":"2026-01-09T08:21:58.931710544Z","close_reason":"Verified: Trgocentar (3 rows, 0 errors after XML→CSV fix), DM (2 rows, 0 errors)"}
{"id":"main-ki7","title":"Update CSV parser for price transparency fields","description":"Extend src/ingestion/parsers/csv.ts CsvColumnMapping + mapping logic to support unitPrice, lowestPrice30d, anchorPrice fields. Reuse parsePrice() for conversion to cents.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:34.724982+01:00","created_by":"damir","updated_at":"2026-01-07T18:36:30.478055014Z","closed_at":"2026-01-07T18:36:30.478055014Z","close_reason":"All price transparency fields implemented in parsers and persist module","dependencies":[{"issue_id":"main-ki7","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.295986+01:00","created_by":"damir"},{"issue_id":"main-ki7","depends_on_id":"main-28t","type":"blocks","created_at":"2026-01-06T14:04:50.028744+01:00","created_by":"damir"}]}
{"id":"main-mej","title":"Update Lidl adapter for price transparency fields","description":"Map: CIJENA_ZA_JEDINICU_MJERE, NAJNIZA_CIJENA_U_POSLJ._30_DANA, Sidrena_cijena_na_02.05.2025. Set anchorPriceAsOf=2025-05-02.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:55.241546+01:00","created_by":"damir","updated_at":"2026-01-06T14:31:05.138259+01:00","closed_at":"2026-01-06T14:31:05.138259+01:00","close_reason":"Already implemented in 2026 format update","dependencies":[{"issue_id":"main-mej","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:35.364934+01:00","created_by":"damir"},{"issue_id":"main-mej","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.029571+01:00","created_by":"damir"}]}
{"id":"main-mte","title":"Implement discover() methods for all chain adapters","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-01T16:02:36.857680433Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.46453366Z","closed_at":"2026-01-01T16:32:16.46453366Z","close_reason":"Implementation completed by subagents"}
{"id":"main-n3p","title":"Update Trgocentar adapter for price transparency fields","description":"Map XML tags: \u003cc_jmj\u003e, \u003cc_najniza_30\u003e, \u003cc_020525\u003e. Note: current adapter is CSV-only - needs alignment. Set anchorPriceAsOf=2025-05-02. Source: https://trgocentar.com/Trgovine-cjenik/","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:20.164649+01:00","created_by":"damir","updated_at":"2026-01-07T19:48:10.208603982Z","closed_at":"2026-01-07T19:48:10.208603982Z","close_reason":"All adapters tested and working with price transparency fields","dependencies":[{"issue_id":"main-n3p","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:37.852264+01:00","created_by":"damir"},{"issue_id":"main-n3p","depends_on_id":"main-19a","type":"blocks","created_at":"2026-01-06T14:05:02.864775+01:00","created_by":"damir"}]}
{"id":"main-n4p","title":"Update Konzum adapter for price transparency fields","description":"Map: CIJENA ZA JEDINICU MJERE, NAJNIŽA CIJENA U POSLJEDNIH 30 DANA, SIDRENA CIJENA NA 2.5.2025. Set anchorPriceAsOf=2025-05-02.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:54.261649+01:00","created_by":"damir","updated_at":"2026-01-06T14:31:05.13616+01:00","closed_at":"2026-01-06T14:31:05.13616+01:00","close_reason":"Already implemented in 2026 format update","dependencies":[{"issue_id":"main-n4p","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:35.278339+01:00","created_by":"damir"},{"issue_id":"main-n4p","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:04:59.953467+01:00","created_by":"damir"}]}
{"id":"main-ppu","title":"Test Issue Title","description":"Description here","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-29T19:42:50.188537+01:00","updated_at":"2025-12-29T19:43:07.650859+01:00","deleted_at":"2025-12-29T19:43:07.650859+01:00","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"main-qsn","title":"Schema: Add virtual store columns to stores table","description":"## Goal\nAdd columns to stores table to support virtual/physical store separation.\n\n## Schema Changes\n**File**: `src/db/schema.ts` - stores table\n\nAdd these columns:\n```typescript\nisVirtual: integer('is_virtual', { mode: 'boolean' }).default(true),\npriceSourceStoreId: text('price_source_store_id').references(() =\u003e stores.id),\nstatus: text('status').default('active'), // 'active' | 'pending'\n```\n\n## Migration SQL\n```sql\nALTER TABLE stores ADD COLUMN is_virtual INTEGER DEFAULT 1;\nALTER TABLE stores ADD COLUMN price_source_store_id TEXT REFERENCES stores(id);\nALTER TABLE stores ADD COLUMN status TEXT DEFAULT 'active';\n\n-- Indexes\nCREATE INDEX stores_status_idx ON stores(status);\nCREATE INDEX stores_price_source_idx ON stores(price_source_store_id);\n```\n\n## Column Definitions\n- `is_virtual`: true=import-linked store (holds prices), false=physical location\n- `price_source_store_id`: FK to another store for price inheritance\n- `status`: 'active' (normal) or 'pending' (awaiting approval)\n\n## Default Behavior\n- All existing stores get is_virtual=1 (they came from imports)\n- All existing stores get status='active' (grandfathered)\n\n## Verification\n1. Run `pnpm db:generate` to create migration\n2. Run `pnpm db:migrate` to apply\n3. Query: `SELECT is_virtual, status FROM stores LIMIT 5` → all should be 1, 'active'","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-09T13:50:56.92132449Z","created_by":"kasm-user","updated_at":"2026-01-09T13:50:56.92132449Z"}
{"id":"main-r9p","title":"Update persist module for price transparency fields","description":"Update src/ingestion/core/persist.ts upserts for store_item_state to write new columns. Keep computePriceSignature() unchanged - don't include lowestPrice30d to avoid period churn.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:53.088711+01:00","created_by":"damir","updated_at":"2026-01-07T18:36:30.482123118Z","closed_at":"2026-01-07T18:36:30.482123118Z","close_reason":"All price transparency fields implemented in parsers and persist module","dependencies":[{"issue_id":"main-r9p","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.532761+01:00","created_by":"damir"},{"issue_id":"main-r9p","depends_on_id":"main-28t","type":"blocks","created_at":"2026-01-06T14:04:51.384936+01:00","created_by":"damir"}]}
{"id":"main-rqe","title":"Verify DM data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.587432942Z","created_by":"kasm-user","updated_at":"2026-01-09T08:21:58.933690923Z","closed_at":"2026-01-09T08:21:58.933690923Z","close_reason":"Verified: Trgocentar (3 rows, 0 errors after XML→CSV fix), DM (2 rows, 0 errors)"}
{"id":"main-s1l","title":"Fix hardcoded absolute paths in chain adapter tests","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-01T16:02:48.414633302Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.467067679Z","closed_at":"2026-01-01T16:32:16.467067679Z","close_reason":"Implementation completed by subagents"}
{"id":"main-wnh","title":"Update Plodine adapter for price transparency fields","description":"Map: Cijena po JM, Najniza cijena u poslj. 30 dana, Sidrena cijena na 2.5.2025. Set anchorPriceAsOf=2025-05-02. Source: https://www.plodine.hr/info-o-cijenama","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:03:56.927946+01:00","created_by":"damir","updated_at":"2026-01-07T19:48:10.201715708Z","closed_at":"2026-01-07T19:48:10.201715708Z","close_reason":"All adapters tested and working with price transparency fields","dependencies":[{"issue_id":"main-wnh","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:35.444186+01:00","created_by":"damir"},{"issue_id":"main-wnh","depends_on_id":"main-ki7","type":"blocks","created_at":"2026-01-06T14:05:00.106606+01:00","created_by":"damir"}]}
{"id":"main-yqi","title":"Verify Plodine data import","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T06:48:53.213550726Z","created_by":"kasm-user","updated_at":"2026-01-09T07:20:04.692416717Z","closed_at":"2026-01-09T07:20:04.692416717Z","close_reason":"Closed"}
{"id":"main-z1s","title":"Refactor chain adapters: Extract common base class to reduce duplication","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T16:02:34.140515731Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.465835961Z","closed_at":"2026-01-01T16:32:16.465835961Z","close_reason":"Implementation completed by subagents"}
{"id":"main-zrq","title":"Generate Drizzle migration for price transparency columns","description":"Run drizzle-kit generate to create migration for new price transparency columns in store_item_state (and optionally store_item_price_periods).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T14:03:32.306583+01:00","created_by":"damir","updated_at":"2026-01-07T17:00:40.006722921Z","closed_at":"2026-01-07T17:00:40.006722921Z","close_reason":"Created migration 0006_rename_price_columns.sql to rename columns: unit_price_cents→unit_price, lowest_price_30d_cents→lowest_price_30d, anchor_price_cents→anchor_price","dependencies":[{"issue_id":"main-zrq","depends_on_id":"main-fgy","type":"blocks","created_at":"2026-01-06T14:04:33.134404+01:00","created_by":"damir"},{"issue_id":"main-zrq","depends_on_id":"main-4cn","type":"blocks","created_at":"2026-01-06T14:04:46.270452+01:00","created_by":"damir"}]}
{"id":"main-zu4","title":"Fix D1 SQL variable limit in persist batch","description":"## Problem\n`persistRowChunkBatched` in `src/ingestion/core/persist.ts` accumulates all write queries for a chunk into a single `db.batch()` call. When the total SQL bind parameters exceed D1's 999 variable limit, the batch fails with:\n\n```\nD1_ERROR: too many SQL variables at offset 696: SQLITE_ERROR\n```\n\n## Current Behavior\n- DEFAULT_BATCH_SIZE = 50 rows per chunk\n- Each row generates variable number of queries depending on:\n  - Insert vs update (inserts have more params)\n  - Number of barcodes\n  - Price change status (changed prices need 3 queries)\n- All queries batched into single `db.batch()` call\n\n## Solution Options\n1. **Dynamic splitting**: Count bind parameters as queries are added to writeQueries, split into sub-batches when approaching 999 limit\n2. **Configurable batch size**: Add batchSize parameter to persist functions, let caller tune based on their data characteristics\n3. **Hybrid**: Default dynamic splitting with optional override\n\n## Files\n- `src/ingestion/core/persist.ts:1193` - `persistRowChunkBatched` function\n- Line 1577 - `db.batch(writeQueries)` call that fails","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-09T05:26:01.177722657Z","created_by":"kasm-user","updated_at":"2026-01-09T07:04:36.474758349Z","closed_at":"2026-01-09T07:04:36.474758349Z","close_reason":"Fixed by using dynamic batch sizes based on column counts. storeItemState now uses 4 rows per batch (72 params) instead of 8 (144 params)."}
{"id":"main-zw6","title":"Add rate limiting and exponential backoff to chain adapter fetch methods","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T16:02:59.660865529Z","created_by":"kasm-user","updated_at":"2026-01-01T16:32:16.469664865Z","closed_at":"2026-01-01T16:32:16.469664865Z","close_reason":"Implementation completed by subagents"}
